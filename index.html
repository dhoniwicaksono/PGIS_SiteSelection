<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebGIS Prototype — Collect Points & Export CSV</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
      html, body { height:100%; margin:0; padding:0; }
      #map { height:100%; }
      body { font-family: Arial, Helvetica, sans-serif; }

      /* Left sidebar */
      #sidebar {
        position: absolute; top:8px; left:8px; z-index:1000;
        background: rgba(255,255,255,0.98); padding:10px; border-radius:6px;
        box-shadow: 0 1px 6px rgba(0,0,0,0.25);
        width:320px; max-height:90vh; overflow:auto;
      }

      /* Right sidebar */
      #sidebarRight {
        position: absolute; top:8px; right:8px; z-index:1000;
        background: rgba(255,255,255,0.98); padding:10px; border-radius:6px;
        box-shadow: 0 1px 6px rgba(0,0,0,0.25);
        width:320px; max-height:90vh; overflow:auto;
      }

      @media (max-width:700px) {
        #sidebar, #sidebarRight {
          position: fixed; left:0; right:0; bottom:0; top:auto;
          width:100%; max-height:45vh; border-radius:12px 12px 0 0; padding:10px 12px;
        }
      }

      .btn { display:inline-block; padding:8px 12px; margin:6px 4px; border-radius:6px; border:1px solid #2c7be5; background:#2c7be5; color:#fff; cursor:pointer; font-size:14px; }
      .btn.secondary { background:#fff; color:#2c7be5; }
      .btn.tertiary { background:#f5f5f5; color:#333; border:1px solid #ddd; }
      .smallBtn { padding:4px 6px; font-size:12px; }

      label { display:block; margin-top:8px; font-weight:600; }
      input[type="text"], select, textarea { width:100%; padding:8px; box-sizing:border-box; margin-top:6px; border:1px solid #ccc; border-radius:4px; }
      textarea { resize:vertical; }

      table { width:100%; border-collapse:collapse; margin-top:8px; }
      table th, table td { border:1px solid #ddd; padding:6px; font-size:13px; }
      .small { font-size:13px; color:#555; }

      @media (max-width:700px) {
        table th:nth-child(5), table td:nth-child(5), table th:nth-child(6), table td:nth-child(6) { display:none; }
        .btn { font-size:13px; padding:8px 10px; }
      }

      .leaflet-control-layers { z-index:1200; }

      /* admin label style and buffer variants */
      .admin-label { background: rgba(255,255,255,0.85); padding: 2px 4px; border-radius:4px; font-size:11px; color:#111; }
      .admin-label-prov { text-shadow: 0 0 8px #fff, 0 0 8px #fff; font-weight:700; }
      .admin-label-kab  { text-shadow: 0 0 6px #fff, 0 0 6px #fff; }
      .admin-label-kec  { text-shadow: 0 0 4px #fff, 0 0 4px #fff; }
      .admin-label-desa { text-shadow: 0 0 2px #fff, 0 0 2px #fff; }

      /* suggestion box */
      #admin_suggestions div:hover { background:#f5f8ff; }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <div id="sidebar">
      <h3 style="margin:6px 0">Collector — Preference Mapping (MaxEnt)</h3>
      <div class="small">Klik peta untuk menambahkan titik. Isi atribut di form, lalu tekan <b>Save Point</b>. Minimal <b>10 titik</b> per responden direkomendasikan.</div>

      <label>Respondent ID</label>
      <input type="text" id="respondent_id" placeholder="e.g. R01" />

      <label>Stakeholder Group</label>
      <select id="stakeholder_group">
        <option value="Pemerintah_Desa">Pemerintah Desa</option>
        <option value="Pelaku_Usaha">Pelaku Usaha</option>
        <option value="Dinas_Terkait">Dinas Terkait</option>
        <option value="Lainnya">Lainnya</option>
      </select>

      <label>Mapping Object</label>
      <input type="text" id="mapping_object" placeholder="contoh: Pendidikan" />

      <label>Point ID (optional)</label>
      <input type="text" id="point_id" placeholder="auto: R01_P1" />

      <label>Reason (optional)</label>
      <textarea id="reason" rows="2" placeholder="Contoh: dekat jalan kolektor dan pasar"></textarea>

      <label>Map Source</label>
      <select id="map_source">
        <option value="webGIS">webGIS</option>
        <option value="peta_cetak">peta_cetak</option>
        <option value="gps">gps</option>
      </select>

      <label>Accuracy (m) — optional</label>
      <input type="text" id="accuracy_m" placeholder="e.g. 10" />

      <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap; justify-content:center; align-items:center;">
        <button id="savePointBtn" class="btn">Save Point</button>
        <button id="clearFormBtn" class="btn secondary">Clear Form</button>
        <button id="centerBtn" class="btn tertiary">Center Map</button>
      </div>

      <hr />

      <div class="small"><b>Points collected for current respondent:</b></div>
      <div id="pointsCount">0 points</div>

      <table id="pointsTable" style="display:none">
        <thead>
          <tr>
            <th>#</th>
            <th>ID</th>
            <th>Mapping Object</th>
            <th>Lat</th>
            <th>Lon</th>
            <th>Reason</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap">
        <button id="exportCsv" class="btn">Export CSV</button>
        <button id="exportGeojson" class="btn">Export GeoJSON</button>
        <button id="clearAll" class="btn secondary">Clear All Points</button>
      </div>

      <hr />
      <div class="small">Instruksi singkat: 1) Isi Respondent ID. 2) Klik lokasi pada peta. 3) Edit atribut jika perlu. 4) Tekan "Save Point". 5) Setelah selesai, tekan Export CSV.</div>
    </div>

    <div id="sidebarRight">
      <h3 style="margin:6px 0">Tools</h3>
      <div class="small">Tool cepat untuk pengguna.</div>

      <div style="margin-top:10px; display:flex; flex-direction:column; gap:12px; align-items:center;">
        <button id="getLocationBtn" class="btn" style="width:80%; text-align:center">Get my location</button>
        <div style="display:flex; gap:8px; justify-content:center; width:100%;">
          <button id="zoomInBtn" class="btn tertiary" style="width:40%; text-align:center">Zoom In</button>
          <button id="zoomOutBtn" class="btn tertiary" style="width:40%; text-align:center">Zoom Out</button>
        </div>
      </div>

      <hr />
      <div class="small">Gunakan <b>Get my location</b> untuk memusatkan peta pada posisi perangkat Anda dan menandainya.</div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      // --- Map init ---
      var osm = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '© OpenStreetMap contributors' });
      var map = L.map('map', { center:[-7.8, 110.37], zoom:12, layers:[osm] });
      L.control.scale().addTo(map);
      var baseMaps = { 'OSM Standard': osm };
      L.control.layers(baseMaps, null, { collapsed:false }).addTo(map);

      // --- State ---
      var allPoints = [];
      var tempMarker = null;

      // --- DOM ---
      var respondentIdEl = document.getElementById('respondent_id');
      var stakeholderEl = document.getElementById('stakeholder_group');
      var mappingObjectEl = document.getElementById('mapping_object');
      var pointIdEl = document.getElementById('point_id');
      var reasonEl = document.getElementById('reason');
      var mapSourceEl = document.getElementById('map_source');
      var accuracyEl = document.getElementById('accuracy_m');
      var saveBtn = document.getElementById('savePointBtn');
      var clearFormBtn = document.getElementById('clearFormBtn');
      var pointsCountEl = document.getElementById('pointsCount');
      var pointsTable = document.getElementById('pointsTable');
      var pointsTableBody = pointsTable.querySelector('tbody');
      var exportCsvBtn = document.getElementById('exportCsv');
      var exportGeoBtn = document.getElementById('exportGeojson');
      var clearAllBtn = document.getElementById('clearAll');
      var centerBtn = document.getElementById('centerBtn');
      var getLocationBtn = document.getElementById('getLocationBtn');
      var zoomInBtn = document.getElementById('zoomInBtn');
      var zoomOutBtn = document.getElementById('zoomOutBtn');

      function currentRespondentId() { return respondentIdEl.value ? respondentIdEl.value.trim() : ''; }
      function pointsForRespondent(rid) { return allPoints.filter(function(p){ return p.respondent_id === rid; }); }

      function updatePointsUI() {
        var rid = currentRespondentId();
        var pts = rid ? pointsForRespondent(rid) : [];
        pointsCountEl.textContent = (pts.length) + ' points';
        if (!pts || pts.length === 0) {
          pointsTable.style.display = 'none';
          pointsTableBody.innerHTML = '';
          return;
        }
        pointsTable.style.display = 'table';
        pointsTableBody.innerHTML = '';
        pts.forEach(function(p, i){
          var tr = document.createElement('tr');
          tr.innerHTML = '<td>' + (i+1) + '</td>' +
                         '<td>' + p.point_id + '</td>' +
                         '<td>' + (p.mapping_object ? p.mapping_object : '') + '</td>' +
                         '<td>' + p.latitude.toFixed(6) + '</td>' +
                         '<td>' + p.longitude.toFixed(6) + '</td>' +
                         '<td>' + (p.reason ? p.reason.substring(0,20) : '') + '</td>' +
                         '<td><button data-pid="' + p.point_id + '" class="btn secondary smallBtn">Del</button></td>';
          pointsTableBody.appendChild(tr);
        });
        // attach delete handlers
        pointsTableBody.querySelectorAll('.smallBtn').forEach(function(btn){
          btn.addEventListener('click', function(){
            var pid = this.getAttribute('data-pid');
            var rid = currentRespondentId();
            var idx = allPoints.findIndex(function(x){ return x.point_id === pid && x.respondent_id === rid; });
            if (idx >= 0) {
              if (allPoints[idx].marker) map.removeLayer(allPoints[idx].marker);
              allPoints.splice(idx,1);
              updatePointsUI();
            }
          });
        });
      }

      function resetFormFields() {
        if (pointIdEl) { pointIdEl.value = ''; pointIdEl.removeAttribute('data-lat'); pointIdEl.removeAttribute('data-lon'); }
        if (reasonEl) reasonEl.value = '';
        if (mapSourceEl) mapSourceEl.value = 'webGIS';
        if (accuracyEl) accuracyEl.value = '';
      }

      // helper: compute next index for a base mapping object for a respondent
      function getNextMappingIndex(base, rid) {
        if (!base) return 1;
        var prefix = base + '_';
        var maxIndex = 0;
        allPoints.forEach(function(p){
          if (rid && p.respondent_id !== rid) return;
          if (!p.mapping_object) return;
          if (p.mapping_object === base) { maxIndex = Math.max(maxIndex, 1); return; }
          if (p.mapping_object.indexOf(prefix) === 0) {
            var tail = p.mapping_object.slice(prefix.length);
            var n = parseInt(tail, 10);
            if (!isNaN(n)) maxIndex = Math.max(maxIndex, n);
          }
        });
        return maxIndex + 1;
      }

      // Map click handler
      map.on('click', function(e){
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker(e.latlng, { draggable:true }).addTo(map);
        tempMarker.on('dragend', function(ev){
          var ll = ev.target.getLatLng();
          if (pointIdEl) { pointIdEl.dataset.lat = ll.lat; pointIdEl.dataset.lon = ll.lng; }
        });

        var rid = currentRespondentId() || 'R?_';
        var idx = 1;
        if (currentRespondentId()) idx = pointsForRespondent(currentRespondentId()).length + 1;

        if (pointIdEl) pointIdEl.value = rid + '_P' + idx;

        // auto-fill mapping object
        try {
          if (mappingObjectEl) {
            var val = mappingObjectEl.value ? mappingObjectEl.value.trim() : '';
            if (!val) {
              var mo = (rid && rid !== 'R?_') ? (rid + '_MO' + idx) : ('MO_P' + (allPoints.length + 1));
              mappingObjectEl.value = mo;
            } else {
              var m = val.match(/^(.*?)[_\-]?0*(\d+)$/);
              var base = m && m[1] ? m[1] : val;
              var next = getNextMappingIndex(base, currentRespondentId());
              var formatted = (next < 10 ? '0' + next : '' + next);
              mappingObjectEl.value = base + '_' + formatted;
            }
          }
        } catch (err) { }

        if (pointIdEl) { pointIdEl.dataset.lat = e.latlng.lat; pointIdEl.dataset.lon = e.latlng.lng; }
      });

      // Save point
      if (saveBtn) saveBtn.addEventListener('click', function(){
        var rid = currentRespondentId();
        if (!rid && !confirm('Anda belum mengisi Respondent ID. Lanjutkan tanpa respondent_id?')) return;
        if (!pointIdEl || !pointIdEl.dataset.lat || !pointIdEl.dataset.lon) { alert('Silakan klik peta untuk memilih lokasi terlebih dahulu.'); return; }

        var lat = parseFloat(pointIdEl.dataset.lat);
        var lon = parseFloat(pointIdEl.dataset.lon);
        var pid = '';
        if (pointIdEl.value && pointIdEl.value.trim()) pid = pointIdEl.value.trim();
        else pid = rid ? (rid + '_P' + (pointsForRespondent(rid).length + 1)) : ('P' + (allPoints.length + 1));

        if (allPoints.some(function(x){ return x.point_id === pid && x.respondent_id === rid; })) {
          pid = pid + '_' + (new Date().getTime() % 10000);
        }

        var acc = accuracyEl && accuracyEl.value ? accuracyEl.value.trim() : '';
        if (acc && isNaN(Number(acc))) {
          if (!confirm('Nilai accuracy bukan numerik. Simpan sebagai teks?')) return;
        }

        var rec = {
          respondent_id: rid || '',
          stakeholder_group: stakeholderEl ? stakeholderEl.value : '',
          mapping_object: mappingObjectEl ? (mappingObjectEl.value ? mappingObjectEl.value.trim() : '') : '',
          point_id: pid,
          latitude: lat,
          longitude: lon,
          timestamp: new Date().toISOString(),
          reason: reasonEl ? (reasonEl.value ? reasonEl.value.trim() : '') : '',
          map_source: mapSourceEl ? mapSourceEl.value : '',
          accuracy_m: acc
        };

        var marker = L.circleMarker([lat, lon], { radius:6, color:'#d9534f' }).addTo(map);
        var popupParts = ['<b>' + pid + '</b>'];
        if (rec.mapping_object) popupParts.push('<i>' + rec.mapping_object + '</i>');
        if (rec.reason) popupParts.push(rec.reason);
        marker.bindPopup(popupParts.join('<br/>'));

        rec.marker = marker;
        allPoints.push(rec);

        if (tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
        resetFormFields();
        updatePointsUI();
      });

      // Export helpers
      function escapeCsvCell(s) {
        if (s === null || s === undefined) return '""';
        var str = String(s).replace(/"/g, '""');
        return '"' + str + '"';
      }

      function convertToCsv(arr) {
        var header = ['respondent_id','stakeholder_group','mapping_object','point_id','latitude','longitude','timestamp','reason','map_source','accuracy_m'];
        var lines = [ header.join(',') ];
        arr.forEach(function(r){
          var row = [
            escapeCsvCell(r.respondent_id || ''),
            escapeCsvCell(r.stakeholder_group || ''),
            escapeCsvCell(r.mapping_object || ''),
            escapeCsvCell(r.point_id || ''),
            (r.latitude != null ? r.latitude : ''),
            (r.longitude != null ? r.longitude : ''),
            escapeCsvCell(r.timestamp || ''),
            escapeCsvCell(r.reason || ''),
            escapeCsvCell(r.map_source || ''),
            escapeCsvCell(r.accuracy_m || '')
          ];
          lines.push(row.join(','));
        });
        return lines.join('\n');
      }

      function downloadText(filename, text, mimeType) {
        mimeType = mimeType || 'text/csv;charset=utf-8;';
        var bom = '\uFEFF';
        var blob = new Blob([bom + text], { type: mimeType });
        var link = document.createElement('a');
        if (link.download !== undefined) {
          var url = URL.createObjectURL(blob);
          link.setAttribute('href', url);
          link.setAttribute('download', filename);
          link.style.visibility = 'hidden';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        } else alert('Browser Anda tidak mendukung pengunduhan otomatis.');
      }

      // Export CSV
      if (exportCsvBtn) exportCsvBtn.addEventListener('click', function(){
        var rid = currentRespondentId();
        var arr = [];
        if (rid) {
          var count = pointsForRespondent(rid).length;
          if (count < 10 && !confirm('Perhatian: untuk respondent ' + rid + ' hanya terkumpul ' + count + ' titik. Minimum yang direkomendasikan adalah 10 titik. Apakah Anda tetap ingin mengekspor data ini?')) return;
          arr = pointsForRespondent(rid);
        } else {
          if (!confirm('Tidak ada Respondent ID. Akan mengekspor semua titik (' + allPoints.length + '). Lanjutkan?')) return;
          arr = allPoints;
        }
        if (!arr || arr.length === 0) { alert('Tidak ada titik untuk diekspor.'); return; }
        var csv = convertToCsv(arr);
        var fname = 'preference_points_' + (rid ? rid : 'all') + '_' + (new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')) + '.csv';
        downloadText(fname, csv, 'text/csv;charset=utf-8;');
      });

      // Export GeoJSON
      if (exportGeoBtn) exportGeoBtn.addEventListener('click', function(){
        var rid = currentRespondentId();
        var arr = [];
        if (rid) {
          var count = pointsForRespondent(rid).length;
          if (count < 10 && !confirm('Perhatian: untuk respondent ' + rid + ' hanya terkumpul ' + count + ' titik. Minimum yang direkomendasikan adalah 10 titik. Apakah Anda tetap ingin mengekspor data ini?')) return;
          arr = pointsForRespondent(rid);
        } else {
          if (!confirm('Tidak ada Respondent ID. Akan mengekspor semua titik (' + allPoints.length + '). Lanjutkan?')) return;
          arr = allPoints;
        }
        if (!arr || arr.length === 0) { alert('Tidak ada titik untuk diekspor.'); return; }
        var gj = { type: 'FeatureCollection', features: [] };
        arr.forEach(function(p){
          var f = { type: 'Feature', properties: { respondent_id: p.respondent_id, stakeholder_group: p.stakeholder_group, mapping_object: p.mapping_object, point_id: p.point_id, timestamp: p.timestamp, reason: p.reason, map_source: p.map_source, accuracy_m: p.accuracy_m }, geometry: { type: 'Point', coordinates: [p.longitude, p.latitude] } };
          gj.features.push(f);
        });
        var fname = 'preference_points_geojson_' + (rid ? rid : 'all') + '_' + (new Date().toISOString().slice(0,19).replace(/[:T]/g,'_')) + '.geojson';
        downloadText(fname, JSON.stringify(gj), 'application/geo+json;charset=utf-8;');
      });

      // Clear all
      if (clearAllBtn) clearAllBtn.addEventListener('click', function(){ if (!confirm('Hapus semua titik?')) return; allPoints.forEach(function(p){ if (p.marker) map.removeLayer(p.marker); }); allPoints = []; updatePointsUI(); });

      // Center Btn
      if (centerBtn) centerBtn.addEventListener('click', function(){ if (navigator.geolocation) navigator.geolocation.getCurrentPosition(function(pos){ map.setView([pos.coords.latitude, pos.coords.longitude], 15); }, function(){ alert('Tidak dapat memperoleh lokasi saat ini.'); }); else alert('Geolocation tidak tersedia di browser ini.'); });

      // Right-panel handlers
      if (getLocationBtn) getLocationBtn.addEventListener('click', function(){
        if (!navigator.geolocation) { alert('Geolocation tidak tersedia di browser ini.'); return; }
        getLocationBtn.disabled = true; getLocationBtn.textContent = 'Locating...';
        navigator.geolocation.getCurrentPosition(function(pos){
          var lat = pos.coords.latitude, lon = pos.coords.longitude;
          map.setView([lat, lon], 16);
          var m = L.circleMarker([lat, lon], { radius:8, color:'#337ab7' }).addTo(map);
          m.bindPopup('<b>Your location</b>').openPopup();
          setTimeout(function(){ if (map && m) map.removeLayer(m); }, 10000);
          getLocationBtn.disabled = false; getLocationBtn.textContent = 'Get my location';
        }, function(err){ alert('Gagal mendapatkan lokasi: ' + (err.message || 'permission denied')); getLocationBtn.disabled = false; getLocationBtn.textContent = 'Get my location'; }, { enableHighAccuracy:true, timeout:10000 });
      });
      if (zoomInBtn) zoomInBtn.addEventListener('click', function(){ map.zoomIn(); });
      if (zoomOutBtn) zoomOutBtn.addEventListener('click', function(){ map.zoomOut(); });

      // avoid auto-center on load
      if (navigator.geolocation) { navigator.geolocation.getCurrentPosition(function(){}, function(){}, { enableHighAccuracy:false }); }

      // --- Administrative layers (external data/) ---
      var adminLayers = { WADMPR:null, WADMKK:null, WADMKC:null, WADMKD:null };
      // track level mapping so we can restore styles later
      var adminLayerLevels = { WADMPR:null, WADMKK:null, WADMKC:null, WADMKD:null };

      // --- Government offices POI layer (unique-value symbology by "kategori") ---
      var govOfficesLayer = null;
      var govDataUrl = 'data/TOPONIMI_KANTORPEMERINTAH_PT.geojson';

      // mapping kategori -> style (minimal, hierarchical)
      var govStyleMap = {
        'Kantor Gubernur': { radius: 10, color: '#800026', weight: 2, fillColor:'#ffdddd' },
        'Kantor Bupati':   { radius: 8,  color: '#bd0026', weight: 2, fillColor:'#ffd6d6' },
        'Kantor Wali Kota':{ radius: 8,  color: '#e31a1c', weight: 2, fillColor:'#ffe6e6' },
        'Kantor Kalurahan (setingkat desa)': { radius:6, color:'#fc4e2a', weight:1.5, fillColor:'#fff0eb' },
        'Kantor Kemantren (setingkat desa)': { radius:6, color:'#fd8d3c', weight:1.5, fillColor:'#fff5e6' },
        'Kantor Kelurahan (di bawah administrasi kemantren)': { radius:4, color:'#feb24c', weight:1, fillColor:'#fff8ec' }
      };

      function getGovStyleForFeature(feat){
        var props = feat && feat.properties ? feat.properties : {};
        var k = props.kategori || props.KATEGORI || props.Kategori || '';
        var s = govStyleMap[k] || { radius:4, color:'#555', weight:1, fillColor:'#fff' };
        return s;
      }

      function getGovLabel(feat){
        var p = feat && feat.properties ? feat.properties : {};
        return p.NAMOBJ || p.name || p.nama || p.NAMA || p.Label || '';
      }

      async function loadGovOffices() {
        if (govOfficesLayer) { try{ map.removeLayer(govOfficesLayer); }catch(e){} govOfficesLayer=null; }
        try {
          var resp = await fetch(govDataUrl, { cache:'no-store' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          var gj = await resp.json();
          govOfficesLayer = L.geoJSON(gj, {
            pointToLayer: function(feature, latlng){
              var s = getGovStyleForFeature(feature);
              return L.circleMarker(latlng, { radius: s.radius, color: s.color, weight: s.weight, fillColor: s.fillColor, fillOpacity:0.9 });
            },
            onEachFeature: function(feature, layer){
              var label = getGovLabel(feature) || feature.properties.kategori || '';
              if (label) layer.bindTooltip(String(label), { direction:'top', offset:[0,-8], className:'admin-label' , permanent:false });
            }
          }).addTo(map);
          console.log('Loaded gov offices from', govDataUrl);
        } catch(err) {
          console.error('Failed loading gov offices', err);
          alert('Gagal memuat layer kantor pemerintahan: ' + (err && err.message ? err.message : err));
        }
      }

      // add control in sidebarRight for gov offices
      (function(){
        var cont = document.createElement('div'); cont.style.marginTop='12px';
        cont.innerHTML = '<label style="display:block;margin-top:6px;"><input type="checkbox" id="chk_gov_offices"> Tampilkan Kantor Pemerintah</label>';
        document.getElementById('sidebarRight').appendChild(cont);
        var cb = document.getElementById('chk_gov_offices');
        cb.addEventListener('change', function(){
          if (cb.checked) {
            // load if not yet
            if (!govOfficesLayer) loadGovOffices(); else map.addLayer(govOfficesLayer);
          } else {
            if (govOfficesLayer && map.hasLayer(govOfficesLayer)) map.removeLayer(govOfficesLayer);
          }
        });
      })();

      // --- Government offices POI layer (unique-value symbology by "kategori") ---
      var govOfficesLayer = null;
      var govDataUrl = 'data/TOPONIMI_KANTORPEMERINTAH_PT.geojson';

      // mapping kategori -> style (minimal, hierarchical)
      var govStyleMap = {
        'Kantor Gubernur': { radius: 10, color: '#800026', weight: 2, fillColor:'#ffdddd' },
        'Kantor Bupati':   { radius: 8,  color: '#bd0026', weight: 2, fillColor:'#ffd6d6' },
        'Kantor Wali Kota':{ radius: 8,  color: '#e31a1c', weight: 2, fillColor:'#ffe6e6' },
        'Kantor Kalurahan (setingkat desa)': { radius:6, color:'#fc4e2a', weight:1.5, fillColor:'#fff0eb' },
        'Kantor Kemantren (setingkat desa)': { radius:6, color:'#fd8d3c', weight:1.5, fillColor:'#fff5e6' },
        'Kantor Kelurahan (di bawah administrasi kemantren)': { radius:4, color:'#feb24c', weight:1, fillColor:'#fff8ec' }
      };

      function getGovStyleForFeature(feat){
        var props = feat && feat.properties ? feat.properties : {};
        var k = props.kategori || props.KATEGORI || props.Kategori || '';
        var s = govStyleMap[k] || { radius:4, color:'#555', weight:1, fillColor:'#fff' };
        return s;
      }

      function getGovLabel(feat){
        var p = feat && feat.properties ? feat.properties : {};
        return p.NAMOBJ || p.name || p.nama || p.NAMA || p.Label || '';
      }

      async function loadGovOffices() {
        if (govOfficesLayer) { try{ map.removeLayer(govOfficesLayer); }catch(e){} govOfficesLayer=null; }
        try {
          var resp = await fetch(govDataUrl, { cache:'no-store' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          var gj = await resp.json();
          govOfficesLayer = L.geoJSON(gj, {
            pointToLayer: function(feature, latlng){
              var s = getGovStyleForFeature(feature);
              return L.circleMarker(latlng, { radius: s.radius, color: s.color, weight: s.weight, fillColor: s.fillColor, fillOpacity:0.9 });
            },
            onEachFeature: function(feature, layer){
              var label = getGovLabel(feature) || feature.properties.kategori || '';
              if (label) layer.bindTooltip(String(label), { direction:'top', offset:[0,-8], className:'admin-label' , permanent:false });
            }
          }).addTo(map);
          console.log('Loaded gov offices from', govDataUrl);
        } catch(err) {
          console.error('Failed loading gov offices', err);
          alert('Gagal memuat layer kantor pemerintahan: ' + (err && err.message ? err.message : err));
        }
      }

      // add control in sidebarRight for gov offices
      (function(){
        var cont = document.createElement('div'); cont.style.marginTop='12px';
        cont.innerHTML = '<label style="display:block;margin-top:6px;"><input type="checkbox" id="chk_gov_offices"> Tampilkan Kantor Pemerintah</label>';
        document.getElementById('sidebarRight').appendChild(cont);
        var cb = document.getElementById('chk_gov_offices');
        cb.addEventListener('change', function(){
          if (cb.checked) {
            // load if not yet
            if (!govOfficesLayer) loadGovOffices(); else map.addLayer(govOfficesLayer);
          } else {
            if (govOfficesLayer && map.hasLayer(govOfficesLayer)) map.removeLayer(govOfficesLayer);
          }
        });
      })();

      // --- Government offices POI layer (unique-value symbology by "kategori") ---
      var govOfficesLayer = null;
      var govDataUrl = 'data/TOPONIMI_KANTORPEMERINTAH_PT.geojson';

      // mapping kategori -> style (minimal, hierarchical)
      var govStyleMap = {
        'Kantor Gubernur': { radius: 10, color: '#800026', weight: 2, fillColor:'#ffdddd' },
        'Kantor Bupati':   { radius: 8,  color: '#bd0026', weight: 2, fillColor:'#ffd6d6' },
        'Kantor Wali Kota':{ radius: 8,  color: '#e31a1c', weight: 2, fillColor:'#ffe6e6' },
        'Kantor Kalurahan (setingkat desa)': { radius:6, color:'#fc4e2a', weight:1.5, fillColor:'#fff0eb' },
        'Kantor Kemantren (setingkat desa)': { radius:6, color:'#fd8d3c', weight:1.5, fillColor:'#fff5e6' },
        'Kantor Kelurahan (di bawah administrasi kemantren)': { radius:4, color:'#feb24c', weight:1, fillColor:'#fff8ec' }
      };

      function getGovStyleForFeature(feat){
        var props = feat && feat.properties ? feat.properties : {};
        var k = props.kategori || props.KATEGORI || props.Kategori || '';
        var s = govStyleMap[k] || { radius:4, color:'#555', weight:1, fillColor:'#fff' };
        return s;
      }

      function getGovLabel(feat){
        var p = feat && feat.properties ? feat.properties : {};
        return p.NAMOBJ || p.name || p.nama || p.NAMA || p.Label || '';
      }

      async function loadGovOffices() {
        if (govOfficesLayer) { try{ map.removeLayer(govOfficesLayer); }catch(e){} govOfficesLayer=null; }
        try {
          var resp = await fetch(govDataUrl, { cache:'no-store' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          var gj = await resp.json();
          govOfficesLayer = L.geoJSON(gj, {
            pointToLayer: function(feature, latlng){
              var s = getGovStyleForFeature(feature);
              return L.circleMarker(latlng, { radius: s.radius, color: s.color, weight: s.weight, fillColor: s.fillColor, fillOpacity:0.9 });
            },
            onEachFeature: function(feature, layer){
              var label = getGovLabel(feature) || feature.properties.kategori || '';
              if (label) layer.bindTooltip(String(label), { direction:'top', offset:[0,-8], className:'admin-label' , permanent:false });
            }
          }).addTo(map);
          console.log('Loaded gov offices from', govDataUrl);
        } catch(err) {
          console.error('Failed loading gov offices', err);
          alert('Gagal memuat layer kantor pemerintahan: ' + (err && err.message ? err.message : err));
        }
      }

      // add control in sidebarRight for gov offices
      (function(){
        var cont = document.createElement('div'); cont.style.marginTop='12px';
        cont.innerHTML = '<label style="display:block;margin-top:6px;"><input type="checkbox" id="chk_gov_offices"> Tampilkan Kantor Pemerintah</label>';
        document.getElementById('sidebarRight').appendChild(cont);
        var cb = document.getElementById('chk_gov_offices');
        cb.addEventListener('change', function(){
          if (cb.checked) {
            // load if not yet
            if (!govOfficesLayer) loadGovOffices(); else map.addLayer(govOfficesLayer);
          } else {
            if (govOfficesLayer && map.hasLayer(govOfficesLayer)) map.removeLayer(govOfficesLayer);
          }
        });
      })();

      // --- Government offices POI layer (unique-value symbology by "kategori") ---
      var govOfficesLayer = null;
      var govDataUrl = 'data/TOPONIMI_KANTORPEMERINTAH_PT.geojson';

      // mapping kategori -> style (minimal, hierarchical)
      var govStyleMap = {
        'Kantor Gubernur': { radius: 10, color: '#800026', weight: 2, fillColor:'#ffdddd' },
        'Kantor Bupati':   { radius: 8,  color: '#bd0026', weight: 2, fillColor:'#ffd6d6' },
        'Kantor Wali Kota':{ radius: 8,  color: '#e31a1c', weight: 2, fillColor:'#ffe6e6' },
        'Kantor Kalurahan (setingkat desa)': { radius:6, color:'#fc4e2a', weight:1.5, fillColor:'#fff0eb' },
        'Kantor Kemantren (setingkat desa)': { radius:6, color:'#fd8d3c', weight:1.5, fillColor:'#fff5e6' },
        'Kantor Kelurahan (di bawah administrasi kemantren)': { radius:4, color:'#feb24c', weight:1, fillColor:'#fff8ec' }
      };

      function getGovStyleForFeature(feat){
        var props = feat && feat.properties ? feat.properties : {};
        var k = props.kategori || props.KATEGORI || props.Kategori || '';
        var s = govStyleMap[k] || { radius:4, color:'#555', weight:1, fillColor:'#fff' };
        return s;
      }

      function getGovLabel(feat){
        var p = feat && feat.properties ? feat.properties : {};
        return p.NAMOBJ || p.name || p.nama || p.NAMA || p.Label || '';
      }

      async function loadGovOffices() {
        if (govOfficesLayer) { try{ map.removeLayer(govOfficesLayer); }catch(e){} govOfficesLayer=null; }
        try {
          var resp = await fetch(govDataUrl, { cache:'no-store' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          var gj = await resp.json();
          govOfficesLayer = L.geoJSON(gj, {
            pointToLayer: function(feature, latlng){
              var s = getGovStyleForFeature(feature);
              return L.circleMarker(latlng, { radius: s.radius, color: s.color, weight: s.weight, fillColor: s.fillColor, fillOpacity:0.9 });
            },
            onEachFeature: function(feature, layer){
              var label = getGovLabel(feature) || feature.properties.kategori || '';
              if (label) layer.bindTooltip(String(label), { direction:'top', offset:[0,-8], className:'admin-label' , permanent:false });
            }
          }).addTo(map);
          console.log('Loaded gov offices from', govDataUrl);
        } catch(err) {
          console.error('Failed loading gov offices', err);
          alert('Gagal memuat layer kantor pemerintahan: ' + (err && err.message ? err.message : err));
        }
      }

      // add control in sidebarRight for gov offices
      (function(){
        var cont = document.createElement('div'); cont.style.marginTop='12px';
        cont.innerHTML = '<label style="display:block;margin-top:6px;"><input type="checkbox" id="chk_gov_offices"> Tampilkan Kantor Pemerintah</label>';
        document.getElementById('sidebarRight').appendChild(cont);
        var cb = document.getElementById('chk_gov_offices');
        cb.addEventListener('change', function(){
          if (cb.checked) {
            // load if not yet
            if (!govOfficesLayer) loadGovOffices(); else map.addLayer(govOfficesLayer);
          } else {
            if (govOfficesLayer && map.hasLayer(govOfficesLayer)) map.removeLayer(govOfficesLayer);
          }
        });
      })();

      // --- Government offices POI layer (unique-value symbology by "kategori") ---
      var govOfficesLayer = null;
      var govDataUrl = 'data/TOPONIMI_KANTORPEMERINTAH_PT.geojson';

      // mapping kategori -> style (minimal, hierarchical)
      var govStyleMap = {
        'Kantor Gubernur': { radius: 10, color: '#800026', weight: 2, fillColor:'#ffdddd' },
        'Kantor Bupati':   { radius: 8,  color: '#bd0026', weight: 2, fillColor:'#ffd6d6' },
        'Kantor Wali Kota':{ radius: 8,  color: '#e31a1c', weight: 2, fillColor:'#ffe6e6' },
        'Kantor Kalurahan (setingkat desa)': { radius:6, color:'#fc4e2a', weight:1.5, fillColor:'#fff0eb' },
        'Kantor Kemantren (setingkat desa)': { radius:6, color:'#fd8d3c', weight:1.5, fillColor:'#fff5e6' },
        'Kantor Kelurahan (di bawah administrasi kemantren)': { radius:4, color:'#feb24c', weight:1, fillColor:'#fff8ec' }
      };

      function getGovStyleForFeature(feat){
        var props = feat && feat.properties ? feat.properties : {};
        var k = props.kategori || props.KATEGORI || props.Kategori || '';
        var s = govStyleMap[k] || { radius:4, color:'#555', weight:1, fillColor:'#fff' };
        return s;
      }

      function getGovLabel(feat){
        var p = feat && feat.properties ? feat.properties : {};
        return p.NAMOBJ || p.name || p.nama || p.NAMA || p.Label || '';
      }

      async function loadGovOffices() {
        if (govOfficesLayer) { try{ map.removeLayer(govOfficesLayer); }catch(e){} govOfficesLayer=null; }
        try {
          var resp = await fetch(govDataUrl, { cache:'no-store' });
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          var gj = await resp.json();
          govOfficesLayer = L.geoJSON(gj, {
            pointToLayer: function(feature, latlng){
              var s = getGovStyleForFeature(feature);
              return L.circleMarker(latlng, { radius: s.radius, color: s.color, weight: s.weight, fillColor: s.fillColor, fillOpacity:0.9 });
            },
            onEachFeature: function(feature, layer){
              var label = getGovLabel(feature) || feature.properties.kategori || '';
              if (label) layer.bindTooltip(String(label), { direction:'top', offset:[0,-8], className:'admin-label' , permanent:false });
            }
          }).addTo(map);
          console.log('Loaded gov offices from', govDataUrl);
        } catch(err) {
          console.error('Failed loading gov offices', err);
          alert('Gagal memuat layer kantor pemerintahan: ' + (err && err.message ? err.message : err));
        }
      }

      // add control in sidebarRight for gov offices
      (function(){
        var cont = document.createElement('div'); cont.style.marginTop='12px';
        cont.innerHTML = '<label style="display:block;margin-top:6px;"><input type="checkbox" id="chk_gov_offices"> Tampilkan Kantor Pemerintah</label>';
        document.getElementById('sidebarRight').appendChild(cont);
        var cb = document.getElementById('chk_gov_offices');
        cb.addEventListener('change', function(){
          if (cb.checked) {
            // load if not yet
            if (!govOfficesLayer) loadGovOffices(); else map.addLayer(govOfficesLayer);
          } else {
            if (govOfficesLayer && map.hasLayer(govOfficesLayer)) map.removeLayer(govOfficesLayer);
          }
        });
      })(); 

      function styleFor(level) {
        switch(level) {
          case 'prov': return { color: '#4b2e83', weight: 5, fill: false, opacity: 0.9 };
          case 'kab':  return { color: '#2b7fb8', weight: 3.5, fill: false, opacity: 0.9 };
          case 'kec':  return { color: '#2c7a3e', weight: 2.5, fill: false, opacity: 0.9 };
          case 'desa': return { color: '#666', weight: 1.5, fill: false, opacity: 0.9 };
          default: return { color:'#000', weight:1, fill:false };
        }
      }

      async function loadAdminGeojson(key, url, level) {
        // try a few candidate URLs
        var candidates = [url, url.toLowerCase(), url.replace(/\.geojson$/i,'.json'), url.replace(/^data\//,'')];
        // absolute based on current location
        try { var base = window.location.origin + window.location.pathname.replace(/\/[^\/]*$/, ''); candidates.push(base + '/' + url); } catch(e){}
        candidates = candidates.filter(function(v,i){ return candidates.indexOf(v) === i; });

        if (adminLayers[key]) { try{ map.removeLayer(adminLayers[key]); }catch(e){} adminLayers[key]=null; adminLayerLevels[key]=null; }

        var errors = [];
        for (var i=0;i<candidates.length;i++){
          var u = candidates[i];
          try {
            var resp = await fetch(u, {cache:'no-store'});
            if (!resp.ok) { errors.push({url:u, status:resp.status}); continue; }
            var gj = await resp.json();
            var layer = L.geoJSON(gj, {
              styl
