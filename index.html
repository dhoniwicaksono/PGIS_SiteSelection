<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebGIS Prototype — Custom Symbols</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
      body {
        font-family: Arial, Helvetica, sans-serif;
      }

      /* Left sidebar (Form) */
      #sidebar {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.98);
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.25);
        width: 320px;
        max-height: 90vh;
        overflow: auto;
        transition: max-height 0.3s ease;
      }

      /* Right sidebar (Tools & Layers) */
      #sidebarRight {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.98);
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.25);
        width: 320px;
        max-height: 90vh;
        overflow: auto;
        transition: max-height 0.3s ease;
      }

      /* Mobile Navigation Bar */
      #mobile-nav {
        display: none;
      }
      .mobile-header-controls {
        display: none;
      }

      @media (max-width: 1024px) {
        #sidebar,
        #sidebarRight {
          position: fixed;
          left: 0;
          right: 0;
          bottom: 50px;
          top: auto;
          width: 100%;
          max-height: 50vh;
          border-radius: 12px 12px 0 0;
          padding: 10px 12px;
          box-sizing: border-box;
          display: none;
          z-index: 2000;
        }

        .sidebar-minimized {
          max-height: 50px !important;
          overflow: hidden !important;
        }

        .mobile-header-controls {
          display: block;
          float: right;
          background: #f0f0f0;
          border: none;
          border-radius: 4px;
          padding: 2px 8px;
          font-weight: bold;
          cursor: pointer;
        }

        .sidebar-header-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
          border-bottom: 1px solid #eee;
          padding-bottom: 5px;
        }

        .mobile-visible {
          display: block !important;
        }

        #mobile-nav {
          display: flex;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          height: 50px;
          background: white;
          border-top: 1px solid #ccc;
          z-index: 3000;
          justify-content: space-around;
          align-items: center;
          box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        #mobile-nav button {
          flex: 1;
          height: 100%;
          border: none;
          background: #fff;
          font-weight: 600;
          color: #555;
          cursor: pointer;
          font-size: 14px;
        }

        #mobile-nav button.active {
          color: #2c7be5;
          border-top: 3px solid #2c7be5;
          background: #f4f9ff;
        }
      }

      .btn {
        display: inline-block;
        padding: 8px 12px;
        margin: 6px 4px;
        border-radius: 6px;
        border: 1px solid #2c7be5;
        background: #2c7be5;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
      }
      .btn.secondary {
        background: #fff;
        color: #2c7be5;
      }
      .btn.tertiary {
        background: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
      }
      .smallBtn {
        padding: 4px 6px;
        font-size: 12px;
      }

      label {
        display: block;
        margin-top: 8px;
        font-weight: 600;
      }
      .ctrl-label {
        display: flex;
        align-items: center;
        margin-top: 6px;
        font-weight: normal;
        cursor: pointer;
        font-size: 14px;
      }
      .ctrl-label input {
        width: auto;
        margin-top: 0;
        margin-right: 8px;
        cursor: pointer;
      }

      /* LEGEND SHAPES CSS */
      .legend-item {
        display: flex;
        align-items: center;
        font-size: 12px;
        margin-top: 4px;
        color: #555;
      }
      .legend-symbol {
        display: inline-block;
        margin-right: 6px;
        box-shadow: 0 0 1px rgba(0, 0, 0, 0.2); 
      }
      
      /* Shape Classes */
      .sym-circle { width: 12px; height: 12px; border-radius: 50%; border: 2px solid #cccccc; }
      .sym-square { width: 12px; height: 12px; border-radius: 0; border: 2px solid #cccccc; }
      .sym-diamond { width: 10px; height: 10px; transform: rotate(45deg); border: 2px solid #cccccc; margin-left: 2px; margin-right: 8px; }
      .sym-hexagon { width: 14px; height: 14px; display: flex; justify-content: center; align-items: center; }
      .sym-star { width: 14px; height: 14px; background: transparent; display: flex; justify-content: center; align-items: center; }
      .sym-h {
        width: 14px; height: 14px; background: transparent !important; box-shadow: none;
        font-weight: 900; font-family: sans-serif; text-align: center; line-height: 14px; font-size: 14px;
        text-shadow: -1px -1px 0 #cccccc, 1px -1px 0 #cccccc, -1px 1px 0 #cccccc, 1px 1px 0 #cccccc;
      }

      input[type="text"],
      select,
      textarea {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        margin-top: 6px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      textarea {
        resize: vertical;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }
      table th,
      table td {
        border: 1px solid #ddd;
        padding: 6px;
        font-size: 13px;
      }
      .small {
        font-size: 13px;
        color: #555;
      }

      @media (max-width: 700px) {
        table th:nth-child(5), table td:nth-child(5),
        table th:nth-child(6), table td:nth-child(6) { display: none; }
        .btn { font-size: 13px; padding: 8px 10px; }
      }

      .leaflet-control-layers {
        z-index: 1200;
      }

      /* Admin Labels & Suggestions */
      .admin-label {
        background: rgba(255, 255, 255, 0.85);
        padding: 2px 4px;
        border-radius: 4px;
        font-size: 11px;
        color: #111;
      }
      .admin-label-prov { text-shadow: 0 0 8px #fff; font-weight: 700; }
      .admin-label-kab { text-shadow: 0 0 6px #fff; }
      #admin_suggestions div:hover { background: #f5f8ff; }

      /* --- UPDATED LABEL STYLE (Text Wrapping) --- */
      .feature-label {
        background: rgba(255, 255, 255, 0.75); 
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        padding: 1px 4px;
        box-shadow: 0 1px 2px rgba(0,0,0,0.15);

        /* Default Font Size */
        font-size: 9px; 
        
        font-weight: bold;
        color: #222;
        text-transform: none !important;
        text-shadow: none;
        
        /* REVISI: white-space: nowrap + <br> 
           Ini memaksa browser untuk TIDAK memecah baris sendiri,
           sehingga pemecahan baris murni dikendalikan oleh tag <br>
           yang kita suntikkan setiap 2 kata.
        */
        white-space: nowrap; 
        
        text-align: center;
        line-height: 1.2;
        
        display: none;
        pointer-events: none;
      }
      .show-labels .feature-label {
        display: block !important;
      }

      /* DYNAMIC FONT SIZES */
      .map-zoom-15 .feature-label { font-size: 9px; }
      .map-zoom-16 .feature-label { font-size: 10px; }
      .map-zoom-17 .feature-label, 
      .map-zoom-18 .feature-label,
      .map-zoom-19 .feature-label { font-size: 11px; }

      .custom-div-icon {
        background: transparent;
        border: none;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- LEFT SIDEBAR -->
    <div id="sidebar" class="mobile-visible">
      <div class="sidebar-header-row">
        <h3 style="margin: 0">Collector</h3>
        <button class="mobile-header-controls" onclick="toggleSidebarHeight('sidebar', this)">▼</button>
      </div>

      <div class="small">Klik peta untuk menambahkan titik. Isi atribut di form, lalu tekan <b>Save Point</b>.</div>

      <label>Respondent ID</label>
      <input type="text" id="respondent_id" placeholder="e.g. R01" />

      <label>Stakeholder Group</label>
      <select id="stakeholder_group">
        <option value="Pemerintah_Desa">Pemerintah Desa</option>
        <option value="Pelaku_Usaha">Pelaku Usaha</option>
        <option value="Dinas_Terkait">Dinas Terkait</option>
        <option value="Lainnya">Lainnya</option>
      </select>

      <label>Mapping Object</label>
      <input type="text" id="mapping_object" placeholder="contoh: Pendidikan" />

      <label>Point ID (optional)</label>
      <input type="text" id="point_id" placeholder="auto: R01_P1" />

      <label>Reason (optional)</label>
      <textarea id="reason" rows="2" placeholder="Contoh: dekat jalan kolektor dan pasar"></textarea>

      <label>Map Source</label>
      <select id="map_source">
        <option value="webGIS">webGIS</option>
        <option value="peta_cetak">peta_cetak</option>
        <option value="gps">gps</option>
      </select>

      <label>Accuracy (m) — optional</label>
      <input type="text" id="accuracy_m" placeholder="e.g. 10" />

      <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; align-items: center">
        <button id="savePointBtn" class="btn">Save Point</button>
        <button id="clearFormBtn" class="btn secondary">Clear Form</button>
        <button id="centerBtn" class="btn tertiary">Center Map</button>
      </div>

      <hr />

      <div class="small"><b>Points collected:</b></div>
      <div id="pointsCount">0 points</div>

      <table id="pointsTable" style="display: none">
        <thead>
          <tr>
            <th>#</th>
            <th>ID</th>
            <th>Mapping Object</th>
            <th>Lat</th>
            <th>Lon</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap">
        <button id="exportCsv" class="btn">Export CSV</button>
        <button id="exportGeojson" class="btn">Export GeoJSON</button>
        <button id="clearAll" class="btn secondary">Clear All</button>
      </div>
    </div>

    <!-- RIGHT SIDEBAR -->
    <div id="sidebarRight">
      <div class="sidebar-header-row">
        <h3 style="margin: 0">Peta & Layers</h3>
        <button class="mobile-header-controls" onclick="toggleSidebarHeight('sidebarRight', this)">▼</button>
      </div>

      <!-- Basemap -->
      <h4 style="margin: 6px 0; font-size: 14px; text-decoration: underline">Basemap</h4>
      <div style="margin-bottom: 12px">
        <label class="ctrl-label"> <input type="radio" name="basemap_select" value="osm" checked /> OSM Standard </label>
        <label class="ctrl-label"> <input type="radio" name="basemap_select" value="esri" /> Esri Satellite </label>
        <label class="ctrl-label"> <input type="radio" name="basemap_select" value="opnv" /> OPNVKarte (Transport) </label>
      </div>

      <hr />

      <!-- Layers -->
      <h4 style="margin: 6px 0; font-size: 14px; text-decoration: underline">Layers</h4>
      <div style="margin-bottom: 12px">
        
        <!-- 1. PEMERINTAHAN -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">1. Kantor Pemerintah</div>
        <label class="ctrl-label"> <input type="checkbox" id="layer_kantor_pemerintah" /> Kantor Pemerintahan </label>
        <div id="legend_kantor" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item"><span class="legend-symbol sym-square" style="background: #e31a1c"></span>Kantor Gubernur</div>
          <div class="legend-item"><span class="legend-symbol sym-square" style="background: #fd8d3c"></span>Kantor Bupati/ Walikota</div>
          <div class="legend-item"><span class="legend-symbol sym-square" style="background: #a6611a"></span>Kantor Kecamatan/ Kemantren</div>
          <div class="legend-item"><span class="legend-symbol sym-square" style="background: #dfc27d"></span>Kantor Desa/ Kelurahan/ Kalurahan</div>
        </div>

        <hr style="border-top: 1px dashed #ddd; margin: 8px 0" />

        <!-- 2. KESEHATAN -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">2. Fasilitas Kesehatan</div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_rs" /> Rumah Sakit </label>
        <div id="legend_rs" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item"><span class="legend-symbol sym-h" style="color: #253494">H</span>RS Umum</div>
          <div class="legend-item"><span class="legend-symbol sym-h" style="color: #2c7fb8">H</span>RS Khusus/Lainnya</div>
        </div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_puskesmas" /> Puskesmas </label>
        <div id="legend_puskesmas" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item"><span class="legend-symbol sym-h" style="color: #1a9850">H</span>Puskesmas</div>
        </div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_klinik" /> Klinik </label>
        <div id="legend_klinik" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item"><span class="legend-symbol sym-h" style="color: #a6d96a">H</span>Klinik</div>
        </div>

        <hr style="border-top: 1px dashed #ddd; margin: 8px 0" />

        <!-- 3. PENDIDIKAN -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">3. Fasilitas Pendidikan</div>
        <label class="ctrl-label">
          <input type="checkbox" id="layer_sekolah" /> Sekolah (SD/SMP/SMA)
          <span style="font-size: 10px; background: #eee; padding: 1px 3px; border-radius: 3px; margin-left: 4px;">Cluster</span>
        </label>
        <div id="legend_sekolah" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item"><span class="legend-symbol sym-circle" style="background: #d95f0e"></span>SMA / SMK</div>
          <div class="legend-item"><span class="legend-symbol sym-circle" style="background: #fe9929"></span>SMP / Sederajat</div>
          <div class="legend-item"><span class="legend-symbol sym-circle" style="background: #fed98e"></span>SD / Sederajat</div>
        </div>
        
        <label class="ctrl-label"> <input type="checkbox" id="layer_kampus" /> Perguruan Tinggi </label>
        <div id="legend_kampus" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item"><span class="legend-symbol sym-circle" style="background: #993404"></span>Universitas</div>
          <div class="legend-item"><span class="legend-symbol sym-circle" style="background: #d95f0e"></span>Institut/Poltek</div>
        </div>

        <hr style="border-top: 1px dashed #ddd; margin: 8px 0" />

        <!-- 4. EKONOMI -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">4. Fasilitas Ekonomi</div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_pasar" /> Pasar Tradisional </label>
        <div id="legend_pasar" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
             <span class="legend-symbol sym-hexagon">
               <svg width="12" height="12" viewBox="0 0 24 24"><polygon points="12,2 21,7 21,17 12,22 3,17 3,7" fill="#8e0152" stroke="#cccccc" stroke-width="2"/></svg>
             </span>Pasar Harian
          </div>
          <div class="legend-item">
             <span class="legend-symbol sym-hexagon">
               <svg width="12" height="12" viewBox="0 0 24 24"><polygon points="12,2 21,7 21,17 12,22 3,17 3,7" fill="#7fbc41" stroke="#cccccc" stroke-width="2"/></svg>
             </span>Pasar Non Harian
          </div>
        </div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_ibm" /> Industri / IBM </label>
        <div id="legend_ibm" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item"><span class="legend-symbol sym-diamond" style="background: #b2df8a"></span>Makanan & Minuman</div>
          <div class="legend-item"><span class="legend-symbol sym-diamond" style="background: #fb9a99"></span>Tekstil & Kulit</div>
          <div class="legend-item"><span class="legend-symbol sym-diamond" style="background: #6a3d9a"></span>Kayu & Furnitur</div>
          <div class="legend-item"><span class="legend-symbol sym-diamond" style="background: #cab2d6"></span>Kertas & Cetak</div>
          <div class="legend-item"><span class="legend-symbol sym-diamond" style="background: #e31a1c"></span>Kimia & Plastik</div>
          <div class="legend-item"><span class="legend-symbol sym-diamond" style="background: #ff7f00"></span>Logam & Mesin</div>
          <div class="legend-item"><span class="legend-symbol sym-diamond" style="background: #33a02c"></span>Kerajinan</div>
          <div class="legend-item"><span class="legend-symbol sym-diamond" style="background: #a6cee3"></span>Lainnya</div>
        </div>

        <hr style="border-top: 1px dashed #ddd; margin: 8px 0" />

        <!-- 5. PARIWISATA -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">5. Pariwisata</div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_dtw" /> Objek Wisata (DTW) </label>
        <div id="legend_dtw" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol sym-star">
              <svg width="12" height="12" viewBox="0 0 24 24"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9" fill="#33a02c" stroke="#cccccc" stroke-width="2"/></svg>
            </span>Wisata Alam
          </div>
          <div class="legend-item">
            <span class="legend-symbol sym-star">
              <svg width="12" height="12" viewBox="0 0 24 24"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9" fill="#1f78b4" stroke="#cccccc" stroke-width="2"/></svg>
            </span>Wisata Bahari
          </div>
          <div class="legend-item">
            <span class="legend-symbol sym-star">
               <svg width="12" height="12" viewBox="0 0 24 24"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9" fill="#ff7f00" stroke="#cccccc" stroke-width="2"/></svg>
            </span>Wisata Budaya
          </div>
          <div class="legend-item">
            <span class="legend-symbol sym-star">
               <svg width="12" height="12" viewBox="0 0 24 24"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9" fill="#d7191c" stroke="#cccccc" stroke-width="2"/></svg>
            </span>Desa Wisata
          </div>
        </div>
      </div>

      <hr />

      <h3 style="margin: 6px 0">Tools</h3>
      <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 12px; align-items: center">
        <button id="getLocationBtn" class="btn" style="width: 80%; text-align: center">Get my location</button>
        <div style="display: flex; gap: 8px; justify-content: center; width: 100%">
          <button id="zoomInBtn" class="btn tertiary" style="width: 40%; text-align: center">Zoom In</button>
          <button id="zoomOutBtn" class="btn tertiary" style="width: 40%; text-align: center">Zoom Out</button>
        </div>
      </div>
      
      <!-- Admin Search Container (RESTORED) -->
      <div id="admin_search_container" style="margin-top: 12px; border-top: 1px solid #ddd; padding-top: 12px"></div>
    </div>

    <div id="mobile-nav">
      <button id="tab-form" class="active">Form Data</button>
      <button id="tab-layers">Layers & Tools</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <script>
      // --- Mobile UI & Tabs ---
      function toggleSidebarHeight(id, btn) {
        var el = document.getElementById(id);
        if (el.classList.contains("sidebar-minimized")) {
          el.classList.remove("sidebar-minimized");
          btn.innerHTML = "▼";
        } else {
          el.classList.add("sidebar-minimized");
          btn.innerHTML = "▲";
        }
      }

      (function () {
        var tabForm = document.getElementById("tab-form");
        var tabLayers = document.getElementById("tab-layers");
        var sidebarLeft = document.getElementById("sidebar");
        var sidebarRight = document.getElementById("sidebarRight");

        function switchTab(target) {
          tabForm.classList.remove("active");
          tabLayers.classList.remove("active");
          sidebarLeft.classList.remove("mobile-visible");
          sidebarRight.classList.remove("mobile-visible");
          sidebarLeft.classList.remove("sidebar-minimized");
          sidebarRight.classList.remove("sidebar-minimized");
          
          if (target === "form") {
            tabForm.classList.add("active");
            sidebarLeft.classList.add("mobile-visible");
          } else {
            tabLayers.classList.add("active");
            sidebarRight.classList.add("mobile-visible");
          }
        }
        tabForm.addEventListener("click", function () { switchTab("form"); });
        tabLayers.addEventListener("click", function () { switchTab("layers"); });
      })();

      // --- Map Init ---
      var osm = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: "© OpenStreetMap" });
      var Esri_WorldImagery = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { attribution: "Esri" });
      var OPNVKarte = L.tileLayer("https://tileserver.memomaps.de/tilegen/{z}/{x}/{y}.png", { maxZoom: 18, attribution: "OPNVKarte" });

      var map = L.map("map", { center: [-7.8, 110.37], zoom: 12, layers: [osm], preferCanvas: true });
      L.control.scale().addTo(map);

      // --- Label Visibility & DYNAMIC FONT on Zoom ---
      function checkZoomForLabels() {
        var z = map.getZoom();
        var container = map.getContainer();
        
        // 1. Show/Hide threshold
        if (z >= 15) container.classList.add("show-labels");
        else container.classList.remove("show-labels");

        // 2. Dynamic Font Size Classes
        container.classList.remove("map-zoom-15", "map-zoom-16", "map-zoom-17", "map-zoom-18", "map-zoom-19");
        if (z >= 15) {
          var zoomClass = "map-zoom-" + (z > 19 ? 19 : z);
          container.classList.add(zoomClass);
        }
      }
      map.on("zoomend", checkZoomForLabels);
      checkZoomForLabels();

      // --- Helper: Format Label Text (Strict 2 Words per Line) ---
      function formatLabelText(text) {
        if (!text) return "";
        var words = text.split(" ");
        var lines = [];
        // Updated loop to increment by 2
        for (var i = 0; i < words.length; i += 2) {
          lines.push(words.slice(i, i + 2).join(" "));
        }
        return lines.join("<br>");
      }

      // --- Basemap Switch ---
      document.querySelectorAll('input[name="basemap_select"]').forEach(function (radio) {
        radio.addEventListener("change", function (e) {
          var val = e.target.value;
          if (map.hasLayer(osm)) map.removeLayer(osm);
          if (map.hasLayer(Esri_WorldImagery)) map.removeLayer(Esri_WorldImagery);
          if (map.hasLayer(OPNVKarte)) map.removeLayer(OPNVKarte);
          if (val === "osm") map.addLayer(osm);
          else if (val === "esri") map.addLayer(Esri_WorldImagery);
          else if (val === "opnv") map.addLayer(OPNVKarte);
        });
      });

      // --- GeoJSON Helper ---
      function fetchGeoJSON(url) {
        var paths = [url, "data/" + url];
        return new Promise(function (resolve, reject) {
          function tryFetch(idx) {
            if (idx >= paths.length) { reject("File not found"); return; }
            fetch(paths[idx])
              .then(r => { if (!r.ok) throw new Error("404"); return r.json(); })
              .then(data => resolve(data))
              .catch(() => tryFetch(idx + 1));
          }
          tryFetch(0);
        });
      }

      function mercatorToLatLon(x, y) {
        var rMajor = 6378137;
        var shift = Math.PI * rMajor;
        var lon = (x / shift) * 180.0;
        var lat = (y / shift) * 180.0;
        lat = (180 / Math.PI) * (2 * Math.atan(Math.exp((lat * Math.PI) / 180.0)) - Math.PI / 2.0);
        return [lat, lon];
      }

      // --- COLOR & STYLE FUNCTIONS ---

      // 1. PEMERINTAHAN
      function getGovColor(kategori) {
        if (!kategori) return "#dfc27d";
        var k = String(kategori).toLowerCase();
        if (k.includes("gubernur") || k.includes("diy")) return "#e31a1c"; 
        if (k.includes("bupati") || k.includes("walikota")) return "#fd8d3c"; 
        if (k.includes("camat") || k.includes("kemantren") || k.includes("kecamatan")) return "#a6611a"; 
        if (k.includes("kelurahan") || k.includes("desa") || k.includes("kalurahan") || k.includes("lurah")) return "#dfc27d"; 
        return "#dfc27d"; 
      }

      // 2. KESEHATAN
      function getRSColor(ket) {
        if (!ket) return "#2c7fb8";
        var k = String(ket).toLowerCase();
        if (k.includes("rsu")) return "#253494"; 
        return "#2c7fb8"; 
      }
      function getPuskesmasColor(ket) { return "#1a9850"; } 
      function getKlinikColor(ket) { return "#a6d96a"; }    

      // 3. PENDIDIKAN
      function getSekolahColor(ket) {
        if (!ket) return "#fed98e";
        var k = String(ket).toLowerCase();
        if (k.includes("sma") || k.includes("smk")) return "#d95f0e";
        if (k.includes("smp")) return "#fe9929";
        if (k.includes("sd")) return "#fed98e";
        return "#ffffd4";
      }
      function getKampusColor(ket) {
        if (!ket) return "#d95f0e";
        var k = String(ket).toLowerCase();
        if (k.includes("universitas")) return "#993404"; 
        return "#d95f0e"; 
      }

      // 4. EKONOMI
      function getPasarColor(ket) {
        if (!ket) return "#c51b7d";
        var k = String(ket).toLowerCase();
        if (k.includes("harian") && !k.includes("non")) return "#8e0152"; 
        return "#7fbc41"; 
      }

      function getIbmColor(ket) {
        if (!ket) return "#a6cee3";
        var k = String(ket).toLowerCase();
        if (k.includes("food") || k.includes("beverage") || k.includes("makan") || k.includes("minum")) return "#b2df8a";
        if (k.includes("textile") || k.includes("leather") || k.includes("tekstil") || k.includes("kulit")) return "#fb9a99";
        if (k.includes("wood") || k.includes("furniture") || k.includes("kayu") || k.includes("mebel")) return "#6a3d9a";
        if (k.includes("paper") || k.includes("printing") || k.includes("kertas") || k.includes("cetak")) return "#cab2d6";
        if (k.includes("chemical") || k.includes("plastic") || k.includes("kimia") || k.includes("plastik")) return "#e31a1c";
        if (k.includes("metal") || k.includes("machine") || k.includes("logam") || k.includes("mesin")) return "#ff7f00";
        if (k.includes("craft") || k.includes("kerajinan")) return "#33a02c";
        return "#a6cee3";
      }

      // 5. PARIWISATA
      function getDtwColor(ket) {
        if (!ket) return "#ff7f00"; 
        var k = String(ket).toLowerCase();
        if (k.includes("alam")) return "#33a02c"; 
        if (k.includes("bahari") || k.includes("pantai")) return "#1f78b4"; 
        if (k.includes("budaya")) return "#ff7f00"; 
        if (k.includes("desa")) return "#d7191c"; 
        return "#ff7f00"; 
      }

      // --- CUSTOM MARKER CREATION ---
      function createCustomMarker(latlng, type, color, properties) {
        var size = 14; 
        var strokeColor = "#cccccc";
        var strokeWidth = 2; 
        
        if (type === 'circle') {
          return L.circleMarker(latlng, {
            radius: 6,
            color: strokeColor, 
            weight: strokeWidth,
            opacity: 1,
            fillOpacity: 1,
            fillColor: color
          });
        }

        var html = "";
        
        if (type === 'square') {
          html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;">
                    <rect x="2" y="2" width="20" height="20" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}" />
                  </svg>`;
        } 
        else if (type === 'diamond') {
          html = `<svg width="${size+2}" height="${size+2}" viewBox="0 0 24 24" style="display:block;">
                    <polygon points="12,2 22,12 12,22 2,12" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}" />
                  </svg>`;
        }
        else if (type === 'star') {
          html = `<svg width="${size+4}" height="${size+4}" viewBox="0 0 24 24" style="display:block;">
                    <polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}" />
                  </svg>`;
        }
        else if (type === 'hexagon') {
          html = `<svg width="${size+2}" height="${size+2}" viewBox="0 0 24 24" style="display:block;">
                    <polygon points="12,2 21,7 21,17 12,22 3,17 3,7" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}" />
                  </svg>`;
        }
        else if (type === 'h') {
          html = `<div style="
            width:${size}px; height:${size}px; 
            color:${color}; 
            font-weight:900; font-family:sans-serif; 
            font-size:16px; line-height:${size}px; text-align:center;
            text-shadow: 
               -1px -1px 0 ${strokeColor},  
                1px -1px 0 ${strokeColor},
               -1px  1px 0 ${strokeColor},
                1px  1px 0 ${strokeColor};
          ">H</div>`;
        }

        var icon = L.divIcon({
          className: 'custom-div-icon',
          html: html,
          iconSize: [size, size],
          iconAnchor: [size/2, size/2]
        });

        return L.marker(latlng, { icon: icon });
      }

      // --- LAYER LOADERS (Apply Text Wrapping Here) ---
      
      var layerStorage = {};

      function loadLayer(key, url, shapeType, colorFunc) {
        if (layerStorage[key]) {
          map.addLayer(layerStorage[key]);
          return;
        }
        fetchGeoJSON(url).then(function (data) {
          var lyr = L.geoJSON(data, {
            coordsToLatLng: function (coords) {
              if (Math.abs(coords[0]) > 180 || Math.abs(coords[1]) > 180) {
                  var latlon = mercatorToLatLon(coords[0], coords[1]);
                  return new L.LatLng(latlon[0], latlon[1]);
              }
              return new L.LatLng(coords[1], coords[0]);
            },
            pointToLayer: function (feature, latlng) {
              var p = feature.properties;
              var val = p.kategori || p.keterangan || "";
              var color = colorFunc(val);
              return createCustomMarker(latlng, shapeType, color, p);
            },
            onEachFeature: function (feature, layer) {
              var p = feature.properties;
              var nm = p.namobj || key;
              layer.bindPopup("<b>" + nm + "</b><br/>" + (p.keterangan || p.kategori || "-"));
              if (p.namobj) {
                // APPLY FORMATTING HERE (2 words per line)
                var formattedLabel = formatLabelText(p.namobj);
                layer.bindTooltip(formattedLabel, { permanent: true, direction: "top", className: "feature-label", offset: [0, -8] });
              }
            }
          }).addTo(map);
          layerStorage[key] = lyr;
        }).catch(err => {
          console.error("Layer error " + key, err);
          alert("Gagal memuat layer: " + key + "\nFile mungkin tidak ditemukan: " + url);
        });
      }

      // --- Custom Cluster for Education (Circle) ---
      function loadSekolahCluster() {
        if (layerStorage['sekolah']) {
          map.addLayer(layerStorage['sekolah']);
          return;
        }
        var cluster = L.markerClusterGroup({
          spiderfyShapePositions: function (count, centerPt) {
            var distanceFromCenter = 35, markerDistance = 45, lineLength = markerDistance * (count - 1),
                lineStart = centerPt.y - lineLength / 2, res = [];
            for (var i = count - 1; i >= 0; i--) {
              res[i] = new L.Point(centerPt.x + distanceFromCenter, lineStart + markerDistance * i);
            }
            return res;
          }
        });

        fetchGeoJSON("ONLINE_DIKPORA_SEKOLAH_DASAR_MENENGAH_PT.geojson").then(data => {
          var gj = L.geoJSON(data, {
             coordsToLatLng: function (coords) {
                if (Math.abs(coords[0]) > 180 || Math.abs(coords[1]) > 180) {
                  var latlon = mercatorToLatLon(coords[0], coords[1]);
                  return new L.LatLng(latlon[0], latlon[1]);
                }
                return new L.LatLng(coords[1], coords[0]);
            },
            pointToLayer: function (feature, latlng) {
              var col = getSekolahColor(feature.properties.keterangan);
              // Use circle for Sekolah
              return createCustomMarker(latlng, 'circle', col);
            },
            onEachFeature: function (feature, layer) {
              var p = feature.properties;
              layer.bindPopup("<b>" + (p.namobj||"Sekolah") + "</b><br/>" + (p.keterangan||"-"));
              if(p.namobj) {
                 // APPLY FORMATTING HERE (2 words per line)
                 var formattedLabel = formatLabelText(p.namobj);
                 layer.bindTooltip(formattedLabel, {permanent:true, direction:"top", className:"feature-label", offset:[0,-8]});
              }
            }
          });
          cluster.addLayer(gj);
          map.addLayer(cluster);
          layerStorage['sekolah'] = cluster;
        }).catch(err => {
             console.error("Layer error sekolah", err);
             alert("Gagal memuat layer Sekolah");
        });
      }

      // --- Event Listeners ---
      
      // 1. Pemerintah
      document.getElementById("layer_kantor_pemerintah").addEventListener("change", function(e) {
        var lg = document.getElementById("legend_kantor");
        if(e.target.checked) {
          loadLayer("kantor", "TOPONIMI_KANTORPEMERINTAH_PT.geojson", "square", getGovColor);
          lg.style.display = "block";
        } else {
          if(layerStorage["kantor"]) map.removeLayer(layerStorage["kantor"]);
          lg.style.display = "none";
        }
      });

      // 2. Kesehatan
      document.getElementById("layer_rs").addEventListener("change", function(e) {
        var lg = document.getElementById("legend_rs");
        if(e.target.checked) {
          loadLayer("rs", "ONLINE_DINKES_RUMAHSAKIT_PT.geojson", "h", getRSColor);
          lg.style.display = "block";
        } else {
          if(layerStorage["rs"]) map.removeLayer(layerStorage["rs"]);
          lg.style.display = "none";
        }
      });
      document.getElementById("layer_puskesmas").addEventListener("change", function(e) {
        var lg = document.getElementById("legend_puskesmas");
        if(e.target.checked) {
          loadLayer("puskesmas", "ONLINE_DINKES_PUSKESMAS_PT.geojson", "h", getPuskesmasColor);
          lg.style.display = "block";
        } else {
          if(layerStorage["puskesmas"]) map.removeLayer(layerStorage["puskesmas"]);
          lg.style.display = "none";
        }
      });
      document.getElementById("layer_klinik").addEventListener("change", function(e) {
        var lg = document.getElementById("legend_klinik");
        if(e.target.checked) {
          loadLayer("klinik", "ONLINE_DINKES_KLINIK_PT.geojson", "h", getKlinikColor);
          lg.style.display = "block";
        } else {
          if(layerStorage["klinik"]) map.removeLayer(layerStorage["klinik"]);
          lg.style.display = "none";
        }
      });

      // 3. Pendidikan
      document.getElementById("layer_sekolah").addEventListener("change", function(e) {
        var lg = document.getElementById("legend_sekolah");
        if(e.target.checked) {
          loadSekolahCluster();
          lg.style.display = "block";
        } else {
          if(layerStorage["sekolah"]) map.removeLayer(layerStorage["sekolah"]);
          lg.style.display = "none";
        }
      });

      document.getElementById("layer_kampus").addEventListener("change", function(e) {
        var lg = document.getElementById("legend_kampus");
        if(e.target.checked) {
          loadLayer("kampus", "ONLINE_AGOL_PENDIDIKANTINGGI_PT.geojson", "circle", getKampusColor);
          lg.style.display = "block";
        } else {
          if(layerStorage["kampus"]) map.removeLayer(layerStorage["kampus"]);
          lg.style.display = "none";
        }
      });

      // 4. Ekonomi
      document.getElementById("layer_pasar").addEventListener("change", function(e) {
        var lg = document.getElementById("legend_pasar");
        if(e.target.checked) {
          loadLayer("pasar", "ONLINE_DISPERINDAG_PASAR_PT.geojson", "hexagon", getPasarColor);
          lg.style.display = "block";
        } else {
          if(layerStorage["pasar"]) map.removeLayer(layerStorage["pasar"]);
          lg.style.display = "none";
        }
      });
      
      document.getElementById("layer_ibm").addEventListener("change", function(e) {
        var lg = document.getElementById("legend_ibm");
        if(e.target.checked) {
          loadLayer("ibm", "ONLINE_DISPERINDAG_IBM_2024_PT.geojson", "diamond", getIbmColor);
          lg.style.display = "block";
        } else {
          if(layerStorage["ibm"]) map.removeLayer(layerStorage["ibm"]);
          lg.style.display = "none";
        }
      });

      // 5. Pariwisata
      document.getElementById("layer_dtw").addEventListener("change", function(e) {
        var lg = document.getElementById("legend_dtw");
        if(e.target.checked) {
          loadLayer("dtw", "ONLINE_DISPAR_KUNJUNGAN_DTW_2024_PT.geojson", "star", getDtwColor);
          lg.style.display = "block";
        } else {
          if(layerStorage["dtw"]) map.removeLayer(layerStorage["dtw"]);
          lg.style.display = "none";
        }
      });

      // --- Point Collection & Admin Logic (Kept simplified/condensed) ---
      var allPoints = [];
      var tempMarker = null;

      map.on("click", function (e) {
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker(e.latlng, { draggable: true }).addTo(map);
        var pidEl = document.getElementById("point_id");
        if(pidEl) { pidEl.dataset.lat = e.latlng.lat; pidEl.dataset.lon = e.latlng.lng; }
      });

      document.getElementById("savePointBtn").addEventListener("click", function() {
        var pidEl = document.getElementById("point_id");
        if(!pidEl || !pidEl.dataset.lat) { alert("Klik peta dulu"); return; }
        var rid = document.getElementById("respondent_id").value;
        var lat = parseFloat(pidEl.dataset.lat), lon = parseFloat(pidEl.dataset.lon);
        
        var pt = {
           respondent_id: rid, 
           point_id: pidEl.value || ("P"+allPoints.length),
           latitude: lat, longitude: lon,
           mapping_object: document.getElementById("mapping_object").value
        };
        
        var m = L.circleMarker([lat,lon], {radius:6, color:"#d9534f"}).addTo(map)
                 .bindPopup(pt.point_id);
        pt.marker = m;
        allPoints.push(pt);
        if(tempMarker) { map.removeLayer(tempMarker); tempMarker = null; }
        updateTable();
      });

      function updateTable() {
        var tb = document.querySelector("#pointsTable tbody");
        tb.innerHTML = "";
        document.getElementById("pointsTable").style.display = allPoints.length ? "table" : "none";
        document.getElementById("pointsCount").innerText = allPoints.length + " points";
        allPoints.forEach((p,i) => {
          var tr = document.createElement("tr");
          tr.innerHTML = `<td>${i+1}</td><td>${p.point_id}</td><td>${p.mapping_object}</td><td>${p.latitude.toFixed(5)}</td><td>${p.longitude.toFixed(5)}</td><td><button onclick="delPoint(${i})" class="btn secondary smallBtn">Del</button></td>`;
          tb.appendChild(tr);
        });
      }
      window.delPoint = function(i) {
        if(allPoints[i].marker) map.removeLayer(allPoints[i].marker);
        allPoints.splice(i,1);
        updateTable();
      };

      document.getElementById("exportCsv").addEventListener("click", function() {
        if(!allPoints.length) return;
        var csv = "respondent_id,point_id,lat,lon,object\n" + allPoints.map(p => `${p.respondent_id},${p.point_id},${p.latitude},${p.longitude},${p.mapping_object}`).join("\n");
        var b = new Blob([csv], {type:"text/csv"});
        var a = document.createElement("a");
        a.href = URL.createObjectURL(b); a.download = "points.csv";
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
      });

      document.getElementById("clearAll").addEventListener("click", function() {
        allPoints.forEach(p => map.removeLayer(p.marker));
        allPoints = [];
        updateTable();
      });

      // --- Administrative Search Logic (RESTORED) ---
      var adminLayers = { WADMPR: null, WADMKK: null, WADMKC: null, WADMKD: null };
      var adminLayerLevels = { WADMPR: null, WADMKK: null, WADMKC: null, WADMKD: null };

      function styleFor(level) {
        switch (level) {
          case "prov": return { color: "#4b2e83", weight: 5, fill: false, opacity: 0.9 };
          case "kab": return { color: "#2b7fb8", weight: 3.5, fill: false, opacity: 0.9 };
          case "kec": return { color: "#2c7a3e", weight: 2.5, fill: false, opacity: 0.9 };
          case "desa": return { color: "#666", weight: 1.5, fill: false, opacity: 0.9 };
          default: return { color: "#000", weight: 1, fill: false };
        }
      }

      async function loadAdminGeojson(key, url, level) {
        var candidates = [url, "data/" + url];
        if(adminLayers[key]) {
           try { map.removeLayer(adminLayers[key]); } catch(e){}
           adminLayers[key] = null;
        }
        for(var i=0; i<candidates.length; i++){
          try {
             var resp = await fetch(candidates[i]);
             if(!resp.ok) continue;
             var gj = await resp.json();
             var layer = L.geoJSON(gj, {
               style: styleFor(level),
               onEachFeature: function(feature, lyr){
                 var props = feature.properties || {};
                 var name = props.WADMKD || props.WADMKC || props.WADMKK || props.WADMPR || props.NAMOBJ || "";
                 lyr.bindTooltip(String(name), {permanent:true, direction:"center", className:"admin-label admin-label-"+level});
               }
             }).addTo(map);
             adminLayers[key] = layer;
             adminLayerLevels[key] = level;
             return layer;
          } catch(e){}
        }
        alert("Gagal memuat layer admin: " + key);
      }

      function keyForLevel(level) {
        if(level === "prov") return "WADMPR";
        if(level === "kab") return "WADMKK";
        if(level === "kec") return "WADMKC";
        return "WADMKD";
      }
      function urlForKey(key) {
        return key + ".geojson";
      }
      function matchName(props) {
        return (props.WADMKD || props.WADMKC || props.WADMKK || props.WADMPR || props.NAMOBJ || "").toString();
      }

      // UI Logic for Admin Search
      (function () {
        var searchContainer = document.getElementById("admin_search_container");
        searchContainer.innerHTML =
          "<b>Search by Administrative</b><br/>" +
          '<label style="display:block;margin-top:6px; font-weight:600;">Level</label>' +
          '<select id="search_admin_level" style="width:100%; padding:6px; box-sizing:border-box">' +
          '<option value="prov">Provinsi</option>' +
          '<option value="kab">Kabupaten/Kota</option>' +
          '<option value="kec">Kecamatan</option>' +
          '<option value="desa">Desa</option>' +
          "</select>" +
          '<label style="display:block;margin-top:8px; font-weight:600;">Nama wilayah</label>' +
          '<div style="position:relative">' +
          '<input id="search_admin_query" type="text" autocomplete="off" placeholder="Masukkan nama..." style="width:100%; padding:6px; box-sizing:border-box" />' +
          '<div id="admin_suggestions" style="position:absolute; left:0; right:0; top:40px; background:#fff; border:1px solid #ddd; max-height:180px; overflow:auto; display:none; z-index:2000;"></div>' +
          "</div>" +
          '<div style="display:flex; gap:8px; margin-top:8px;">' +
          '<button id="btn_admin_search" class="btn">Search</button>' +
          '<button id="btn_admin_clear" class="btn secondary">Clear</button>' +
          "</div>" +
          '<div id="admin_search_results" style="margin-top:8px; max-height:200px; overflow:auto; font-size:13px"></div>';

        var suggestionBox = document.getElementById("admin_suggestions");
        var queryInput = document.getElementById("search_admin_query");
        var highlightLayer = null;

        function searchInLayer(key, q) {
          return new Promise(function (resolve, reject) {
            var layer = adminLayers[key];
            if (!layer) return reject("Layer not loaded");
            var matches = [];
            layer.eachLayer(function (l) {
               var name = matchName(l.feature.properties);
               if (name && name.toLowerCase().indexOf(q.toLowerCase()) !== -1) {
                 matches.push({ name: name, layer: l, feature: l.feature });
               }
            });
            resolve(matches);
          });
        }

        function showResultsList(matches) {
           var container = document.getElementById("admin_search_results");
           container.innerHTML = "";
           if (!matches || matches.length === 0) {
             container.innerHTML = '<div class="small">Tidak ditemukan.</div>';
             return;
           }
           
           // Highlight first match zoom
           if(highlightLayer) map.removeLayer(highlightLayer);
           var fc = { type: "FeatureCollection", features: matches.map(m=>m.feature) };
           highlightLayer = L.geoJSON(fc, { style: {color:"#ff7800", weight:4, fill:false} }).addTo(map);
           try { map.fitBounds(highlightLayer.getBounds()); } catch(e){}

           matches.forEach(function (m, idx) {
             var row = document.createElement("div");
             row.style.padding = "6px";
             row.style.borderBottom = "1px solid #eee";
             row.innerHTML = "<b>" + (idx + 1) + "</b> " + m.name;
             row.onclick = function(){
                var b = L.geoJSON(m.feature).getBounds();
                map.fitBounds(b);
             };
             container.appendChild(row);
           });
        }

        document.getElementById("btn_admin_search").addEventListener("click", function () {
          var level = document.getElementById("search_admin_level").value;
          var q = document.getElementById("search_admin_query").value.trim();
          if (!q) { alert("Masukkan nama wilayah."); return; }
          var key = keyForLevel(level);
          
          if(!adminLayers[key]) {
             loadAdminGeojson(key, urlForKey(key), level).then(function(){
                return searchInLayer(key, q);
             }).then(showResultsList);
          } else {
             searchInLayer(key, q).then(showResultsList);
          }
        });

        document.getElementById("btn_admin_clear").addEventListener("click", function () {
          queryInput.value = "";
          document.getElementById("admin_search_results").innerHTML = "";
          if(highlightLayer) map.removeLayer(highlightLayer);
          Object.values(adminLayers).forEach(l => { if(l) map.removeLayer(l); });
          adminLayers = { WADMPR: null, WADMKK: null, WADMKC: null, WADMKD: null };
        });
      })();
    </script>
  </body>
</html>
