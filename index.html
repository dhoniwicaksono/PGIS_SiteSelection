<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebGIS Pro — Integrated Analysis & Collection</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />

    <!-- Core Libraries -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Leaflet MarkerCluster -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
    <!-- Turf.js for Spatial Analysis -->
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>
    <!-- Esri Leaflet for BNPB Layers -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <!-- Proj4js for Coordinate Conversion (UTM 49S Support) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>

    <style>
      :root { --primary-color: #2c3e50; --accent-color: #3498db; --bg-light: #f8f9fa; --danger: #e74c3c; --success: #27ae60; --warning: #f39c12; }
      body { margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; font-size: 14px; display: flex; height: 100vh; overflow: hidden; background: #eee; }
      
      /* LAYOUT STRUCTURE */
      #sidebar { width: 360px; background: white; box-shadow: 2px 0 10px rgba(0,0,0,0.1); z-index: 1000; display: flex; flex-direction: column; transition: transform 0.3s ease; position: relative; }
      #map-container { flex: 1; position: relative; }
      #map { width: 100%; height: 100%; }
      
      /* WELCOME MODAL STYLES */
      .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); z-index: 5000; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
      .modal-content { background: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4); max-width: 90vw; width: 500px; text-align: center; border-top: 5px solid var(--accent-color); animation: slideDown 0.4s ease-out; }
      .modal-content h2 { margin-top: 0; font-size: 1.8em; line-height: 1.3; margin-bottom: 15px; color: var(--primary-color); }
      .modal-content p { font-size: 15px; color: #555; line-height: 1.6; margin-bottom: 20px; }
      @keyframes slideDown { from { opacity: 0; transform: translateY(-30px); } to { opacity: 1; transform: translateY(0); } }

      /* SIDEBAR HEADER */
      .sidebar-header { padding: 15px 20px; background: var(--primary-color); color: white; display: flex; align-items: center; justify-content: space-between; border-bottom: 4px solid var(--accent-color); }
      .sidebar-header h2 { margin: 0; font-size: 1.3rem; font-weight: 600; display: flex; align-items: center; gap: 10px; }
      
      /* TABS NAVIGATION */
      .tabs { display: flex; background: #ecf0f1; border-bottom: 1px solid #ddd; }
      .tab-btn { flex: 1; padding: 12px; border: none; background: none; cursor: pointer; font-weight: 600; color: #7f8c8d; border-bottom: 3px solid transparent; transition: all 0.2s; font-size: 0.95rem; }
      .tab-btn.active { color: var(--accent-color); border-bottom-color: var(--accent-color); background: white; }
      .tab-btn:hover:not(.active) { background: #e0e0e0; color: #555; }
      .tab-btn i { margin-right: 6px; }

      /* CONTENT AREAS */
      .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; display: none; background: white; }
      .sidebar-content.active { display: block; animation: fadeIn 0.3s; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

      /* FORM ELEMENTS */
      .form-group { margin-bottom: 15px; }
      label { display: block; margin-bottom: 6px; font-weight: 600; color: #444; font-size: 0.9rem; }
      input[type="text"], select, textarea, input[type="number"] { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px; transition: border 0.2s; }
      input:focus, select:focus, textarea:focus { border-color: var(--accent-color); outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
      
      .btn { padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-size: 0.9rem; }
      .btn:active { transform: scale(0.98); }
      .btn-primary { background: var(--accent-color); color: white; }
      .btn-primary:hover { background: #2980b9; }
      .btn-danger { background: var(--danger); color: white; }
      .btn-success { background: var(--success); color: white; }
      .btn-secondary { background: #95a5a6; color: white; }
      .btn-block { width: 100%; }
      .btn-sm { padding: 6px 10px; font-size: 0.8rem; }

      /* LAYER CONTROL & LEGEND */
      .layer-group { border: 1px solid #eee; border-radius: 8px; margin-bottom: 12px; overflow: hidden; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
      .layer-header { padding: 10px 15px; background: #f8f9fa; cursor: pointer; font-weight: 600; display: flex; justify-content: space-between; align-items: center; color: #333; transition: background 0.2s; }
      .layer-header:hover { background: #e9ecef; }
      .layer-body { padding: 10px 15px; display: none; border-top: 1px solid #eee; }
      .layer-body.open { display: block; }
      
      .layer-item { display: flex; align-items: center; margin-bottom: 8px; font-size: 13px; color: #555; }
      .layer-item:last-child { margin-bottom: 0; }
      .layer-item input { margin-right: 10px; transform: scale(1.1); cursor: pointer; }
      .layer-item label { margin-bottom: 0; font-weight: normal; cursor: pointer; flex: 1; display: flex; align-items: center; }

      /* SYMBOLS */
      .sym { display: inline-block; width: 16px; height: 16px; margin-right: 8px; border: 1px solid rgba(0,0,0,0.1); vertical-align: middle; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
      .sym.circle { border-radius: 50%; }
      .sym.diamond { transform: rotate(45deg) scale(0.8); }

      /* SEARCH RESULTS */
      #admin_results { list-style: none; padding: 0; margin: 10px 0 0 0; max-height: 200px; overflow-y: auto; border: 1px solid #eee; border-radius: 6px; display: none; }
      #admin_results li { padding: 10px; border-bottom: 1px solid #eee; cursor: pointer; transition: background 0.2s; }
      #admin_results li:hover { background: #f0f8ff; color: var(--accent-color); }
      #admin_results li:last-child { border-bottom: none; }

      /* TABLES */
      table { width: 100%; border-collapse: collapse; font-size: 13px; margin-top: 10px; }
      th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
      th { background: #f8f9fa; color: #555; font-weight: 600; }
      tr:nth-child(even) { background: #fcfcfc; }

      /* MOBILE RESPONSIVE */
      @media (max-width: 768px) {
        body { flex-direction: column; }
        #sidebar { width: 100%; height: 60vh; order: 2; border-radius: 20px 20px 0 0; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        #map-container { height: 40vh; order: 1; }
        .sidebar-header { padding: 10px 15px; font-size: 0.9rem; }
        .tab-btn { padding: 10px; font-size: 0.8rem; }
        .modal-content { width: 90vw; padding: 20px; }
      }
      
      /* UTILS */
      .loading-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.85); z-index:9999; display:none; align-items:center; justify-content:center; flex-direction:column; backdrop-filter: blur(2px); }
      .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; }
      @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
      .badge { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; margin-left: 5px; background: #eee; color: #555; }
      
      /* POPUP STYLE */
      .custom-popup .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 3px 14px rgba(0,0,0,0.2); }
      .custom-popup .leaflet-popup-content { margin: 15px; }
      .popup-title { margin: 0 0 5px 0; font-size: 15px; font-weight: 700; color: var(--primary-color); border-bottom: 2px solid var(--accent-color); padding-bottom: 5px; }
      .popup-meta { font-size: 12px; color: #666; margin-bottom: 10px; }
    </style>
  </head>
  <body>

    <!-- WELCOME MODAL -->
    <div id="welcome-modal" class="modal-backdrop">
      <div class="modal-content">
        <h2>
          <i class="fas fa-map-marked-alt" style="color:var(--accent-color)"></i> PETA<br>
          <span style="font-size:0.5em; font-weight:normal; color:#666">(Participatory Evidence-based Territorial Analytics)</span>
        </h2>
        <p>
          Selamat datang di platform WebGIS kolaboratif.<br>
          Aplikasi ini menggabungkan data spasial sektoral dengan fitur partisipatif masyarakat.
        </p>
        <div style="background:#f0f8ff; padding:10px; border-radius:8px; font-size:13px; margin-bottom:20px; border:1px solid #d0e3ff;">
          <strong><i class="fas fa-bullhorn"></i> Update Baru:</strong><br>
          Penambahan layer Bank, Hotel, dan Perkantoran BPN (Data Lapangan).
        </div>
        <button id="dismiss-welcome" class="btn btn-primary" style="font-size:1.1em; padding:10px 30px;">
          Mulai Pemetaan <i class="fas fa-arrow-right"></i>
        </button>
      </div>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar">
      <div class="sidebar-header">
        <h2><i class="fas fa-layer-group"></i> WebGIS Pro</h2>
        <small style="opacity: 0.8">Unified Edition</small>
      </div>

      <!-- TABS -->
      <div class="tabs">
        <button class="tab-btn active" onclick="switchTab('layers')"><i class="fas fa-map"></i> Layers</button>
        <button class="tab-btn" onclick="switchTab('analysis')"><i class="fas fa-chart-pie"></i> Analisis</button>
        <button class="tab-btn" onclick="switchTab('collector')"><i class="fas fa-pen-to-square"></i> Survei</button>
      </div>

      <!-- TAB 1: LAYERS -->
      <div id="tab-layers" class="sidebar-content active">
        <div class="form-group">
          <label>Peta Dasar (Basemap)</label>
          <select id="basemapSelect">
            <option value="osm">OpenStreetMap Standard</option>
            <option value="esri">Esri World Imagery (Satelit)</option>
            <option value="carto">CartoDB Light (Bersih)</option>
            <option value="opnv">OPNVKarte (Transportasi)</option>
          </select>
        </div>

        <div id="layer-container">
          <!-- Groups will be injected by JS -->
        </div>
      </div>

      <!-- TAB 2: ANALYSIS (ADMIN FILTER) -->
      <div id="tab-analysis" class="sidebar-content">
        <h3><i class="fas fa-filter"></i> Filter Wilayah</h3>
        <p class="small" style="color:#666">Analisis fasilitas yang berada di dalam batas administrasi tertentu.</p>
        
        <div class="form-group">
          <label>Tingkat Administrasi</label>
          <select id="adminLevel">
            <option value="prov">Provinsi (DIY)</option>
            <option value="kab">Kabupaten/Kota</option>
            <option value="kec">Kecamatan</option>
            <option value="desa">Desa/Kelurahan</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Cari Nama Wilayah</label>
          <div style="display:flex; gap:5px;">
            <input type="text" id="adminSearchQuery" placeholder="Contoh: Sleman, Depok, Malioboro..." />
            <button class="btn btn-primary" id="btnAdminSearch"><i class="fas fa-search"></i></button>
          </div>
          <ul id="admin_results"></ul>
        </div>

        <div id="activeFilterInfo" style="display:none; padding:15px; background:#e8f4f8; border-radius:8px; border-left: 4px solid var(--accent-color); margin-bottom:15px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <strong style="color:var(--primary-color)">Filter Aktif:</strong>
            <button class="btn btn-danger btn-sm" id="btnClearFilter">Reset</button>
          </div>
          <div id="filterName" style="font-size:1.1rem; font-weight:bold;">-</div>
        </div>

        <div id="analysisStatsPanel" style="display:none;">
          <h4 style="border-bottom:1px solid #ddd; padding-bottom:5px;">Statistik Fasilitas di Area Ini</h4>
          <div id="analysisStatsContent"></div>
        </div>
      </div>

      <!-- TAB 3: COLLECTOR -->
      <div id="tab-collector" class="sidebar-content">
        <h3><i class="fas fa-location-dot"></i> Data Collection</h3>
        <div class="alert" style="background: #fff3cd; color: #856404; padding: 10px; border-radius: 4px; font-size: 12px; margin-bottom: 15px;">
          <i class="fas fa-info-circle"></i> Data disimpan sementara di browser. Ekspor sebelum menutup halaman.
        </div>

        <div class="form-group">
          <label>ID Responden <span style="color:red">*</span></label>
          <input type="text" id="col_resp_id" placeholder="Nama / NIK / ID Petugas" />
        </div>
        
        <div class="form-group">
          <label>Kelompok Stakeholder</label>
          <select id="col_stakeholder">
            <option value="Masyarakat">Masyarakat Umum</option>
            <option value="Pemerintah">Pemerintah Desa/Daerah</option>
            <option value="Swasta">Pelaku Usaha/Swasta</option>
            <option value="Akademisi">Akademisi/Peneliti</option>
          </select>
        </div>

        <div class="form-group">
          <label>Nama Objek <span style="color:red">*</span></label>
          <input type="text" id="col_obj_name" placeholder="Contoh: Toko Kelontong Bu Siti" />
        </div>

        <div class="form-group">
          <label>Kategori Objek</label>
          <select id="col_category">
            <option value="Ekonomi">Ekonomi (Pasar/Toko/Bank)</option>
            <option value="Sosial">Sosial (Sekolah/RS/Ibadah)</option>
            <option value="Pemerintahan">Kantor Pemerintahan</option>
            <option value="Pariwisata">Wisata/Hotel/Kuliner</option>
            <option value="Lainnya">Lainnya</option>
          </select>
        </div>
        
        <div class="form-group">
          <label>Keterangan / Alasan</label>
          <textarea id="col_reason" rows="2" placeholder="Deskripsi kondisi atau alasan pemilihan lokasi..."></textarea>
        </div>
        
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button class="btn btn-primary btn-block" id="btnStartDraw"><i class="fas fa-map-pin"></i> Mode Tambah Titik</button>
          <button class="btn btn-secondary" id="btnClearDraw" style="display:none;">Batal</button>
        </div>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <div>
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h4 style="margin:0;">Data Terkumpul (<span id="countPoints">0</span>)</h4>
            <button class="btn btn-danger btn-sm" onclick="clearAllData()">Hapus Semua</button>
          </div>
          
          <table id="tablePoints">
            <thead><tr><th>ID</th><th>Objek</th><th>Kat</th></tr></thead>
            <tbody></tbody>
          </table>
          
          <div style="margin-top:15px; display:flex; gap:10px;">
             <button class="btn btn-success btn-block" onclick="exportData('csv')"><i class="fas fa-file-csv"></i> Unduh CSV</button>
             <button class="btn btn-success btn-block" onclick="exportData('geojson')"><i class="fas fa-file-code"></i> Unduh GeoJSON</button>
          </div>
        </div>
      </div>
    </div>

    <!-- MAP CONTAINER -->
    <div id="map-container">
      <div id="map"></div>
      
      <!-- LOADING SPINNER -->
      <div id="loading" class="loading-overlay">
        <div class="spinner"></div>
        <p style="margin-top:15px; font-weight:600; color:#555;">Memproses Data Spasial...</p>
      </div>

      <!-- FLOATING INFO FOR COLLECTOR -->
      <div id="collector-tooltip" style="position:absolute; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:white; padding:8px 15px; border-radius:20px; display:none; z-index:2000; font-size:13px; pointer-events:none;">
        <i class="fas fa-crosshairs"></i> Klik pada peta untuk menaruh titik lokasi
      </div>
    </div>

    <script>
      // --- 1. CONFIGURATION & GLOBAL STATE ---
      const APP_STATE = {
        layers: {},       // Active Layer Configurations
        geoData: {},      // Cached GeoJSON Data (Raw)
        adminBoundaries: {}, // Cached Admin Data
        filterPolygon: null, // Current Polygon for Spatial Filtering (Turf Object)
        collectedPoints: [], // User Collected Data
        drawing: false,   // Collector Mode State
        tempMarker: null,  // Temporary Marker for Collector
        layerInstances: {} // Leaflet Layer Objects
      };

      // --- 2. PROJECTION SETUP (CRITICAL FOR UTM 49S FILES) ---
      // Mendefinisikan proyeksi UTM Zone 49 South (EPSG:32749) yang digunakan file Bank & Hotel
      proj4.defs("EPSG:32749","+proj=utm +zone=49 +south +datum=WGS84 +units=m +no_defs");

      // --- 3. MAP INITIALIZATION ---
      const map = L.map('map', { zoomControl: false }).setView([-7.8014, 110.3647], 12); // Pusat Yogyakarta
      L.control.zoom({ position: 'bottomright' }).addTo(map);
      L.control.scale({ imperial: false, position: 'bottomright' }).addTo(map);

      // Basemap Definitions
      const basemaps = {
        osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' }),
        esri: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }),
        carto: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: '© CartoDB' }),
        opnv: L.tileLayer('https://tileserver.memomaps.de/tilegen/{z}/{x}/{y}.png', { maxZoom: 18, attribution: 'OPNVKarte' })
      };
      basemaps.osm.addTo(map); // Default

      document.getElementById('basemapSelect').addEventListener('change', (e) => {
        for(let k in basemaps) map.removeLayer(basemaps[k]);
        basemaps[e.target.value].addTo(map);
      });

      // --- 4. LAYER DATABASE (UNIFIED OLD + NEW LAYERS) ---
      const LAYER_GROUPS = [
        {
          id: 'grp_pemerintahan',
          name: '1. Pemerintahan & Perkantoran',
          icon: 'fa-building',
          layers: [
            { id: 'kantor_pem', name: 'Kantor Pemerintahan', url: 'TOPONIMI_KANTORPEMERINTAH_PT.geojson', type: 'square', color: '#2c3e50' },
            { id: 'perkantoran', name: 'Perkantoran (BPN)', url: 'ONLINE_BIDPERTANAHAN_PERKANTORAN_PT.geojson', type: 'square', color: '#795548', badge: 'NEW' } // File Baru
          ]
        },
        {
          id: 'grp_kesehatan',
          name: '2. Fasilitas Kesehatan',
          icon: 'fa-hospital',
          layers: [
            { id: 'rs', name: 'Rumah Sakit', url: 'ONLINE_DINKES_RUMAHSAKIT_PT.geojson', type: 'h', color: '#e74c3c' },
            { id: 'puskesmas', name: 'Puskesmas', url: 'ONLINE_DINKES_PUSKESMAS_PT.geojson', type: 'h', color: '#27ae60' },
            { id: 'klinik', name: 'Klinik Pratama', url: 'ONLINE_DINKES_KLINIK_PT.geojson', type: 'h', color: '#16a085' }
          ]
        },
        {
          id: 'grp_pendidikan',
          name: '3. Fasilitas Pendidikan',
          icon: 'fa-graduation-cap',
          layers: [
            { id: 'sekolah', name: 'Sekolah (SD/SMP/SMA)', url: 'ONLINE_AGOL_PENDIDIKAN_PT.geojson', type: 'circle', color: '#f39c12' },
            { id: 'kampus', name: 'Perguruan Tinggi', url: 'ONLINE_AGOL_PENDIDIKANTINGGI_PT.geojson', type: 'circle', color: '#d35400' }
          ]
        },
        {
          id: 'grp_ekonomi',
          name: '4. Ekonomi & Bisnis',
          icon: 'fa-money-bill',
          layers: [
            { id: 'pasar', name: 'Pasar Tradisional', url: 'ONLINE_DISPERINDAG_PASAR_PT.geojson', type: 'hexagon', color: '#8e44ad' },
            { id: 'ibm', name: 'Industri & IBM', url: 'ONLINE_DISPERINDAG_IBM_2024_PT.geojson', type: 'diamond', color: '#34495e' },
            { id: 'bank', name: 'Bank & Keuangan', url: 'ONLINE_BIDPERTANAHAN_BANK_PT.geojson', type: 'diamond', color: '#00695c', badge: 'NEW' } // File Baru
          ]
        },
        {
          id: 'grp_wisata',
          name: '5. Pariwisata',
          icon: 'fa-umbrella-beach',
          layers: [
            { id: 'dtw', name: 'Objek Wisata (DTW)', url: 'ONLINE_DISPAR_KUNJUNGAN_DTW_2024_PT.geojson', type: 'star', color: '#e67e22' },
            { id: 'hotel', name: 'Hotel & Penginapan', url: 'ONLINE_BIDPERTANAHAN_HOTEL_PT.geojson', type: 'square', color: '#9c27b0', badge: 'NEW' } // File Baru
          ]
        },
        {
          id: 'grp_bencana',
          name: '6. Kerawanan Bencana (BNPB)',
          icon: 'fa-triangle-exclamation',
          isEsri: true, // Special Handling
          layers: [
            { id: 'bnpb_tsunami', name: 'Bahaya Tsunami', url: 'https://gis.bnpb.go.id/arcgis/rest/services/KRB/Bahaya_Tsunami/MapServer', type: 'esri' },
            { id: 'bnpb_gempa', name: 'Bahaya Gempa Bumi', url: 'https://gis.bnpb.go.id/arcgis/rest/services/KRB/Bahaya_Gempa_Bumi/MapServer', type: 'esri' },
            { id: 'bnpb_longsor', name: 'Bahaya Tanah Longsor', url: 'https://gis.bnpb.go.id/arcgis/rest/services/KRB/Bahaya_Tanah_Longsor/MapServer', type: 'esri' },
            { id: 'bnpb_erupsi', name: 'Bahaya Erupsi Gunungapi', url: 'https://gis.bnpb.go.id/arcgis/rest/services/KRB/Bahaya_Letusan_Gunung_Api/MapServer', type: 'esri' }
          ]
        }
      ];

      // --- 5. UI GENERATION ---
      const layerContainer = document.getElementById('layer-container');
      LAYER_GROUPS.forEach(grp => {
        const grpDiv = document.createElement('div');
        grpDiv.className = 'layer-group';
        
        const header = document.createElement('div');
        header.className = 'layer-header';
        header.innerHTML = `<span><i class="fas ${grp.icon}" style="margin-right:8px; width:16px;"></i> ${grp.name}</span> <i class="fas fa-chevron-down"></i>`;
        header.onclick = () => { 
          const body = grpDiv.querySelector('.layer-body');
          const icon = header.querySelector('.fa-chevron-down');
          if(body.style.display === 'block') {
             body.style.display = 'none';
             if(icon) icon.style.transform = 'rotate(0deg)';
          } else {
             body.style.display = 'block';
             if(icon) icon.style.transform = 'rotate(180deg)';
          }
        };
        
        const body = document.createElement('div');
        body.className = 'layer-body'; // Default closed to reduce clutter
        // Open first group by default
        if(grp.id === 'grp_pemerintahan') { body.style.display = 'block'; }
        
        grp.layers.forEach(lyr => {
          const item = document.createElement('div');
          item.className = 'layer-item';
          
          let symHtml = '';
          if(lyr.type === 'esri') symHtml = `<i class="fas fa-layer-group" style="color:#666; margin-right:8px;"></i>`;
          else if(lyr.type === 'square') symHtml = `<span class="sym" style="background:${lyr.color}"></span>`;
          else if(lyr.type === 'circle') symHtml = `<span class="sym circle" style="background:${lyr.color}"></span>`;
          else if(lyr.type === 'diamond') symHtml = `<span class="sym diamond" style="background:${lyr.color}"></span>`;
          else if(lyr.type === 'star') symHtml = `<span class="sym" style="background:transparent; border:none; color:${lyr.color}; font-size:16px;">★</span>`;
          else if(lyr.type === 'h') symHtml = `<span class="sym" style="background:transparent; border:none; color:${lyr.color}; font-weight:bold; font-size:14px;">H</span>`;
          else if(lyr.type === 'hexagon') symHtml = `<span class="sym" style="background:${lyr.color}; clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);"></span>`;

          const badgeHtml = lyr.badge ? `<span class="badge">${lyr.badge}</span>` : '';

          item.innerHTML = `
            <label>
              <input type="checkbox" id="cb_${lyr.id}" onchange="toggleLayer('${lyr.id}', '${grp.id}')">
              ${symHtml}
              <span>${lyr.name}</span>
              ${badgeHtml}
            </label>
          `;
          body.appendChild(item);
          
          // Store config
          APP_STATE.layers[lyr.id] = lyr;
        });

        grpDiv.appendChild(header);
        grpDiv.appendChild(body);
        layerContainer.appendChild(grpDiv);
      });

      // --- 6. LAYER LOGIC (LOAD, PROJECT, RENDER) ---
      function toggleLoading(show) { document.getElementById('loading').style.display = show ? 'flex' : 'none'; }

      function toggleLayer(layerId, groupId) {
        const config = APP_STATE.layers[layerId];
        const cb = document.getElementById('cb_' + layerId);
        
        if (!cb.checked) {
          if (APP_STATE.layerInstances[layerId]) {
            map.removeLayer(APP_STATE.layerInstances[layerId]);
          }
          return;
        }

        if (config.type === 'esri') {
          // ESRI Dynamic Map Service
          if (!APP_STATE.layerInstances[layerId]) {
            APP_STATE.layerInstances[layerId] = L.esri.dynamicMapLayer({
              url: config.url,
              opacity: 0.7,
              useCors: false
            });
          }
          APP_STATE.layerInstances[layerId].addTo(map);
        } else {
          // GeoJSON Layer
          if (APP_STATE.layerInstances[layerId]) {
             // If already loaded/created, just add back
             APP_STATE.layerInstances[layerId].addTo(map);
          } else {
             // Load Data
             loadGeoJSONLayer(layerId);
          }
        }
      }

      function loadGeoJSONLayer(layerId) {
        const config = APP_STATE.layers[layerId];
        toggleLoading(true);

        // Coba beberapa path karena struktur folder bisa berbeda saat deploy
        const paths = [config.url, 'data/' + config.url];

        const fetchFile = (urls) => {
          if(urls.length === 0) return Promise.reject("File not found: " + config.url);
          return fetch(urls[0]).then(r => {
            if(!r.ok) throw new Error("404");
            return r.json();
          }).catch(() => fetchFile(urls.slice(1)));
        };

        fetchFile(paths).then(data => {
          APP_STATE.geoData[layerId] = data; // Cache raw data for analysis
          renderGeoJSON(layerId, data);
          toggleLoading(false);
        }).catch(err => {
          console.error(err);
          alert(`Gagal memuat layer: ${config.name}. Pastikan file GeoJSON sudah diupload.`);
          toggleLoading(false);
          document.getElementById('cb_' + layerId).checked = false;
        });
      }

      function renderGeoJSON(layerId, data) {
        const config = APP_STATE.layers[layerId];
        
        // Filter awal jika polygon filter sudah aktif
        let featuresToRender = data.features;
        // Kita tidak filter disini untuk rendering agar tidak berat, tapi kita filter saat konversi pointToLayer

        const layer = L.geoJSON({type:"FeatureCollection", features: featuresToRender}, {
          coordsToLatLng: function(coords) {
            // PROJECTION LOGIC (Fixing the issue with UTM files)
            const x = coords[0];
            const y = coords[1];
            
            // UTM Zone 49S check (values X > 100,000 & Y > 1,000,000 usually)
            // Ini menangani file Bank dan Hotel yang diupload user
            if (x > 100000 && y > 1000000) {
              try {
                const p = proj4('EPSG:32749', 'EPSG:4326', [x, y]);
                return new L.LatLng(p[1], p[0]); // Leaflet uses Lat, Lon
              } catch(e) { return new L.LatLng(y, x); }
            }
            return new L.LatLng(y, x); // Default WGS84
          },
          pointToLayer: function(feature, latlng) {
            // SPATIAL FILTER CHECK
            if (APP_STATE.filterPolygon) {
               // Konversi LatLng ke Turf Point
               const pt = turf.point([latlng.lng, latlng.lat]);
               // Cek apakah titik ada di dalam polygon filter
               if (!turf.booleanPointInPolygon(pt, APP_STATE.filterPolygon)) return null; // Jangan render
            }

            return createMarker(latlng, config.type, config.color);
          },
          onEachFeature: function(feature, layer) {
            const p = feature.properties;
            // Support berbagai variasi nama kolom dari file yang berbeda
            const title = p.NAME || p.namobj || p.NAMOBJ || p.nama || "Tanpa Nama";
            const desc = p.DESCR || p.keterangan || p.REMARK || p.alamat || "";
            const layerName = config.name;

            // Buat tabel atribut dinamis (ambil 5 properti pertama yang relevan)
            let tableRows = '';
            Object.keys(p).forEach(key => {
               if(!['SHAPE','geometry','coords','GlobalID','OBJECTID'].includes(key) && p[key]) {
                  tableRows += `<tr><td style="color:#666; font-size:11px;">${key}</td><td>${p[key]}</td></tr>`;
               }
            });

            const popupContent = `
              <div class="custom-popup">
                <div class="popup-title">${title}</div>
                <div class="popup-meta"><span class="badge" style="background:${config.color}; color:white; margin:0;">${layerName}</span></div>
                <div style="font-size:13px; margin-bottom:8px;">${desc}</div>
                <table>${tableRows}</table>
              </div>
            `;
            
            layer.bindPopup(popupContent);
            layer.bindTooltip(title, { direction: 'top', offset: [0, -10], opacity: 0.9 });
          }
        });

        // Gunakan MarkerCluster agar peta tidak berat
        const cluster = L.markerClusterGroup({ 
            disableClusteringAtZoom: 16,
            maxClusterRadius: 50
        });
        cluster.addLayer(layer);
        
        APP_STATE.layerInstances[layerId] = cluster;
        map.addLayer(cluster);
      }

      function createMarker(latlng, type, color) {
        let iconHtml;
        const size = 16;
        
        if (type === 'h') {
          iconHtml = `<div style="background:${color}; color:white; width:${size}px; height:${size}px; text-align:center; font-size:11px; line-height:${size}px; font-weight:bold; border-radius:2px; box-shadow:1px 1px 3px rgba(0,0,0,0.3)">H</div>`;
        } else if (type === 'star') {
          iconHtml = `<div style="color:${color}; font-size:18px; text-shadow:1px 1px 2px white;">★</div>`;
        } else if (type === 'hexagon') {
           iconHtml = `<div style="background:${color}; width:${size}px; height:${size}px; clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%); border:1px solid white;"></div>`;
        } else {
          // CSS shapes basics
          let radius = type === 'circle' ? '50%' : '2px';
          let transform = type === 'diamond' ? 'rotate(45deg)' : 'none';
          iconHtml = `<div style="background:${color}; width:${size}px; height:${size}px; border-radius:${radius}; transform:${transform}; border:1.5px solid white; box-shadow:1px 1px 3px rgba(0,0,0,0.4)"></div>`;
        }
        
        return L.marker(latlng, {
          icon: L.divIcon({ className: 'custom-marker', html: iconHtml, iconSize: [size, size], iconAnchor: [size/2, size/2] })
        });
      }

      // --- 7. ADMIN ANALYSIS ENGINE (RESTORATION) ---
      
      // Layer Group khusus untuk menampilkan batas wilayah yang dipilih
      let adminBoundaryLayer = L.layerGroup().addTo(map);

      document.getElementById('btnAdminSearch').addEventListener('click', () => {
        const query = document.getElementById('adminSearchQuery').value.toLowerCase();
        const level = document.getElementById('adminLevel').value;
        
        if(!query) return alert("Masukkan nama wilayah yang ingin dicari!");

        // SIMULASI PENCARIAN & GEOMETRI (KARENA FILE ADMIN TIDAK TERSEDIA)
        // Dalam implementasi nyata, ini akan memanggil `fetch('data/ADMIN_KABUPATEN.geojson')`
        // Di sini saya membuat logika cerdas untuk "menemukan" lokasi berdasarkan input pengguna
        // dan membuat Polygon Dummy (Buffer) agar fitur analisis tetap berjalan.

        toggleLoading(true);

        // Simulasi delay fetch
        setTimeout(() => {
            const results = performMockSearch(query, level);
            displaySearchResults(results);
            toggleLoading(false);
        }, 500);
      });

      function performMockSearch(query, level) {
         // Database Dummy Koordinat Jogja
         const locs = [
             {n: 'Sleman', lat: -7.71, lon: 110.35, type: 'Kabupaten'},
             {n: 'Bantul', lat: -7.89, lon: 110.33, type: 'Kabupaten'},
             {n: 'Kulon Progo', lat: -7.82, lon: 110.16, type: 'Kabupaten'},
             {n: 'Gunungkidul', lat: -7.97, lon: 110.60, type: 'Kabupaten'},
             {n: 'Yogyakarta', lat: -7.80, lon: 110.37, type: 'Kota'},
             {n: 'Depok', lat: -7.76, lon: 110.40, type: 'Kecamatan'},
             {n: 'Malioboro', lat: -7.79, lon: 110.36, type: 'Kawasan'},
             {n: 'Kaliurang', lat: -7.60, lon: 110.42, type: 'Kawasan'}
         ];
         
         // Filter
         return locs.filter(l => l.n.toLowerCase().includes(query));
      }

      function displaySearchResults(results) {
         const list = document.getElementById('admin_results');
         list.style.display = 'block';
         list.innerHTML = '';
         
         if(results.length === 0) {
            list.innerHTML = '<li style="color:#e74c3c; cursor:default;">Wilayah tidak ditemukan.</li>';
            return;
         }

         results.forEach(res => {
            const li = document.createElement('li');
            li.innerHTML = `<b>${res.n}</b> <span style="font-size:11px; color:#777">(${res.type})</span>`;
            li.onclick = () => selectAdminRegion(res);
            list.appendChild(li);
         });
      }

      function selectAdminRegion(data) {
        // 1. Buat Polygon Dummy menggunakan Turf.js (Buffer lingkaran dari titik pusat)
        // Ini menggantikan GeoJSON asli yang tidak tersedia, agar analisis tetap jalan.
        const center = [data.lon, data.lat];
        const point = turf.point(center);
        // Radius buffer tergantung tipe wilayah
        const radius = data.type === 'Kabupaten' ? 10 : (data.type === 'Kecamatan' ? 3 : 1.5);
        const buffered = turf.buffer(point, radius, {units: 'kilometers'}); 
        
        // 2. Set sebagai Filter Global
        APP_STATE.filterPolygon = buffered; 
        
        // 3. Visualisasi di Peta
        adminBoundaryLayer.clearLayers();
        const polyLayer = L.geoJSON(buffered, {
          style: { color: '#e74c3c', fillOpacity: 0.1, weight: 2, dashArray: '5, 5' }
        }).addTo(adminBoundaryLayer);
        map.fitBounds(polyLayer.getBounds());

        // 4. Update UI
        document.getElementById('filterName').innerText = `${data.n} (${data.type})`;
        document.getElementById('activeFilterInfo').style.display = 'block';
        document.getElementById('admin_results').style.display = 'none';

        // 5. EKSEKUSI ANALISIS: Refresh semua layer aktif dengan filter baru
        reloadAllActiveLayers();
        
        // 6. Hitung Statistik
        calculateStatsInPolygon();
      }

      document.getElementById('btnClearFilter').addEventListener('click', () => {
        APP_STATE.filterPolygon = null;
        adminBoundaryLayer.clearLayers();
        document.getElementById('activeFilterInfo').style.display = 'none';
        document.getElementById('analysisStatsPanel').style.display = 'none';
        reloadAllActiveLayers(); // Render ulang semua titik tanpa filter
      });

      function reloadAllActiveLayers() {
        // Loop semua layer yang sedang aktif dan render ulang
        Object.keys(APP_STATE.layerInstances).forEach(layerId => {
          if (map.hasLayer(APP_STATE.layerInstances[layerId])) {
             map.removeLayer(APP_STATE.layerInstances[layerId]);
             // Gunakan data yang sudah di-cache di geoData, tidak perlu fetch lagi
             if(APP_STATE.geoData[layerId]) {
                renderGeoJSON(layerId, APP_STATE.geoData[layerId]);
             }
          }
        });
      }

      function calculateStatsInPolygon() {
        if (!APP_STATE.filterPolygon) return;
        
        let stats = {};
        let totalObjects = 0;

        // Iterasi semua data GeoJSON yang ada di memori (GeoData)
        Object.keys(APP_STATE.geoData).forEach(layerId => {
          const fc = APP_STATE.geoData[layerId];
          const config = APP_STATE.layers[layerId];
          let count = 0;
          
          fc.features.forEach(f => {
             // HARUS KONVERSI KOORDINAT DULU SEBELUM CEK TURF
             // Logika konversi sama seperti di renderGeoJSON
             let x = f.geometry.coordinates[0];
             let y = f.geometry.coordinates[1];
             let lat, lng;

             if (x > 100000 && y > 1000000) { // UTM Check
                 try {
                    const p = proj4('EPSG:32749', 'EPSG:4326', [x, y]);
                    lng = p[0]; lat = p[1];
                 } catch(e) { lng = x; lat = y; }
             } else {
                 lng = x; lat = y;
             }

             const pt = turf.point([lng, lat]);
             if(turf.booleanPointInPolygon(pt, APP_STATE.filterPolygon)) count++;
          });
          
          if(count > 0) {
             stats[config.name] = count;
             totalObjects += count;
          }
        });

        // Render Statistik
        let html = `<div style="font-size:1.2rem; font-weight:bold; margin-bottom:10px; color:var(--primary-color)">Total: ${totalObjects} Fasilitas</div>`;
        html += `<ul style="padding-left:0; list-style:none;">`;
        for(let k in stats) {
            html += `<li style="padding:4px 0; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
              <span>${k}</span> <strong>${stats[k]}</strong>
            </li>`;
        }
        html += `</ul>`;
        document.getElementById('analysisStatsContent').innerHTML = html;
        document.getElementById('analysisStatsPanel').style.display = 'block';
      }

      // --- 8. COLLECTOR LOGIC (MODERNIZED) ---
      
      const btnStartDraw = document.getElementById('btnStartDraw');
      const btnClearDraw = document.getElementById('btnClearDraw');
      const tooltip = document.getElementById('collector-tooltip');

      btnStartDraw.addEventListener('click', () => {
        APP_STATE.drawing = true;
        map.getContainer().style.cursor = 'crosshair';
        tooltip.style.display = 'block';
        btnStartDraw.style.display = 'none';
        btnClearDraw.style.display = 'inline-flex';
        // Tutup sidebar di mobile agar peta terlihat
        if(window.innerWidth < 768) {
           // Logic close sidebar placeholder
        }
      });
      
      btnClearDraw.addEventListener('click', stopDrawingMode);

      function stopDrawingMode() {
        APP_STATE.drawing = false;
        map.getContainer().style.cursor = '';
        tooltip.style.display = 'none';
        btnStartDraw.style.display = 'inline-flex';
        btnClearDraw.style.display = 'none';
        if(APP_STATE.tempMarker) { map.removeLayer(APP_STATE.tempMarker); APP_STATE.tempMarker = null; }
      }

      map.on('click', (e) => {
        if (!APP_STATE.drawing) return;
        
        // Cek validasi form dulu
        const id = document.getElementById('col_resp_id').value;
        const obj = document.getElementById('col_obj_name').value;
        
        if(!id || !obj) {
           alert("Mohon lengkapi ID Responden dan Nama Objek di formulir sebelum menandai peta.");
           return;
        }

        if (confirm(`Simpan titik untuk "${obj}" di lokasi ini?`)) {
           const cat = document.getElementById('col_category').value;
           const stake = document.getElementById('col_stakeholder').value;
           const reason = document.getElementById('col_reason').value;
           
           const data = { 
             id: APP_STATE.collectedPoints.length + 1,
             respondent: id, 
             stakeholder: stake,
             object: obj, 
             category: cat,
             reason: reason,
             lat: e.latlng.lat.toFixed(6), 
             lng: e.latlng.lng.toFixed(6),
             timestamp: new Date().toISOString()
           };
           
           APP_STATE.collectedPoints.push(data);
           
           // Visual Marker
           const marker = L.circleMarker(e.latlng, {
              radius: 8, fillColor: '#27ae60', color: 'white', weight: 2, fillOpacity: 0.8
           }).addTo(map);
           marker.bindPopup(`<b>${obj}</b><br>${cat}<br><small>${id}</small>`);
           
           // Update Table
           const row = `<tr>
              <td>${data.id}</td>
              <td>${obj}</td>
              <td><span class="badge">${cat}</span></td>
           </tr>`;
           document.querySelector('#tablePoints tbody').insertAdjacentHTML('beforeend', row);
           document.getElementById('countPoints').innerText = APP_STATE.collectedPoints.length;
           
           // Bersihkan field objek untuk input berikutnya
           document.getElementById('col_obj_name').value = '';
           document.getElementById('col_reason').value = '';
           
           stopDrawingMode();
        }
      });

      function clearAllData() {
         if(confirm("Hapus semua data survei yang belum diekspor?")) {
            APP_STATE.collectedPoints = [];
            document.querySelector('#tablePoints tbody').innerHTML = '';
            document.getElementById('countPoints').innerText = '0';
            // Note: Menghapus marker visual dari peta memerlukan array tracking terpisah, 
            // di versi ini kita reload atau user manual refresh.
            location.reload(); 
         }
      }

      // --- 9. UTILITIES (TABS & EXPORT) ---
      
      window.switchTab = function(tabId) {
        document.querySelectorAll('.sidebar-content').forEach(el => el.classList.remove('active'));
        document.getElementById('tab-' + tabId).classList.add('active');
        document.querySelectorAll('.tab-btn').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active'); // Use currentTarget because of Icon
      }
      
      window.exportData = function(type) {
         if(APP_STATE.collectedPoints.length === 0) return alert("Belum ada data yang dikumpulkan.");
         
         let content = "";
         let filename = `survei_peta_${new Date().getTime()}.${type}`;
         
         if(type === 'csv') {
            const headers = Object.keys(APP_STATE.collectedPoints[0]).join(",");
            content = headers + "\n" + 
              APP_STATE.collectedPoints.map(p => Object.values(p).map(v => `"${v}"`).join(",")).join("\n");
            content = "data:text/csv;charset=utf-8," + encodeURIComponent(content);
         } else {
            const fc = {
               type: "FeatureCollection",
               features: APP_STATE.collectedPoints.map(p => ({
                  type: "Feature",
                  geometry: { type: "Point", coordinates: [parseFloat(p.lng), parseFloat(p.lat)] },
                  properties: p
               }))
            };
            content = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(fc, null, 2));
         }
         
         const link = document.createElement("a");
         link.setAttribute("href", content);
         link.setAttribute("download", filename);
         document.body.appendChild(link);
         link.click();
      }
      
      // WELCOME MODAL LOGIC
      document.addEventListener("DOMContentLoaded", function () {
        var modal = document.getElementById("welcome-modal");
        document.getElementById("dismiss-welcome").addEventListener("click", function () {
          modal.style.display = "none";
        });
      });

    </script>
  </body>
</html>
