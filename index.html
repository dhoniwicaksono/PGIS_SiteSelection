<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebGIS Prototype — Custom Symbols & Collector</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css" />

    <!-- Leaflet JS (MOVED HERE: Must be loaded before plugins like Esri Leaflet) -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet MarkerCluster JS (MOVED HERE) -->
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>

    <!-- Turf.js for Spatial Analysis (Buffer & Filtering) -->
    <script src="https://unpkg.com/@turf/turf/turf.min.js"></script>

    <!-- Esri Leaflet (Added for BNPB Layer) -->
    <script src="https://unpkg.com/esri-leaflet@3.0.10/dist/esri-leaflet.js"></script>
    <!-- Chart.js for analysis charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
      html,
      body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        /* Padding dihapus karena topbar sudah dihapus */
        height: 100%;
      }
      body {
        font-family: Arial, Helvetica, sans-serif;
      }

      /* Welcome Modal Styles */
      .modal-backdrop {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        z-index: 5000; /* Highest z-index */
        display: flex;
        justify-content: center;
        align-items: center;
        backdrop-filter: blur(5px);
        font-family: "Inter", sans-serif;
      }

      .modal-content {
        background: #ffffff;
        padding: 30px;
        border-radius: 12px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
        max-width: 90vw;
        width: 500px;
        text-align: center;
        border-top: 5px solid #2c7be5;
        animation: fadeIn 0.3s ease-out;
      }

      .modal-content h2 {
        margin-top: 0;
        font-size: 1.8em;
        line-height: 1.3;
        margin-bottom: 15px;
      }

      .modal-content p {
        font-size: 15px;
        color: #444;
        line-height: 1.6;
        margin-bottom: 0;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      /* Styles for Mobile Modal */
      @media (max-width: 600px) {
        .modal-content {
          padding: 20px;
          width: 95vw;
          max-width: none;
        }
        .modal-content h2 {
          font-size: 1.5em;
        }
      }

      /* Left sidebar (Form) */
      #sidebar {
        position: absolute;
        top: 8px;
        left: 8px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.98);
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.25);
        width: 320px;
        max-height: 90vh;
        overflow: auto;
        transition: max-height 0.3s ease;
      }

      /* Right sidebar (Tools & Layers) */
      #sidebarRight {
        position: absolute;
        top: 8px;
        right: 8px;
        z-index: 1000;
        background: rgba(255, 255, 255, 0.98);
        padding: 10px;
        border-radius: 6px;
        box-shadow: 0 1px 6px rgba(0, 0, 0, 0.25);
        width: 320px;
        max-height: 90vh;
        overflow: auto;
        transition: max-height 0.3s ease;
      }

      /* Mobile Navigation Bar */
      #mobile-nav {
        display: none;
      }
      .mobile-header-controls {
        display: none;
      }

      @media (max-width: 1024px) {
        /* Hapus aturan topbar mobile */

        #map {
          /* Hapus padding-top yang tidak diperlukan */
          padding-top: 0;
        }

        /* Hapus pergeseran kontrol Leaflet. Kembalikan ke default */
        .leaflet-top.leaflet-left {
          top: 10px !important; /* Back to Leaflet default margin */
        }

        #sidebar,
        #sidebarRight {
          position: fixed;
          left: 0;
          right: 0;
          bottom: 50px;
          top: auto;
          width: 100%;
          max-height: 50vh;
          border-radius: 12px 12px 0 0;
          padding: 10px 12px;
          box-sizing: border-box;
          display: none;
          z-index: 2000;
        }

        .sidebar-minimized {
          max-height: 50px !important;
          overflow: hidden !important;
        }

        .mobile-header-controls {
          display: block;
          float: right;
          background: #f0f0f0;
          border: none;
          border-radius: 4px;
          padding: 2px 8px;
          font-weight: bold;
          cursor: pointer;
        }

        .sidebar-header-row {
          display: flex;
          justify-content: space-between;
          align-items: center;
          margin-bottom: 8px;
          border-bottom: 1px solid #eee;
          padding-bottom: 5px;
        }

        .mobile-visible {
          display: block !important;
        }

        #mobile-nav {
          display: flex;
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          height: 50px;
          background: white;
          border-top: 1px solid #ccc;
          z-index: 3000;
          justify-content: space-around;
          align-items: center;
          box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.1);
        }

        #mobile-nav button {
          flex: 1;
          height: 100%;
          border: none;
          background: #fff;
          font-weight: 600;
          color: #555;
          cursor: pointer;
          font-size: 14px;
        }

        #mobile-nav button.active {
          color: #2c7be5;
          border-top: 3px solid #2c7be5;
          background: #f4f9ff;
        }
      }

      .btn {
        display: inline-block;
        padding: 8px 12px;
        margin: 6px 4px;
        border-radius: 6px;
        border: 1px solid #2c7be5;
        background: #2c7be5;
        color: #fff;
        cursor: pointer;
        font-size: 14px;
      }
      .btn.secondary {
        background: #fff;
        color: #2c7be5;
      }
      .btn.tertiary {
        background: #f5f5f5;
        color: #333;
        border: 1px solid #ddd;
      }
      .smallBtn {
        padding: 4px 6px;
        font-size: 12px;
      }

      label {
        display: block;
        margin-top: 8px;
        font-weight: 600;
      }
      .ctrl-label {
        display: flex;
        align-items: center;
        margin-top: 6px;
        font-weight: normal;
        cursor: pointer;
        font-size: 14px;
      }
      .ctrl-label input {
        width: auto;
        margin-top: 0;
        margin-right: 8px;
        cursor: pointer;
      }

      /* LEGEND SHAPES CSS */
      .legend-item {
        display: flex;
        align-items: center;
        font-size: 12px;
        margin-top: 4px;
        color: #555;
      }
      .legend-symbol {
        display: inline-block;
        margin-right: 6px;
        box-shadow: 0 0 1px rgba(0, 0, 0, 0.2);
      }

      /* Shape Classes (WebGIS Simbolisasi Baru) */
      .sym-circle {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        border: 2px solid #cccccc;
      }
      .sym-square {
        width: 12px;
        height: 12px;
        border-radius: 0;
        border: 2px solid #cccccc;
      }
      .sym-diamond {
        width: 10px;
        height: 10px;
        transform: rotate(45deg);
        border: 2px solid #cccccc;
        margin-left: 2px;
        margin-right: 8px;
      }
      .sym-hexagon {
        width: 14px;
        height: 14px;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .sym-star {
        width: 14px;
        height: 14px;
        background: transparent;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .sym-h {
        width: 14px;
        height: 14px;
        background: transparent !important;
        box-shadow: none;
        font-weight: 900;
        font-family: sans-serif;
        text-align: center;
        line-height: 14px;
        font-size: 14px;
        text-shadow: -1px -1px 0 #cccccc, 1px -1px 0 #cccccc, -1px 1px 0 #cccccc, 1px 1px 0 #cccccc;
      }

      input[type="text"],
      select,
      textarea {
        width: 100%;
        padding: 8px;
        box-sizing: border-box;
        margin-top: 6px;
        border: 1px solid #ccc;
        border-radius: 4px;
      }
      textarea {
        resize: vertical;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 8px;
      }
      table th,
      table td {
        border: 1px solid #ddd;
        padding: 6px;
        font-size: 13px;
      }
      .small {
        font-size: 13px;
        color: #555;
      }

      @media (max-width: 700px) {
        /* Hide some columns on mobile */
        table th:nth-child(5), table td:nth-child(5), /* Lon */
        table th:nth-child(6), table td:nth-child(6)  /* Reason */ {
          display: none;
        }
        .btn {
          font-size: 13px;
          padding: 8px 10px;
        }
      }

      .leaflet-control-layers {
        z-index: 1200;
      }

      /* Admin Labels & Suggestions */
      .admin-label {
        background: rgba(255, 255, 255, 0.85);
        padding: 2px 4px;
        border-radius: 4px;
        font-size: 11px;
        color: #111;
      }
      .admin-label-prov {
        text-shadow: 0 0 8px #fff;
        font-weight: 700;
      }
      .admin-label-kab {
        text-shadow: 0 0 6px #fff;
      }
      .admin-label-kec {
        text-shadow: 0 0 4px #fff;
      }
      .admin-label-desa {
        text-shadow: 0 0 2px #fff;
      }

      #admin_suggestions div:hover {
        background: #f5f8ff;
      }

      /* --- UPDATED LABEL STYLE (Text Wrapping) --- */
      .feature-label {
        background: rgba(255, 255, 255, 0.75);
        border: 1px solid rgba(0, 0, 0, 0.2);
        border-radius: 4px;
        padding: 1px 4px;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.15);

        /* Default Font Size */
        font-size: 9px;

        font-weight: bold;
        color: #222;
        text-transform: none !important;
        text-shadow: none;

        /* white-space: nowrap + <br> logic for wrapping */
        white-space: nowrap;

        text-align: center;
        line-height: 1.2;

        display: none;
        pointer-events: none;
      }
      .show-labels .feature-label {
        display: block !important;
      }

      /* DYNAMIC FONT SIZES */
      .map-zoom-15 .feature-label {
        font-size: 9px;
      }
      .map-zoom-16 .feature-label {
        font-size: 10px;
      }
      .map-zoom-17 .feature-label,
      .map-zoom-18 .feature-label,
      .map-zoom-19 .feature-label {
        font-size: 11px;
      }

      .custom-div-icon {
        background: transparent;
        border: none;
      }

      /* Loading Indicator Style */
      #loading-indicator {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;
        background: rgba(255, 255, 255, 0.9);
        padding: 15px 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        display: none; /* Hidden by default */
        font-weight: bold;
        color: #333;
        text-align: center;
        border: 1px solid #ccc;
      }
      .spinner {
        display: inline-block;
        width: 12px;
        height: 12px;
        border: 2px solid #333;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        vertical-align: middle;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      /* New CSS for gradient legend bar */
      .legend-gradient {
        height: 12px;
        width: 100%;
        margin-top: 4px;
        /* REVERSED: Merah (Tinggi) ke Kiri, Hijau (Rendah) ke Kanan */
        background: linear-gradient(to right, #d73027, #ffffbf, #1a9850); /* Red to Yellow to Green */
        border: 1px solid #ccc;
        border-radius: 3px;
      }
      .legend-labels {
        display: flex;
        justify-content: space-between;
        font-size: 10px;
        margin-top: 2px;
        color: #555;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <!-- Loading Indicator Element -->
    <div id="loading-indicator"><span class="spinner"></span>Memuat Data Layer...</div>

    <!-- WELCOME MODAL (New Element) -->
    <div id="welcome-modal" class="modal-backdrop">
      <div class="modal-content">
        <h2>
          <span style="font-weight: bold; font-size: 1.5em; color: #2c7be5">PETA</span>
          <span style="font-weight: normal; font-size: 1em; color: #555">(Participatory Evidence-based Territorial Analytics)</span>
        </h2>
        <p>
          PETA merupakan platform WebGIS kolaboratif yang dirancang untuk mendukung proses perencanaan tata ruang berbasis partisipasi publik dan bukti spasial. Platform ini mengintegrasikan aspirasi masyarakat, data geospasial tematik, dan
          analisis territorial dalam satu lingkungan digital yang interaktif, transparan, dan mudah diakses.
        </p>
        <button id="dismiss-welcome" class="btn" style="margin-top: 20px">Mulai Pemetaan</button>
      </div>
    </div>

    <!-- LEFT SIDEBAR: UPDATED WITH UPLOADED COLLECTOR FEATURES -->
    <div id="sidebar" class="mobile-visible">
      <div class="sidebar-header-row">
        <h3 style="margin: 0">Collector</h3>
        <button class="mobile-header-controls" onclick="toggleSidebarHeight('sidebar', this)">▼</button>
      </div>

      <div class="small">Klik peta untuk menambahkan titik. Isi atribut di form, lalu tekan <b>Save Point</b>. Minimal <b>10 titik</b> per responden direkomendasikan.</div>

      <label>Respondent ID <span style="color: red">*</span></label>
      <input type="text" id="respondent_id" placeholder="Isikan identitas anda" />

      <label>Stakeholder Group</label>
      <select id="stakeholder_group">
        <option value="Pemerintah_Desa">Pemerintah Desa</option>
        <option value="Pelaku_Usaha">Pelaku Usaha</option>
        <option value="Dinas_Terkait">Dinas Terkait</option>
        <option value="Lainnya">Lainnya</option>
      </select>

      <label>Mapping Object <span style="color: red">*</span></label>
      <input type="text" id="mapping_object" placeholder="Contoh: Perdagangan-Jasa" />

      <label>Point ID (auto)</label>
      <input type="text" id="point_id" placeholder="Auto: [Object]_[No]" readonly style="background-color: #f0f0f0; color: #555" />

      <label>Reason (optional)</label>
      <textarea id="reason" rows="2" placeholder="Contoh: dekat jalan kolektor dan pasar"></textarea>

      <label>Map Source</label>
      <select id="map_source">
        <option value="webGIS">webGIS</option>
        <option value="peta_cetak">peta_cetak</option>
        <option value="gps">gps</option>
      </select>

      <label>Accuracy (m) — optional</label>
      <input type="text" id="accuracy_m" placeholder="e.g. 10" />

      <div style="margin-top: 10px; display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; align-items: center">
        <button id="savePointBtn" class="btn">Save Point</button>
        <button id="clearFormBtn" class="btn secondary">Clear Form</button>
        <button id="centerBtn" class="btn tertiary">Center Map</button>
      </div>

      <hr />

      <div class="small"><b>Points collected:</b></div>
      <div id="pointsCount">0 points</div>

      <table id="pointsTable" style="display: none">
        <thead>
          <tr>
            <th>#</th>
            <th>ID</th>
            <th>Mapping Object</th>
            <th>Lat</th>
            <th>Lon</th>
            <th>Reason</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>

      <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap">
        <button id="exportCsv" class="btn">Export CSV</button>
        <button id="exportGeojson" class="btn">Export GeoJSON</button>
        <button id="clearAll" class="btn secondary">Clear All Points</button>
      </div>

      <hr />
      <div class="small">Instruksi singkat: 1) Isi Respondent ID. 2) Klik lokasi pada peta. 3) Edit atribut jika perlu. 4) Tekan "Save Point". 5) Setelah selesai, tekan Export CSV.</div>
    </div>

    <!-- RIGHT SIDEBAR: RETAINED CUSTOM SYMBOLS LEGEND -->
    <div id="sidebarRight">
      <div class="sidebar-header-row">
        <h3 style="margin: 0">Peta & Layers</h3>
        <button class="mobile-header-controls" onclick="toggleSidebarHeight('sidebarRight', this)">▼</button>
      </div>

      <!-- Basemap -->
      <h4 style="margin: 6px 0; font-size: 14px; text-decoration: underline">Basemap</h4>
      <div style="margin-bottom: 12px">
        <label class="ctrl-label"> <input type="radio" name="basemap_select" value="osm" checked /> OSM Standard </label>
        <label class="ctrl-label"> <input type="radio" name="basemap_select" value="esri" /> Esri Satellite </label>
        <label class="ctrl-label"> <input type="radio" name="basemap_select" value="opnv" /> OPNVKarte (Transport) </label>
        <label class="ctrl-label"> <input type="radio" name="basemap_select" value="opentopo" /> OpenTopoMap </label>
      </div>

      <hr />

      <!-- Layers (Custom Shapes) -->
      <h4 style="margin: 6px 0; font-size: 14px; text-decoration: underline">Layers</h4>
      <div style="margin-bottom: 12px">
        <!-- 1. PEMERINTAHAN (UPDATED: Grayscale REVISI) -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">1. Kantor Pemerintahan</div>
        <label class="ctrl-label"> <input type="checkbox" id="layer_kantor_pemerintah" /> Kantor Pemerintahan </label>
        <div id="legend_kantor" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="14" height="14" viewBox="0 0 24 24"><polygon points="3,9 12,3 21,9 21,20 3,20" fill="#000000" stroke="#ffffff" stroke-width="1.5" /></svg></span
            >Kantor Gubernur
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24"><polygon points="3,9 12,3 21,9 21,20 3,20" fill="#252525" stroke="#ffffff" stroke-width="1.5" /></svg></span
            >Kantor Bupati / Walikota
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24"><polygon points="3,9 12,3 21,9 21,20 3,20" fill="#525252" stroke="#ffffff" stroke-width="1.2" /></svg></span
            >Kantor Kecamatan / Kemantren
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="9" height="9" viewBox="0 0 24 24"><polygon points="3,9 12,3 21,9 21,20 3,20" fill="#737373" stroke="#ffffff" stroke-width="1" /></svg></span
            >Kantor Desa / Kelurahan
          </div>
        </div>
        <!-- NEW: Perkantoran (BPN) -->
        <label class="ctrl-label"> <input type="checkbox" id="layer_perkantoran" /> Perkantoran Lainnya </label>
        <div id="legend_perkantoran" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24"><polygon points="3,9 12,3 21,9 21,20 3,20" fill="#d73027" stroke="#ffffff" stroke-width="1.5" /></svg></span
            >Kantor / Instansi Umum
          </div>
        </div>

        <hr style="border-top: 1px dashed #ddd; margin: 8px 0" />

        <!-- ADMIN ANALYSIS: Bar chart for selected administrative unit -->
        <h4 style="margin: 6px 0; font-size: 14px; text-decoration: underline">Analisis Wilayah</h4>
        <div id="admin_analysis" style="margin-bottom:12px; display:none;">
          <div style="font-size:12px; color:#333; font-weight:600; margin-bottom:6px">Jumlah fasilitas aktif dalam wilayah</div>
          <div style="display:flex; gap:6px; align-items:flex-start">
            <canvas id="adminChartCanvas" width="220" height="160" style="background:#fafafa; border:1px solid #eee; box-sizing:border-box"></canvas>
            <div style="display:flex; flex-direction:column; gap:6px;">
              <button id="btn_export_png" class="btn" style="padding:6px 8px; white-space:nowrap">Export PNG</button>
              <button id="btn_export_csv" class="btn" style="padding:6px 8px; white-space:nowrap">Export CSV</button>
            </div>
          </div>
          <div id="admin_analysis_note" style="font-size:11px; color:#666; margin-top:6px">Pilih wilayah melalui "Search by Administrative" untuk melihat ringkasan.</div>
        </div>
        <button id="btn_toggle_fetch_debug" class="btn tertiary smallBtn" style="margin-top:8px">Toggle Fetch Debug</button>
        <div id="fetch_debug" style="display:none; margin-top:8px; max-height:160px; overflow:auto; font-size:12px; border:1px solid #eee; padding:6px; background:#fff;"></div>


        <!-- 2. KESEHATAN -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">2. Fasilitas Kesehatan</div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_rs" /> Rumah Sakit </label>
        <div id="legend_rs" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="16" rx="1.2" fill="#c62828" stroke="#ffffff" stroke-width="1.5" />
                <rect x="9" y="8" width="6" height="6" fill="#ffffff" /></svg></span
            >Rumah Sakit Umum
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="16" rx="1.2" fill="#d84315" stroke="#ffffff" stroke-width="1.5" />
                <rect x="9" y="8" width="6" height="6" fill="#ffffff" /></svg></span
            >Rumah Sakit Khusus
          </div>
        </div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_puskesmas" /> Puskesmas </label>
        <div id="legend_puskesmas" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24">
                <rect x="3" y="5" width="18" height="14" rx="1" fill="#ff8c00" stroke="#ffffff" stroke-width="1" />
                <rect x="9" y="8" width="6" height="6" fill="#ffffff" /></svg></span
            >Puskesmas
          </div>
        </div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_klinik" /> Klinik </label>
        <div id="legend_klinik" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24">
                <rect x="3" y="5" width="18" height="14" rx="1" fill="#0d47a1" stroke="#ffffff" stroke-width="1" />
                <rect x="9" y="8" width="6" height="6" fill="#ffffff" /></svg></span
            >Klinik Umum
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24">
                <rect x="3" y="5" width="18" height="14" rx="1" fill="#00bcd4" stroke="#ffffff" stroke-width="1" />
                <rect x="9" y="8" width="6" height="6" fill="#ffffff" /></svg></span
            >Klinik Gigi
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24">
                <rect x="3" y="5" width="18" height="14" rx="1" fill="#2e7d32" stroke="#ffffff" stroke-width="1" />
                <rect x="9" y="8" width="6" height="6" fill="#ffffff" /></svg></span
            >Klinik Lain
          </div>
        </div>

        <hr style="border-top: 1px dashed #ddd; margin: 8px 0" />

        <!-- 3. PENDIDIKAN -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">3. Fasilitas Pendidikan</div>
        <label class="ctrl-label">
          <input type="checkbox" id="layer_sekolah" /> Sekolah (SD/SMP/SMA)
          <span style="font-size: 10px; background: #eee; padding: 1px 3px; border-radius: 3px; margin-left: 4px">Cluster</span>
        </label>
        <div id="legend_sekolah" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24">
                <rect x="3" y="6" width="9" height="11" fill="#d95f0e" stroke="#ffffff" stroke-width="1" />
                <rect x="12" y="6" width="9" height="11" fill="#d95f0e" stroke="#ffffff" stroke-width="1" /></svg></span
            >SMA / SMK
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="11" fill="#fe9929" stroke="#ffffff" stroke-width="1" /></svg></span
            >SMP / Sederajat
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24"><rect x="3" y="6" width="18" height="11" fill="#fed98e" stroke="#ffffff" stroke-width="1" /></svg></span
            >SD / Sederajat
          </div>
        </div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_kampus" /> Perguruan Tinggi </label>
        <div id="legend_kampus" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24"><circle cx="12" cy="11" r="9" fill="#993404" stroke="#ffffff" stroke-width="1" /></svg></span
            >Universitas
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24"><circle cx="12" cy="11" r="9" fill="#d95f0e" stroke="#ffffff" stroke-width="1" /></svg></span
            >Institut / Poltek
          </div>
        </div>

        <hr style="border-top: 1px dashed #ddd; margin: 8px 0" />

        <!-- 4. EKONOMI -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">4. Fasilitas Ekonomi</div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_pasar" /> Pasar Tradisional </label>
        <div id="legend_pasar" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24"><polygon points="2,9 12,3 22,9 22,20 2,20" fill="#8e0152" stroke="#ffffff" stroke-width="1.5" /></svg></span
            >Pasar Harian
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24"><polygon points="2,9 12,3 22,9 22,20 2,20" fill="#7fbc41" stroke="#ffffff" stroke-width="1.5" /></svg></span
            >Pasar Non Harian
          </div>
        </div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_ibm" /> Industri Besar dan Menengah </label>
        <div id="legend_ibm" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24"><rect x="2" y="10" width="20" height="8" fill="#b2df8a" stroke="#ffffff" stroke-width="1" /></svg></span
            >Makanan & Minuman
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24"><rect x="2" y="10" width="20" height="8" fill="#fb9a99" stroke="#ffffff" stroke-width="1" /></svg></span
            >Tekstil & Kulit
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24"><rect x="2" y="10" width="20" height="8" fill="#6a3d9a" stroke="#ffffff" stroke-width="1" /></svg></span
            >Kayu & Furnitur
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24"><rect x="2" y="10" width="20" height="8" fill="#cab2d6" stroke="#ffffff" stroke-width="1" /></svg></span
            >Kertas & Cetak
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24"><rect x="2" y="10" width="20" height="8" fill="#e31a1c" stroke="#ffffff" stroke-width="1" /></svg></span
            >Kimia & Plastik
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24"><rect x="2" y="10" width="20" height="8" fill="#ff7f00" stroke="#ffffff" stroke-width="1" /></svg></span
            >Logam & Mesin
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24"><rect x="2" y="10" width="20" height="8" fill="#33a02c" stroke="#ffffff" stroke-width="1" /></svg></span
            >Kerajinan
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="10" height="10" viewBox="0 0 24 24"><rect x="2" y="10" width="20" height="8" fill="#a6cee3" stroke="#ffffff" stroke-width="1" /></svg></span
            >Lainnya
          </div>
        </div>

        <!-- NEW: Bank (BPN) -->
        <label class="ctrl-label"> <input type="checkbox" id="layer_bank" /> Bank & Keuangan </label>
        <div id="legend_bank" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24">
                <polygon points="12,3 3,8 21,8" fill="#6a1b9a" stroke="#ffffff" stroke-width="1" />
                <rect x="4" y="9" width="16" height="10" fill="#6a1b9a" stroke="#ffffff" stroke-width="1" /></svg></span
            >Bank / ATM
          </div>
        </div>

        <hr style="border-top: 1px dashed #ddd; margin: 8px 0" />

        <!-- 5. PARIWISATA -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">5. Pariwisata</div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_dtw" /> Objek Wisata (DTW) </label>
        <div id="legend_dtw" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24">
                <rect x="3" y="6" width="18" height="12" rx="2" fill="#33a02c" stroke="#ffffff" stroke-width="1.5" />
                <circle cx="12" cy="12" r="3" fill="#ffffff" /></svg></span
            >Wisata Alam
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24">
                <rect x="3" y="6" width="18" height="12" rx="2" fill="#1f78b4" stroke="#ffffff" stroke-width="1.5" />
                <circle cx="12" cy="12" r="3" fill="#ffffff" /></svg></span
            >Wisata Bahari
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24">
                <rect x="3" y="6" width="18" height="12" rx="2" fill="#ff7f00" stroke="#ffffff" stroke-width="1.5" />
                <circle cx="12" cy="12" r="3" fill="#ffffff" /></svg></span
            >Wisata Budaya
          </div>
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24">
                <rect x="3" y="6" width="18" height="12" rx="2" fill="#d7191c" stroke="#ffffff" stroke-width="1.5" />
                <circle cx="12" cy="12" r="3" fill="#ffffff" /></svg></span
            >Desa Wisata
          </div>
        </div>

        <!-- NEW: Hotel (BPN) -->
        <label class="ctrl-label"> <input type="checkbox" id="layer_hotel" /> Hotel & Penginapan </label>
        <div id="legend_hotel" style="margin-left: 24px; margin-top: 4px; display: none">
          <div class="legend-item">
            <span class="legend-symbol" style="margin-right: 8px"
              ><svg width="12" height="12" viewBox="0 0 24 24">
                <rect x="3" y="4" width="18" height="16" rx="1.5" fill="#c51b7d" stroke="#ffffff" stroke-width="1.5" />
                <rect x="6" y="8" width="3" height="2" fill="#ffffff" />
                <rect x="10" y="8" width="3" height="2" fill="#ffffff" /></svg></span
            >Hotel / Akomodasi
          </div>
        </div>

        <hr style="border-top: 1px dashed #ddd; margin: 8px 0" />

        <!-- 6. RAWAN BENCANA (BNPB) -->
        <div style="font-weight: bold; margin-bottom: 4px; font-size: 13px; color: #333">6. Kerawanan Bencana</div>
        <div style="font-size: 10px; color: #777; margin-bottom: 4px; margin-left: 24px">Sumber: BNPB ImageServer</div>

        <label class="ctrl-label"> <input type="checkbox" id="layer_bencana_tsunami" /> Bahaya Tsunami </label>
        <label class="ctrl-label"> <input type="checkbox" id="layer_bencana_gempa" /> Bahaya Gempa Bumi </label>
        <label class="ctrl-label"> <input type="checkbox" id="layer_bencana_longsor" /> Bahaya Tanah Longsor </label>
        <label class="ctrl-label"> <input type="checkbox" id="layer_bencana_erupsi" /> Bahaya Erupsi Gunungapi </label>

        <!-- Legenda BNPB Baru -->
        <div style="margin-top: 10px; padding: 4px 0">
          <div style="font-size: 11px; font-weight: 600; color: #333">Tingkat Bahaya Umum (InaRISK)</div>
          <div class="legend-gradient"></div>
          <div class="legend-labels">
            <span style="color: #d73027">Tinggi</span>
            <span>Sedang</span>
            <span style="color: #1a9850">Rendah</span>
          </div>
        </div>
      </div>

      <hr />

      <h3 style="margin: 6px 0">Tools</h3>
      <div style="margin-top: 10px; display: flex; flex-direction: column; gap: 12px; align-items: center">
        <button id="getLocationBtn" class="btn" style="width: 80%; text-align: center">Get my location</button>
        <div style="display: flex; gap: 8px; justify-content: center; width: 100%">
          <button id="zoomInBtn" class="btn tertiary" style="width: 40%; text-align: center">Zoom In</button>
          <button id="zoomOutBtn" class="btn tertiary" style="width: 40%; text-align: center">Zoom Out</button>
        </div>
      </div>

      <!-- Admin Search Container (RESTORED from Uploaded File) -->
      <div id="admin_search_container" style="margin-top: 12px; border-top: 1px solid #ddd; padding-top: 12px"></div>
    </div>

    <div id="mobile-nav">
      <button id="tab-form" class="active">Form Data</button>
      <button id="tab-layers">Layers & Tools</button>
    </div>

    <script>
      // --- Modal Logic ---
      document.addEventListener("DOMContentLoaded", function () {
        var modal = document.getElementById("welcome-modal");
        var dismissBtn = document.getElementById("dismiss-welcome");

        dismissBtn.addEventListener("click", function () {
          modal.style.display = "none";
        });

        // Show modal initially
        modal.style.display = "flex";
      });

      // --- Mobile UI & Tabs ---
      function toggleSidebarHeight(id, btn) {
        var el = document.getElementById(id);
        if (el.classList.contains("sidebar-minimized")) {
          el.classList.remove("sidebar-minimized");
          btn.innerHTML = "▼";
          btn.style.transform = "rotate(0deg)";
        } else {
          el.classList.add("sidebar-minimized");
          btn.innerHTML = "▼";
          btn.style.transform = "rotate(180deg)";
        }
      }

      (function () {
        var tabForm = document.getElementById("tab-form");
        var tabLayers = document.getElementById("tab-layers");
        var sidebarLeft = document.getElementById("sidebar");
        var sidebarRight = document.getElementById("sidebarRight");

        function switchTab(target) {
          tabForm.classList.remove("active");
          tabLayers.classList.remove("active");
          sidebarLeft.classList.remove("mobile-visible");
          sidebarRight.classList.remove("mobile-visible");
          sidebarLeft.classList.remove("sidebar-minimized");
          sidebarRight.classList.remove("sidebar-minimized");

          if (target === "form") {
            tabForm.classList.add("active");
            sidebarLeft.classList.add("mobile-visible");
          } else {
            tabLayers.classList.add("active");
            sidebarRight.classList.add("mobile-visible");
          }
        }
        tabForm.addEventListener("click", function () {
          switchTab("form");
        });
        tabLayers.addEventListener("click", function () {
          switchTab("layers");
        });
      })();

      // --- Map Init ---
      var osm = L.tileLayer("https://tile.openstreetmap.org/{z}/{x}/{y}.png", { maxZoom: 19, attribution: "© OpenStreetMap" });
      var Esri_WorldImagery = L.tileLayer("https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}", { attribution: "Esri" });
      var OPNVKarte = L.tileLayer("https://tileserver.memomaps.de/tilegen/{z}/{x}/{y}.png", { maxZoom: 18, attribution: "OPNVKarte" });

      var OpenTopoMap = L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
        maxZoom: 17,
        attribution:
          'Map data: &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, <a href="http://viewfinderpanoramas.org">SRTM</a> | Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> (<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)',
      });

      var map = L.map("map", { center: [-7.8, 110.37], zoom: 12, layers: [osm], preferCanvas: true });
      L.control.scale().addTo(map);

      // --- Label Visibility & DYNAMIC FONT on Zoom ---
      function checkZoomForLabels() {
        var z = map.getZoom();
        var container = map.getContainer();

        // 1. Show/Hide threshold
        if (z >= 15) container.classList.add("show-labels");
        else container.classList.remove("show-labels");

        // 2. Dynamic Font Size Classes
        container.classList.remove("map-zoom-15", "map-zoom-16", "map-zoom-17", "map-zoom-18", "map-zoom-19");
        if (z >= 15) {
          var zoomClass = "map-zoom-" + (z > 19 ? 19 : z);
          container.classList.add(zoomClass);
        }
      }
      map.on("zoomend", checkZoomForLabels);
      checkZoomForLabels();

      // --- Helper: Format Label Text (Title Case + 3 Words per Line) ---
      function toTitleCasePreserveAcronyms(str) {
        if (!str) return "";
        return String(str)
          .trim()
          .replace(/\s+/g, " ")
          .split(" ")
          .map(function (w) {
            // Preserve short all-caps acronyms (SD, SMP, SMA, RS, H, etc.)
            if (w.length <= 3 && /^[A-Z0-9]+$/.test(w)) return w.toUpperCase();
            // If original word is all upper-case but longer, keep first letter uppercase
            if (/^[A-Z0-9]+$/.test(w)) return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
            return w.charAt(0).toUpperCase() + w.slice(1).toLowerCase();
          })
          .join(" ");
      }

      function formatLabelText(text) {
        if (!text) return "";
        var title = toTitleCasePreserveAcronyms(text);
        var words = title.split(" ");
        var lines = [];
        for (var i = 0; i < words.length; i += 3) {
          lines.push(words.slice(i, i + 3).join(" "));
        }
        return lines.join("<br>");
      }

      // --- Basemap Switch ---
      document.querySelectorAll('input[name="basemap_select"]').forEach(function (radio) {
        radio.addEventListener("change", function (e) {
          var val = e.target.value;
          if (map.hasLayer(osm)) map.removeLayer(osm);
          if (map.hasLayer(Esri_WorldImagery)) map.removeLayer(Esri_WorldImagery);
          if (map.hasLayer(OPNVKarte)) map.removeLayer(OPNVKarte);
          if (map.hasLayer(OpenTopoMap)) map.removeLayer(OpenTopoMap);

          if (val === "osm") map.addLayer(osm);
          else if (val === "esri") map.addLayer(Esri_WorldImagery);
          else if (val === "opnv") map.addLayer(OPNVKarte);
          else if (val === "opentopo") map.addLayer(OpenTopoMap);
        });
      });

      // --- GeoJSON Helper ---
      function fetchGeoJSON(url) {
        // Build candidate paths with common folders used across versions
        var candidates = [];
        function pushUnique(u){ if (!u) return; if (candidates.indexOf(u) === -1) candidates.push(u); }
        pushUnique(url);
        if (!/^data\//i.test(url)) pushUnique('data/' + url);
        pushUnique('../V5.0/data/' + url);
        pushUnique('../V4.0/data/' + url);
        pushUnique('../V5.0/' + url);
        pushUnique('../V4.0/' + url);
        pushUnique('./' + url);
        pushUnique(url.toLowerCase());
        pushUnique(url.replace(/\.geojson$/i, '.json'));
        // init debug store
        window.fetchDebugAttempts = window.fetchDebugAttempts || [];

        function updateFetchDebugUI() {
          try {
            var el = document.getElementById('fetch_debug');
            if (!el) return;
            var html = '<div style="font-weight:600;margin-bottom:6px">Last fetch attempts</div>';
            html += '<ol style="padding-left:18px;margin:0;font-size:12px">';
            var arr = (window.fetchDebugAttempts || []).slice(-50).reverse();
            for (var i=0;i<arr.length;i++) {
              var it = arr[i];
              html += '<li style="margin-bottom:4px;color:#333">' + escapeHtml(it) + '</li>';
            }
            html += '</ol>';
            el.innerHTML = html;
          } catch(e){}
        }

        return new Promise(function (resolve, reject) {
          function tryFetch(idx) {
            if (idx >= candidates.length) {
              reject('File not found');
              return;
            }
            var attemptUrl = candidates[idx];
            // record attempt
            try { window.fetchDebugAttempts.push(attemptUrl); } catch(e){}
            try { updateFetchDebugUI(); } catch(e){}

            fetch(attemptUrl)
              .then((r) => {
                if (!r.ok) throw new Error('404');
                return r.json();
              })
              .then((data) => resolve(data))
              .catch(() => tryFetch(idx + 1));
          }
          tryFetch(0);
        });
      }

      function mercatorToLatLon(x, y) {
        var rMajor = 6378137;
        var shift = Math.PI * rMajor;
        var lon = (x / shift) * 180.0;
        var lat = (y / shift) * 180.0;
        lat = (180 / Math.PI) * (2 * Math.atan(Math.exp((lat * Math.PI) / 180.0)) - Math.PI / 2.0);
        return [lat, lon];
      }

      // --- COLOR & STYLE FUNCTIONS (Preserved from Custom Symbols) ---

      // 1. PEMERINTAHAN (UPDATED: Grayscale REVISI)
      function getGovColor(kategori) {
        if (!kategori) return "#737373";
        var k = String(kategori).toLowerCase();
        if (k.includes("gubernur") || k.includes("diy")) return "#000000";
        if (k.includes("bupati") || k.includes("walikota")) return "#252525";
        if (k.includes("camat") || k.includes("kemantren") || k.includes("kecamatan")) return "#525252";
        if (k.includes("kelurahan") || k.includes("desa") || k.includes("kalurahan") || k.includes("lurah")) return "#737373";
        return "#737373";
      }

      // 2. KESEHATAN
      function getRSColor(ket) {
        // Use solid unique colors for Rumah Sakit
        if (!ket) return "#c62828"; // default red
        var k = String(ket).toLowerCase();
        if (k.includes("rsu") || k.includes("umum")) return "#c62828"; // dark red
        return "#d84315"; // other hospitals
      }
      function getPuskesmasColor(ket) {
        // Puskesmas: solid orange
        return "#ff8c00";
      }

      // REVISI KLINIK
      function getKlinikColor(ket) {
        // Klinik: unique solid colors per type
        if (!ket) return "#0d47a1"; // default: dark blue
        var k = String(ket).toLowerCase();
        if (k.includes("gigi") || k.includes("dental")) return "#00bcd4"; // cyan for dental
        if (k.includes("umum")) return "#0d47a1"; // dark blue for general
        return "#2e7d32"; // green for other clinics
      }

      // 3. PENDIDIKAN
      function getSekolahColor(ket) {
        if (!ket) return "#fed98e";
        var k = String(ket).toLowerCase();
        if (k.includes("sma") || k.includes("smk")) return "#d95f0e";
        if (k.includes("smp")) return "#fe9929";
        if (k.includes("sd")) return "#fed98e";
        return "#ffffd4";
      }
      function getKampusColor(ket) {
        if (!ket) return "#d95f0e";
        var k = String(ket).toLowerCase();
        if (k.includes("universitas")) return "#993404";
        return "#d95f0e";
      }

      // 4. EKONOMI
      function getPasarColor(ket) {
        if (!ket) return "#c51b7d";
        var k = String(ket).toLowerCase();
        if (k.includes("harian") && !k.includes("non")) return "#8e0152";
        return "#7fbc41";
      }

      function getIbmColor(ket) {
        if (!ket) return "#a6cee3";
        var k = String(ket).toLowerCase();
        if (k.includes("food") || k.includes("beverage") || k.includes("makan") || k.includes("minum")) return "#b2df8a";
        if (k.includes("textile") || k.includes("leather") || k.includes("tekstil") || k.includes("kulit")) return "#fb9a99";
        if (k.includes("wood") || k.includes("furniture") || k.includes("kayu") || k.includes("mebel")) return "#6a3d9a";
        if (k.includes("paper") || k.includes("printing") || k.includes("kertas") || k.includes("cetak")) return "#cab2d6";
        if (k.includes("chemical") || k.includes("plastic") || k.includes("kimia") || k.includes("plastik")) return "#e31a1c";
        if (k.includes("metal") || k.includes("machine") || k.includes("logam") || k.includes("mesin")) return "#ff7f00";
        if (k.includes("craft") || k.includes("kerajinan")) return "#33a02c";
        return "#a6cee3";
      }

      // 5. PARIWISATA
      function getDtwColor(ket) {
        if (!ket) return "#ff7f00";
        var k = String(ket).toLowerCase();
        if (k.includes("alam")) return "#33a02c";
        if (k.includes("bahari") || k.includes("pantai")) return "#1f78b4";
        if (k.includes("budaya")) return "#ff7f00";
        if (k.includes("desa")) return "#d7191c";
        return "#ff7f00";
      }

      // --- NEW: COLORS FOR NEW LAYERS (BPN & Theme) ---
      function getPerkantoranColor(val) {
        // Perkantoran: solid red
        return "#d73027";
      }
      function getBankColor(val) {
        // Bank: solid purple
        return "#6a1b9a";
      }
      function getHotelColor(val) {
        // Hotel: solid magenta
        return "#c51b7d";
      }

      // --- CUSTOM MARKER CREATION (Preserved from Custom Symbols) ---
      function createCustomMarker(latlng, type, color, properties) {
        var size = 16;
        var strokeColor = "#ffffff"; // outline as requested
        var strokeWidth = 2;

        // Size differentiation based on administrative level or category
        try {
          var key = (properties && (properties.kategori || properties.keterangan || "")).toString().toLowerCase();
          if (key.indexOf("gubernur") !== -1 || key.indexOf("prov") !== -1) size = 24;
          else if (key.indexOf("bupati") !== -1 || key.indexOf("walikota") !== -1 || key.indexOf("kab") !== -1) size = 22;
          else if (key.indexOf("camat") !== -1 || key.indexOf("kemantren") !== -1 || key.indexOf("kecamatan") !== -1) size = 20;
          else if (key.indexOf("desa") !== -1 || key.indexOf("kelurahan") !== -1) size = 18;

          // Sekolah specific sizes
          if ((properties && properties.keterangan) || (properties && properties.kategori)) {
            var sch = (properties.keterangan || properties.kategori || "").toString().toLowerCase();
            if (sch.indexOf("sma") !== -1 || sch.indexOf("smk") !== -1) size = Math.max(size, 18);
            if (sch.indexOf("smp") !== -1) size = Math.max(size, 16);
            if (sch.indexOf("sd") !== -1) size = Math.max(size, 12);
          }
        } catch (e) {}

        // Emphasize important object types with requested minimum sizes
        try {
          if (type === "hospital") size = Math.max(size, 22);
          if (type === "graduation") size = Math.max(size, 22);
        } catch (e) {}

        if (type === "circle") {
          return L.circleMarker(latlng, {
            radius: Math.round(size / 2),
            color: strokeColor,
            weight: strokeWidth,
            opacity: 1,
            fillOpacity: 1,
            fillColor: color,
          });
        }

        var html = "";

        // Use solid fills (no gradients) for icons to match unique-color strategy
        if (type === "gov_building" || type === "office_building" || type === "bank" || type === "industry" || type === "hotel" || type === "market") {
          var roof = type === "gov_building" ? "#222" : type === "office_building" ? "#444" : "#333";
          var facade = `<rect x="3" y="6" width="18" height="14" rx="1.5" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/>`;
          var roofEl = `<polygon points="3,6 12,2 21,6" fill="${roof}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/>`;
          var door = `<rect x="10" y="14" width="4" height="6" fill="${shadeColor(color, -40)}" stroke="${strokeColor}" stroke-width="1"/>`;
          html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;">${roofEl}${facade}${door}</svg>`;
        } else if (type === "hospital") {
          // Hospital: building with cross (solid fill)
          html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;"><rect x="3" y="4" width="18" height="16" rx="1.2" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/><rect x="9" y="8" width="6" height="6" fill="${strokeColor}"/></svg>`;
        } else if (type === "book") {
          // Book icon for schools (solid)
          html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;"><path d="M3 6h9v11H3z" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/><path d="M12 6h9v11h-9z" fill="${shadeColor(
            color,
            -10
          )}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/><path d="M6 8h6" stroke="${strokeColor}" stroke-width="1.2"/></svg>`;
        } else if (type === "graduation") {
          // Graduation cap (toga) — make more visible: colored circular background + white cap
          html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;"><circle cx="12" cy="11" r="9" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/><polygon points="12,5 4,9 12,13 20,9" fill="#ffffff" stroke="#ffffff" stroke-width="1"/><rect x="11" y="13" width="2" height="5" fill="#ffffff"/><path d="M16 7.5 L17.5 6.5" stroke="#ffffff" stroke-width="1.2"/></svg>`;
        } else if (type === "tourism") {
          // Tourism icon (camera-like) with solid fill
          html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;"><rect x="3" y="6" width="18" height="12" rx="2" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/><circle cx="12" cy="12" r="3" fill="#ffffff"/></svg>`;
        } else if (type === "industry") {
          // Factory / industry (solid)
          html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;"><rect x="2" y="10" width="20" height="8" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/><rect x="4" y="6" width="4" height="6" fill="${shadeColor(
            color,
            -30
          )}" stroke="${strokeColor}" stroke-width="1"/><rect x="12" y="6" width="3" height="5" fill="${shadeColor(color, -20)}" stroke="${strokeColor}" stroke-width="1"/></svg>`;
        } else if (type === "bank") {
          // Bank facade with columns (solid)
          html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;"><polygon points="12,3 3,8 21,8" fill="${shadeColor(
            color,
            -30
          )}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/><rect x="4" y="9" width="16" height="10" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/><rect x="7" y="12" width="2" height="6" fill="${strokeColor}"/><rect x="11" y="12" width="2" height="6" fill="${strokeColor}"/><rect x="15" y="12" width="2" height="6" fill="${strokeColor}"/></svg>`;
        } else if (type === "hotel") {
          // Hotel building with windows (solid)
          html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;"><rect x="3" y="4" width="18" height="16" rx="1.5" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/><rect x="6" y="8" width="3" height="2" fill="#ffffff"/><rect x="10" y="8" width="3" height="2" fill="#ffffff"/><rect x="14" y="8" width="3" height="2" fill="#ffffff"/></svg>`;
        } else if (type === "market") {
          // Market shed style (solid)
          html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;"><polygon points="2,9 12,3 22,9 22,20 2,20" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}"/><rect x="5" y="12" width="4" height="6" fill="${shadeColor(
            color,
            -30
          )}" stroke="${strokeColor}" stroke-width="1"/></svg>`;
        } else {
          // fallbacks to previous shapes
          if (type === "square") {
            html = `<svg width="${size}" height="${size}" viewBox="0 0 24 24" style="display:block;"><rect x="2" y="2" width="20" height="20" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}" /></svg>`;
          } else if (type === "diamond") {
            html = `<svg width="${size + 2}" height="${size + 2}" viewBox="0 0 24 24" style="display:block;"><polygon points="12,2 22,12 12,22 2,12" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}" /></svg>`;
          } else if (type === "star") {
            html = `<svg width="${size + 4}" height="${
              size + 4
            }" viewBox="0 0 24 24" style="display:block;"><polygon points="12,2 15,9 22,9 17,14 19,21 12,17 5,21 7,14 2,9 9,9" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}" /></svg>`;
          } else if (type === "hexagon") {
            html = `<svg width="${size + 2}" height="${size + 2}" viewBox="0 0 24 24" style="display:block;"><polygon points="12,2 21,7 21,17 12,22 3,17 3,7" fill="${color}" stroke="${strokeColor}" stroke-width="${strokeWidth}" /></svg>`;
          } else if (type === "h") {
            html = `<div style="width:${size}px; height:${size}px; color:${color}; font-weight:900; font-family:sans-serif; font-size:${Math.round(
              size * 0.9
            )}px; line-height:${size}px; text-align:center; text-shadow: -1px -1px 0 ${strokeColor}, 1px -1px 0 ${strokeColor}, -1px 1px 0 ${strokeColor}, 1px 1px 0 ${strokeColor};">H</div>`;
          }
        }

        var icon = L.divIcon({
          className: "custom-div-icon",
          html: html,
          iconSize: [size, size],
          iconAnchor: [size / 2, size / 2],
        });

        return L.marker(latlng, { icon: icon });
      }

      // Helper: shade color (simple darker/lighten)
      function shadeColor(color, percent) {
        try {
          var f = color.slice(1),
            t = percent < 0 ? 0 : 255,
            p = percent < 0 ? percent * -1 : percent,
            R = parseInt(f.substring(0, 2), 16),
            G = parseInt(f.substring(2, 4), 16),
            B = parseInt(f.substring(4, 6), 16);
          return "#" + (0x1000000 + (Math.round((t - R) * p) + R) * 0x10000 + (Math.round((t - G) * p) + G) * 0x100 + (Math.round((t - B) * p) + B)).toString(16).slice(1);
        } catch (e) {
          return color;
        }
      }

      // --- LAYER LOADERS (Apply Text Wrapping Here) ---

      var layerStorage = {};
      var originalLayerData = {}; // Store raw GeoJSON for resetting
      var activeLayerConfigs = {}; // Store config (shapeType, colorFunc) to re-render
      var currentFilterPoly = null; // Buffer polygon for filtering

      // FIX: Helper to handle coordinate projection for filtering
      function getNormalizedCoord(coords) {
        // Check if Mercator (large values)
        // Usually Mercator bounds are huge, so checking > 180 is safe for Lon/Lat
        if (Math.abs(coords[0]) > 180 || Math.abs(coords[1]) > 180) {
          var latlon = mercatorToLatLon(coords[0], coords[1]);
          // mercatorToLatLon returns [lat, lon], Turf expects [lon, lat]
          return [latlon[1], latlon[0]];
        }
        return [coords[0], coords[1]];
      }

      function filterData(data, poly) {
        // Filter GeoJSON features based on polygon inclusion
        if (!data || !data.features) return data;

        // Safe check for Turf
        if (typeof turf === "undefined") {
          console.warn("Turf.js not loaded");
          return data;
        }

        var filteredFeatures = data.features.filter(function (f) {
          if (!f.geometry || !f.geometry.coordinates) return false;

          // Only handle Point for now (as facility layers are Points)
          if (f.geometry.type === "Point") {
            // NORMALIZE COORDINATES TO WGS84 BEFORE CHECK
            var norm = getNormalizedCoord(f.geometry.coordinates);
            var tempFeat = turf.point(norm);
            try {
              return turf.booleanPointInPolygon(tempFeat, poly);
            } catch (e) {
              return false;
            }
          }
          return false;
        });
        return { type: "FeatureCollection", features: filteredFeatures };
      }

      function renderLayer(key, data) {
        var config = activeLayerConfigs[key];
        if (!config) return;

        // Remove existing if any (refresh)
        if (layerStorage[key] && map.hasLayer(layerStorage[key])) {
          map.removeLayer(layerStorage[key]);
        }

        var geojsonOptions = {
          coordsToLatLng: function (coords) {
            if (Math.abs(coords[0]) > 180 || Math.abs(coords[1]) > 180) {
              var latlon = mercatorToLatLon(coords[0], coords[1]);
              return new L.LatLng(latlon[0], latlon[1]);
            }
            return new L.LatLng(coords[1], coords[0]);
          },
          pointToLayer: function (feature, latlng) {
            var p = feature.properties;
            var val = p.kategori || p.keterangan || "";
            var color = config.colorFunc(val);
            return createCustomMarker(latlng, config.shapeType, color, p);
          },
          onEachFeature: function (feature, layer) {
            var p = feature.properties;
            // Updated Logic to support NAME/LABEL from new files
            var nm = p.namobj || p.NAME || p.LABEL || key;
            var ket = p.keterangan || p.kategori || p.DESCR || "-";

            layer.bindPopup("<b>" + nm + "</b><br/>" + ket);
            if (nm) {
              var formattedLabel = formatLabelText(nm);
              layer.bindTooltip(formattedLabel, { permanent: true, direction: "top", className: "feature-label", offset: [0, -8] });
            }
          },
        };

        // Layers that should use marker clustering (behaviour similar to 'sekolah')
        var clusterKeys = { ibm: true, bank: true, dtw: true, hotel: true };
        if (clusterKeys[key]) {
          var cluster = L.markerClusterGroup();
          var gj = L.geoJSON(data, geojsonOptions);
          cluster.addLayer(gj);
          map.addLayer(cluster);
          layerStorage[key] = cluster;
        } else {
          var lyr = L.geoJSON(data, geojsonOptions).addTo(map);
          layerStorage[key] = lyr;
        }
      }

      function loadLayer(key, url, shapeType, colorFunc) {
        activeLayerConfigs[key] = { shapeType: shapeType, colorFunc: colorFunc };

        // If already loaded/filtered, just add (unless we need to refetch?)
        // Better to check if we have data. If we have original data, we just render (filtered or not)
        if (originalLayerData[key]) {
          var dataToRender = originalLayerData[key];
          if (currentFilterPoly) {
            dataToRender = filterData(dataToRender, currentFilterPoly);
          }
          renderLayer(key, dataToRender);
          return;
        }

        fetchGeoJSON(url)
          .then(function (data) {
            originalLayerData[key] = data; // Save raw
            var dataToRender = data;
            if (currentFilterPoly) {
              dataToRender = filterData(data, currentFilterPoly);
            }
            renderLayer(key, dataToRender);
          })
          .catch((err) => {
            console.error("Layer error " + key, err);
            alert("Gagal memuat layer: " + key + "\nFile mungkin tidak ditemukan: " + url);
          });
      }

      // --- Custom Cluster for Education (Circle) ---
      function renderSekolah(data) {
        if (layerStorage["sekolah"] && map.hasLayer(layerStorage["sekolah"])) {
          map.removeLayer(layerStorage["sekolah"]);
        }

        var cluster = L.markerClusterGroup({
          spiderfyShapePositions: function (count, centerPt) {
            var distanceFromCenter = 35,
              markerDistance = 45,
              lineLength = markerDistance * (count - 1),
              lineStart = centerPt.y - lineLength / 2,
              res = [];
            for (var i = count - 1; i >= 0; i--) {
              res[i] = new L.Point(centerPt.x + distanceFromCenter, lineStart + markerDistance * i);
            }
            return res;
          },
        });

        var gj = L.geoJSON(data, {
          coordsToLatLng: function (coords) {
            if (Math.abs(coords[0]) > 180 || Math.abs(coords[1]) > 180) {
              var latlon = mercatorToLatLon(coords[0], coords[1]);
              return new L.LatLng(latlon[0], latlon[1]);
            }
            return new L.LatLng(coords[1], coords[0]);
          },
          pointToLayer: function (feature, latlng) {
            var col = getSekolahColor(feature.properties.keterangan);
            // Use book icon for Sekolah
            return createCustomMarker(latlng, "book", col, feature.properties);
          },
          onEachFeature: function (feature, layer) {
            var p = feature.properties;
            layer.bindPopup("<b>" + (p.namobj || "Sekolah") + "</b><br/>" + (p.keterangan || "-"));
            if (p.namobj) {
              var formattedLabel = formatLabelText(p.namobj);
              layer.bindTooltip(formattedLabel, { permanent: true, direction: "top", className: "feature-label", offset: [0, -8] });
            }
          },
        });
        cluster.addLayer(gj);
        map.addLayer(cluster);
        layerStorage["sekolah"] = cluster;
      }

      function loadSekolahCluster() {
        if (originalLayerData["sekolah"]) {
          var data = originalLayerData["sekolah"];
          if (currentFilterPoly) data = filterData(data, currentFilterPoly);
          renderSekolah(data);
          return;
        }

        fetchGeoJSON("ONLINE_DIKPORA_SEKOLAH_DASAR_MENENGAH_PT.geojson")
          .then((data) => {
            originalLayerData["sekolah"] = data;
            var dataToRender = data;
            if (currentFilterPoly) dataToRender = filterData(data, currentFilterPoly);
            renderSekolah(dataToRender);
          })
          .catch((err) => {
            console.error("Layer error sekolah", err);
            alert("Gagal memuat layer Sekolah");
          });
      }

      // --- FILTERING LOGIC ---
      function applyAdminFilter(feature) {
        // 1. Create Buffer 1km
        // Make sure feature is valid WGS84 (Admin layers seem to be WGS84 based on loader)
        var buffered = turf.buffer(feature, 1, { units: "kilometers" });
        currentFilterPoly = buffered;

        // 2. Refresh all active layers
        Object.keys(activeLayerConfigs).forEach(function (key) {
          // Only if layer is currently on map (checked)
          if (layerStorage[key] && map.hasLayer(layerStorage[key])) {
            var raw = originalLayerData[key];
            if (raw) {
              var filtered = filterData(raw, currentFilterPoly);
              renderLayer(key, filtered);
            }
          }
        });

        // Refresh Sekolah if active
        if (layerStorage["sekolah"] && map.hasLayer(layerStorage["sekolah"])) {
          var raw = originalLayerData["sekolah"];
          if (raw) {
            var filtered = filterData(raw, currentFilterPoly);
            renderSekolah(filtered);
          }
        }

        // Generate analysis chart for the selected admin unit
        try {
          generateAdminAnalysis();
        } catch (e) {
          console.warn('Admin analysis error', e);
        }
      }

      function clearAdminFilter() {
        currentFilterPoly = null;

        // Restore all
        Object.keys(activeLayerConfigs).forEach(function (key) {
          if (layerStorage[key] && map.hasLayer(layerStorage[key])) {
            var raw = originalLayerData[key];
            if (raw) renderLayer(key, raw);
          }
        });

        if (layerStorage["sekolah"] && map.hasLayer(layerStorage["sekolah"])) {
          var raw = originalLayerData["sekolah"];
          if (raw) renderSekolah(raw);
        }

        // Clear analysis panel
        clearAdminAnalysis();
      }

      // --- ADMIN ANALYSIS: generate counts and render simple SVG bar chart ---
      function getActiveLayerDisplayName(key) {
        var mapNames = {
          kantor: 'Kantor',
          perkantoran: 'Perkantoran',
          rs: 'Rumah Sakit',
          puskesmas: 'Puskesmas',
          klinik: 'Klinik',
          sekolah: 'Sekolah',
          kampus: 'Perg. Tinggi',
          pasar: 'Pasar',
          ibm: 'Industri',
          bank: 'Bank',
          dtw: 'Obj. Wisata',
          hotel: 'Hotel'
        };
        return mapNames[key] || key;
      }

      function generateAdminAnalysis() {
        console.debug('generateAdminAnalysis: currentFilterPoly present?', !!currentFilterPoly);
        var container = document.getElementById('admin_analysis');
        var chart = document.getElementById('admin_analysis_chart');
        if (!container || !chart) return;
        container.style.display = 'block';

        if (!currentFilterPoly) {
          chart.innerHTML = '<div style="font-size:12px;color:#666">Tidak ada wilayah terpilih.</div>';
          return;
        }

        var results = [];
        Object.keys(activeLayerConfigs).forEach(function(key){
          try {
            if (layerStorage[key] && map.hasLayer(layerStorage[key])) {
              var raw = originalLayerData[key];
              if (!raw) return;
              var filtered = filterData(raw, currentFilterPoly);
              var count = (filtered && filtered.features) ? filtered.features.length : 0;
              var color = '#777';
              try { color = (activeLayerConfigs[key].colorFunc||function(){return '#777';})(''); } catch(e){}
              results.push({ key: key, label: getActiveLayerDisplayName(key), count: count, color: color });
            }
          } catch (e) {}
        });

        // Also include sekolah if active (its storage may be a cluster)
        if (layerStorage['sekolah'] && map.hasLayer(layerStorage['sekolah']) && originalLayerData['sekolah']) {
          var f = filterData(originalLayerData['sekolah'], currentFilterPoly);
          results.push({ key: 'sekolah', label: getActiveLayerDisplayName('sekolah'), count: (f && f.features)?f.features.length:0, color: getSekolahColor('') });
        }

        // Sort descending
        results.sort(function(a,b){return b.count - a.count;});

        // Keep last analysis data for export/fallback
        window.adminAnalysisData = results;

        updateAdminChart(results);
      }

      function clearAdminAnalysis(){
        var container = document.getElementById('admin_analysis');
        if (container) {
          container.style.display = 'none';
        }
        try {
          if (window.adminChart) {
            window.adminChart.destroy();
            window.adminChart = null;
          }
        } catch(e){}
      }

      function updateAdminChart(data) {
        var canvas = document.getElementById('adminChartCanvas');
        if (!canvas) return;
        var ctx = canvas.getContext('2d');
        if (!data || data.length === 0) {
          clearAdminAnalysis();
          canvas.style.background = '#fafafa';
          return;
        }

        var labels = data.map(d=>d.label);
        var counts = data.map(d=>d.count);
        var colors = data.map(d=>d.color || '#777');


        // Destroy previous chart if exists
        if (window.adminChart) {
          try { window.adminChart.destroy(); } catch(e){}
          window.adminChart = null;
        }

        // If Chart.js is not available, render a textual fallback summary
        if (typeof Chart === 'undefined') {
          console.error('Chart.js not available — rendering textual fallback.');
          // hide canvas and create a fallback div
          canvas.style.display = 'none';
          var parent = canvas.parentNode;
          var fallbackId = 'adminChartFallback';
          var existing = document.getElementById(fallbackId);
          if (existing) existing.parentNode.removeChild(existing);
          var fallback = document.createElement('div');
          fallback.id = fallbackId;
          fallback.style.width = (canvas.width || 220) + 'px';
          fallback.style.height = (canvas.height || 160) + 'px';
          fallback.style.overflow = 'auto';
          fallback.style.padding = '6px';
          fallback.style.boxSizing = 'border-box';
          fallback.style.background = '#fafafa';
          fallback.style.border = '1px solid #eee';
          if (data.length === 0) {
            fallback.innerHTML = '<div style="color:#666;font-size:13px">Tidak ada fitur aktif di wilayah ini.</div>';
          } else {
            var html = '<table style="width:100%;font-size:13px;border-collapse:collapse"><tbody>';
            for (var i=0;i<data.length;i++){
              html += '<tr><td style="padding:4px 6px;border-bottom:1px solid #f1f1f1">'+escapeHtml(data[i].label)+'</td><td style="padding:4px 6px;border-bottom:1px solid #f1f1f1;text-align:right">'+data[i].count+'</td></tr>';
            }
            html += '</tbody></table>';
            fallback.innerHTML = html;
          }
          parent.insertBefore(fallback, canvas.nextSibling);
          // ensure export buttons still work (CSV uses window.adminAnalysisData)
          var container = document.getElementById('admin_analysis');
          if (container) container.style.display = 'block';
          return;
        }

        // Build plugins list only if datalabels plugin is available
        var pluginsList = [];
        var optionsPlugins = { legend: { display: false } };
        if (typeof ChartDataLabels !== 'undefined') {
          pluginsList.push(ChartDataLabels);
          optionsPlugins.datalabels = { anchor: 'end', align: 'right', color: '#111', font: { weight: '600' }, formatter: function(v){return v;} };
        }

        canvas.style.display = '';
        window.adminChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: labels,
            datasets: [{ label: 'Jumlah', data: counts, backgroundColor: colors }]
          },
          options: {
            indexAxis: 'y',
            responsive: false,
            maintainAspectRatio: false,
            plugins: optionsPlugins,
            scales: {
              x: { beginAtZero: true, ticks: { precision:0 } },
              y: { ticks: { autoSkip: false } }
            }
          },
          plugins: pluginsList
        });

        // show container
        var container = document.getElementById('admin_analysis');
        if (container) container.style.display = 'block';
      }

      function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>\"']/g,function(c){return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]||c;}); }

      // Attach toggle for debug panel
      (function(){
        var btn = document.getElementById('btn_toggle_fetch_debug');
        if (!btn) return;
        btn.addEventListener('click', function(){
          var el = document.getElementById('fetch_debug');
          if (!el) return;
          if (el.style.display === 'none' || !el.style.display) el.style.display = 'block'; else el.style.display = 'none';
        });
      })();

      // --- Event Listeners ---

      // 1. Pemerintah
      document.getElementById("layer_kantor_pemerintah").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_kantor");
        if (e.target.checked) {
          loadLayer("kantor", "TOPONIMI_KANTORPEMERINTAH_PT.geojson", "gov_building", getGovColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["kantor"]) map.removeLayer(layerStorage["kantor"]);
          lg.style.display = "none";
        }
      });

      // NEW: Perkantoran BPN
      document.getElementById("layer_perkantoran").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_perkantoran");
        if (e.target.checked) {
          loadLayer("perkantoran", "ONLINE_BIDPERTANAHAN_PERKANTORAN_PT.geojson", "office_building", getPerkantoranColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["perkantoran"]) map.removeLayer(layerStorage["perkantoran"]);
          lg.style.display = "none";
        }
      });

      // 2. Kesehatan
      document.getElementById("layer_rs").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_rs");
        if (e.target.checked) {
          loadLayer("rs", "ONLINE_DINKES_RUMAHSAKIT_PT.geojson", "hospital", getRSColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["rs"]) map.removeLayer(layerStorage["rs"]);
          lg.style.display = "none";
        }
      });
      document.getElementById("layer_puskesmas").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_puskesmas");
        if (e.target.checked) {
          loadLayer("puskesmas", "ONLINE_DINKES_PUSKESMAS_PT.geojson", "hospital", getPuskesmasColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["puskesmas"]) map.removeLayer(layerStorage["puskesmas"]);
          lg.style.display = "none";
        }
      });
      document.getElementById("layer_klinik").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_klinik");
        if (e.target.checked) {
          loadLayer("klinik", "ONLINE_DINKES_KLINIK_PT.geojson", "hospital", getKlinikColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["klinik"]) map.removeLayer(layerStorage["klinik"]);
          lg.style.display = "none";
        }
      });

      // 3. Pendidikan
      document.getElementById("layer_sekolah").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_sekolah");
        if (e.target.checked) {
          loadSekolahCluster();
          lg.style.display = "block";
        } else {
          if (layerStorage["sekolah"]) map.removeLayer(layerStorage["sekolah"]);
          lg.style.display = "none";
        }
      });

      document.getElementById("layer_kampus").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_kampus");
        if (e.target.checked) {
          loadLayer("kampus", "ONLINE_AGOL_PENDIDIKANTINGGI_PT.geojson", "graduation", getKampusColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["kampus"]) map.removeLayer(layerStorage["kampus"]);
          lg.style.display = "none";
        }
      });

      // 4. Ekonomi
      document.getElementById("layer_pasar").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_pasar");
        if (e.target.checked) {
          loadLayer("pasar", "ONLINE_DISPERINDAG_PASAR_PT.geojson", "market", getPasarColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["pasar"]) map.removeLayer(layerStorage["pasar"]);
          lg.style.display = "none";
        }
      });

      document.getElementById("layer_ibm").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_ibm");
        if (e.target.checked) {
          loadLayer("ibm", "ONLINE_DISPERINDAG_IBM_2024_PT.geojson", "industry", getIbmColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["ibm"]) map.removeLayer(layerStorage["ibm"]);
          lg.style.display = "none";
        }
      });

      // NEW: Bank BPN
      document.getElementById("layer_bank").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_bank");
        if (e.target.checked) {
          loadLayer("bank", "ONLINE_BIDPERTANAHAN_BANK_PT.geojson", "bank", getBankColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["bank"]) map.removeLayer(layerStorage["bank"]);
          lg.style.display = "none";
        }
      });

      // 5. Pariwisata
      document.getElementById("layer_dtw").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_dtw");
        if (e.target.checked) {
          loadLayer("dtw", "ONLINE_DISPAR_KUNJUNGAN_DTW_2024_PT.geojson", "tourism", getDtwColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["dtw"]) map.removeLayer(layerStorage["dtw"]);
          lg.style.display = "none";
        }
      });

      // NEW: Hotel BPN
      document.getElementById("layer_hotel").addEventListener("change", function (e) {
        var lg = document.getElementById("legend_hotel");
        if (e.target.checked) {
          loadLayer("hotel", "ONLINE_BIDPERTANAHAN_HOTEL_PT.geojson", "hotel", getHotelColor);
          lg.style.display = "block";
        } else {
          if (layerStorage["hotel"]) map.removeLayer(layerStorage["hotel"]);
          lg.style.display = "none";
        }
      });

      // --- 6. BENCANA (BNPB - ESRI) ---
      // Variable to store multiple layer references
      var bnpbLayers = {};

      // Create a specific Pane for Disaster Layers to ensure they are ABOVE basemaps but BELOW markers
      map.createPane("bencanaPane");
      map.getPane("bencanaPane").style.zIndex = 300; // Above TilePane (200), below OverlayPane (400) & MarkerPane (600)
      map.getPane("bencanaPane").style.pointerEvents = "none"; // Allow clicks to pass through to map

      // Generic helper to toggle BNPB ImageServer Layers
      function toggleBnpbLayer(layerKey, url, isChecked) {
        var loader = document.getElementById("loading-indicator");

        if (isChecked) {
          if (typeof L.esri === "undefined") {
            alert("Library Esri Leaflet belum siap. Mohon tunggu sejenak atau refresh halaman.");
            document.getElementById("layer_bencana_" + layerKey).checked = false;
            return;
          }

          // Create layer if not exists
          if (!bnpbLayers[layerKey]) {
            var lyr = L.esri.imageMapLayer({
              url: url,
              opacity: 0.7,
              attribution: "BNPB InaRisk",
              pane: "bencanaPane",
            });

            // Feedback Events
            lyr.on("loading", function () {
              loader.style.display = "block";
              document.body.style.cursor = "wait";
            });
            lyr.on("load", function () {
              loader.style.display = "none";
              document.body.style.cursor = "default";
            });

            // Error Handling
            lyr.on("error", function (ev) {
              loader.style.display = "none";
              document.body.style.cursor = "default";

              var msg = "Unknown error";
              if (ev && ev.error && ev.error.message) msg = ev.error.message;
              else if (ev && ev.message) msg = ev.message;

              console.warn("BNPB Layer Issue (" + layerKey + "): " + msg);

              alert("Gagal memuat layer (" + msg + "). Layer mungkin tidak tersedia.");

              // Async Removal
              document.getElementById("layer_bencana_" + layerKey).checked = false;
              setTimeout(function () {
                if (bnpbLayers[layerKey] && map.hasLayer(bnpbLayers[layerKey])) {
                  map.removeLayer(bnpbLayers[layerKey]);
                }
                bnpbLayers[layerKey] = null;
              }, 100);
            });

            bnpbLayers[layerKey] = lyr;
          }

          bnpbLayers[layerKey].addTo(map);

          // Specific Logic for Tsunami (Auto Pan to Coast)
          if (layerKey === "tsunami") {
            var center = map.getCenter();
            // If in Jogja city area, move to coast
            if (center.lat > -7.9 && center.lat < -7.0 && center.lng > 110.0 && center.lng < 111.0) {
              map.setView([-8.02, 110.35], 13);
              loader.style.display = "block";
              setTimeout(function () {
                alert("Peta digeser ke pesisir selatan untuk menampilkan area Bahaya Tsunami.");
              }, 500);
            }
          }
        } else {
          // Remove Layer
          if (bnpbLayers[layerKey] && map.hasLayer(bnpbLayers[layerKey])) {
            map.removeLayer(bnpbLayers[layerKey]);
            loader.style.display = "none";
          }
        }
      }

      // Export handlers for admin analysis
      var _btn_png = document.getElementById('btn_export_png');
      if (_btn_png) _btn_png.addEventListener('click', function(){
        try {
          if (!window.adminChart) { alert('Tidak ada chart untuk diekspor'); return; }
          var link = document.createElement('a');
          link.href = window.adminChart.toBase64Image();
          link.download = 'admin_analysis.png';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        } catch(e){ alert('Export PNG gagal: '+e.message); }
      });

      var _btn_csv = document.getElementById('btn_export_csv');
      if (_btn_csv) _btn_csv.addEventListener('click', function(){
        try {
          // Prefer chart data, but fall back to window.adminAnalysisData
          var labels = [];
          var data = [];
          if (window.adminChart && window.adminChart.data) {
            labels = window.adminChart.data.labels || [];
            data = (window.adminChart.data.datasets && window.adminChart.data.datasets[0].data) || [];
          } else if (window.adminAnalysisData) {
            labels = window.adminAnalysisData.map(d=>d.label);
            data = window.adminAnalysisData.map(d=>d.count);
          } else {
            alert('Tidak ada data untuk diekspor');
            return;
          }
          var csv = 'label,count\n';
          for (var i=0;i<labels.length;i++) csv += '"'+String(labels[i]).replace(/"/g,'""')+'",'+(data[i]||0)+'\n';
          var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
          var url = URL.createObjectURL(blob);
          var a = document.createElement('a');
          a.href = url; a.download = 'admin_analysis.csv';
          document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
        } catch(e){ alert('Export CSV gagal: '+e.message); }
      });

      // Configuration for BNPB Layers
      var bnpbConfigs = [
        { key: "tsunami", url: "https://gis.bnpb.go.id/server/rest/services/inarisk/layer_bahaya_tsunami/ImageServer" },
        { key: "gempa", url: "https://gis.bnpb.go.id/server/rest/services/inarisk/layer_bahaya_gempabumi/ImageServer" },
        { key: "longsor", url: "https://gis.bnpb.go.id/server/rest/services/inarisk/layer_bahaya_tanah_longsor/ImageServer" },
        { key: "erupsi", url: "https://gis.bnpb.go.id/server/rest/services/inarisk/layer_bahaya_letusan_gunungapi/ImageServer" },
      ];

      // Bind Listeners
      bnpbConfigs.forEach(function (conf) {
        var el = document.getElementById("layer_bencana_" + conf.key);
        if (el) {
          el.addEventListener("change", function (e) {
            toggleBnpbLayer(conf.key, conf.url, e.target.checked);
          });
        }
      });

      // --- Point Collection Logic (UPDATED FROM UPLOADED FILE) ---
      var allPoints = [];
      var tempMarker = null;

      // DOM Elements for Collector
      var respondentIdEl = document.getElementById("respondent_id");
      var stakeholderEl = document.getElementById("stakeholder_group");
      var mappingObjectEl = document.getElementById("mapping_object");
      var pointIdEl = document.getElementById("point_id");
      var reasonEl = document.getElementById("reason");
      var mapSourceEl = document.getElementById("map_source");
      var accuracyEl = document.getElementById("accuracy_m");
      var pointsCountEl = document.getElementById("pointsCount");
      var pointsTable = document.getElementById("pointsTable");
      var pointsTableBody = pointsTable.querySelector("tbody");

      function currentRespondentId() {
        return respondentIdEl.value ? respondentIdEl.value.trim() : "";
      }
      function pointsForRespondent(rid) {
        return allPoints.filter(function (p) {
          return p.respondent_id === rid;
        });
      }

      function resetFormFields() {
        if (pointIdEl) {
          pointIdEl.value = "";
          pointIdEl.removeAttribute("data-lat");
          pointIdEl.removeAttribute("data-lon");
        }
        if (reasonEl) reasonEl.value = "";
        if (mapSourceEl) mapSourceEl.value = "webGIS";
        if (accuracyEl) accuracyEl.value = "";
        // Optional: clear mapping_object? The request says "reset whatever is written in the form".
        // But usually we don't clear Respondent ID as it's session-based.
        // We will clear mapping_object to be safe as per "reset whatever is written" instruction for a fresh start.
        if (mappingObjectEl) mappingObjectEl.value = "";
      }

      // --- REVISI 1: AUTO GENERATE POINT ID ---
      function updatePointIdPreview() {
        var mo = mappingObjectEl ? mappingObjectEl.value.trim() : "";
        if (!mo) {
          pointIdEl.value = "";
          return;
        }

        // Hitung berapa point yg SUDAH ada dengan prefix mapping object yg sama
        // Logic: cari point yang mapping_object-nya sama persis (case insensitive?)
        // User bilang "nomor terisi otomatis", asumsi incremental
        var count = 0;
        allPoints.forEach(function (p) {
          if (p.mapping_object && p.mapping_object.toLowerCase() === mo.toLowerCase()) {
            count++;
          }
        });
        var nextIdx = count + 1;

        // Format: [MappingObject]_[No]
        pointIdEl.value = mo + "_" + nextIdx;
      }

      // Listener saat Mapping Object diketik
      if (mappingObjectEl) {
        mappingObjectEl.addEventListener("input", updatePointIdPreview);
      }

      // Map Click Handler (Enhanced)
      map.on("click", function (e) {
        if (tempMarker) map.removeLayer(tempMarker);
        tempMarker = L.marker(e.latlng, { draggable: true }).addTo(map);

        // Auto update input if marker is dragged
        tempMarker.on("dragend", function (ev) {
          var ll = ev.target.getLatLng();
          if (pointIdEl) {
            pointIdEl.dataset.lat = ll.lat;
            pointIdEl.dataset.lon = ll.lng;
          }
        });

        // Trigger update ID saat klik peta (just in case input sudah ada isinya)
        updatePointIdPreview();

        if (pointIdEl) {
          pointIdEl.dataset.lat = e.latlng.lat;
          pointIdEl.dataset.lon = e.latlng.lng;
        }
      });

      // Save Point Handler (Enhanced with Validation)
      document.getElementById("savePointBtn").addEventListener("click", function () {
        var rid = currentRespondentId();
        var mo = mappingObjectEl ? mappingObjectEl.value.trim() : "";

        // VALIDATION: Mandatory Fields
        if (!rid) {
          alert("Respondent ID wajib diisi!");
          return;
        }
        if (!mo) {
          alert("Mapping Object wajib diisi!");
          return;
        }

        if (!pointIdEl || !pointIdEl.dataset.lat || !pointIdEl.dataset.lon) {
          alert("Silakan klik peta untuk memilih lokasi terlebih dahulu.");
          return;
        }

        var lat = parseFloat(pointIdEl.dataset.lat);
        var lon = parseFloat(pointIdEl.dataset.lon);

        // RE-CALCULATE ID TO BE SAFE (mencegah duplikat jika user tidak mengetik ulang)
        // Atau gunakan nilai yang ada di input jika user sudah melihatnya
        // Sesuai request: "Nomor dapat terisi secara otomatis" -> Kita percaya fungsi updatePointIdPreview()
        // Namun, jika user klik save berkali-kali tanpa ubah input, kita harus pastikan unik?
        // Mari kita hitung ulang index saat save untuk jaminan unik.
        var count = 0;
        allPoints.forEach(function (p) {
          if (p.mapping_object && p.mapping_object.toLowerCase() === mo.toLowerCase()) {
            count++;
          }
        });
        var pid = mo + "_" + (count + 1);

        // Update input field visual
        pointIdEl.value = pid;

        var acc = accuracyEl && accuracyEl.value ? accuracyEl.value.trim() : "";

        var rec = {
          respondent_id: rid || "",
          stakeholder_group: stakeholderEl ? stakeholderEl.value : "",
          mapping_object: mo,
          point_id: pid,
          latitude: lat,
          longitude: lon,
          timestamp: new Date().toISOString(),
          reason: reasonEl ? (reasonEl.value ? reasonEl.value.trim() : "") : "",
          map_source: mapSourceEl ? mapSourceEl.value : "",
          accuracy_m: acc,
        };

        var marker = L.circleMarker([lat, lon], { radius: 6, color: "#d9534f" }).addTo(map);
        var popupParts = ["<b>" + pid + "</b>"];
        if (rec.mapping_object) popupParts.push("<i>" + rec.mapping_object + "</i>");
        if (rec.reason) popupParts.push(rec.reason);
        marker.bindPopup(popupParts.join("<br/>"));

        rec.marker = marker;
        allPoints.push(rec);

        if (tempMarker) {
          map.removeLayer(tempMarker);
          tempMarker = null;
        }

        // Reset specific fields (keep Respondent ID for flow)
        if (pointIdEl) {
          pointIdEl.value = "";
          pointIdEl.removeAttribute("data-lat");
          pointIdEl.removeAttribute("data-lon");
        }
        if (reasonEl) reasonEl.value = "";
        if (accuracyEl) accuracyEl.value = "";

        // Update next ID preview immediately
        updatePointIdPreview();
        updatePointsUI();
      });

      // Clear Form Listener (New Feature)
      document.getElementById("clearFormBtn").addEventListener("click", function () {
        if (confirm("Apakah Anda yakin ingin membersihkan form? Data yang belum disimpan di form akan hilang.")) {
          resetFormFields();
          if (tempMarker) {
            map.removeLayer(tempMarker);
            tempMarker = null;
          }
        }
      });

      function updatePointsUI() {
        var rid = currentRespondentId();
        var pts = rid ? pointsForRespondent(rid) : [];

        // Fallback: if no rid entered, show all (or none).
        if (!rid && allPoints.length > 0) pts = allPoints;

        pointsCountEl.textContent = pts.length + " points";
        pointsTableBody.innerHTML = "";

        if (pts.length > 0) {
          pointsTable.style.display = "table";
          pts.forEach(function (p, i) {
            var tr = document.createElement("tr");
            tr.innerHTML = `<td>${i + 1}</td><td>${p.point_id}</td><td>${p.mapping_object}</td><td>${p.latitude.toFixed(5)}</td><td>${p.longitude.toFixed(5)}</td><td>${
              p.reason ? p.reason.substring(0, 15) + "..." : ""
            }</td><td><button onclick="delPoint('${p.point_id}')" class="btn secondary smallBtn">Del</button></td>`;
            pointsTableBody.appendChild(tr);
          });
        } else {
          pointsTable.style.display = "none";
        }
      }

      window.delPoint = function (pid) {
        var idx = allPoints.findIndex((p) => p.point_id === pid);
        if (idx >= 0) {
          if (allPoints[idx].marker) map.removeLayer(allPoints[idx].marker);
          allPoints.splice(idx, 1);
          updatePointsUI();
          updatePointIdPreview(); // Update ID next jika ada yg dihapus (optional, tp baik utk konsistensi)
        }
      };

      // Export Helpers (Robust CSV)
      function escapeCsvCell(s) {
        if (s === null || s === undefined) return '""';
        var str = String(s).replace(/"/g, '""');
        return '"' + str + '"';
      }

      function downloadText(filename, text, mimeType) {
        var blob = new Blob(["\uFEFF" + text], { type: mimeType }); // Add BOM
        var link = document.createElement("a");
        var url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      // REVISI 2: Format Nama File Export
      function getExportFilename(extension) {
        var rid = currentRespondentId() || "NoID";

        // Timestamp data terakhir (atau sekarang jika kosong)
        var lastTsStr = "";
        var lastMO = "";

        if (allPoints.length > 0) {
          var lastPt = allPoints[allPoints.length - 1];
          // Format timestamp from ISO to readable compact: YYYYMMDD-HHmm
          var d = new Date(lastPt.timestamp);
          var yyyy = d.getFullYear();
          var mm = String(d.getMonth() + 1).padStart(2, "0");
          var dd = String(d.getDate()).padStart(2, "0");
          var hh = String(d.getHours()).padStart(2, "0");
          var min = String(d.getMinutes()).padStart(2, "0");
          lastTsStr = yyyy + mm + dd + "-" + hh + min;

          lastMO = lastPt.mapping_object || "NoObject";
        } else {
          var d = new Date();
          var yyyy = d.getFullYear();
          var mm = String(d.getMonth() + 1).padStart(2, "0");
          var dd = String(d.getDate()).padStart(2, "0");
          var hh = String(d.getHours()).padStart(2, "0");
          var min = String(d.getMinutes()).padStart(2, "0");
          lastTsStr = yyyy + mm + dd + "-" + hh + min;
          lastMO = "NoData";
        }

        // Sanitasi nama file (hapus karakter aneh)
        var safeMO = lastMO.replace(/[^a-zA-Z0-9-_]/g, "");
        var safeRID = rid.replace(/[^a-zA-Z0-9-_]/g, "");

        return safeRID + "_" + lastTsStr + "_" + safeMO + extension;
      }

      document.getElementById("exportCsv").addEventListener("click", function () {
        var rid = currentRespondentId();
        var arr = rid ? pointsForRespondent(rid) : allPoints;
        if (!arr.length) {
          alert("Tidak ada data.");
          return;
        }

        var header = ["respondent_id", "stakeholder_group", "mapping_object", "point_id", "latitude", "longitude", "timestamp", "reason", "map_source", "accuracy_m"];
        var lines = [header.join(",")];
        arr.forEach(function (r) {
          var row = [
            escapeCsvCell(r.respondent_id),
            escapeCsvCell(r.stakeholder_group),
            escapeCsvCell(r.mapping_object),
            escapeCsvCell(r.point_id),
            r.latitude,
            r.longitude,
            escapeCsvCell(r.timestamp),
            escapeCsvCell(r.reason),
            escapeCsvCell(r.map_source),
            escapeCsvCell(r.accuracy_m),
          ];
          lines.push(row.join(","));
        });

        var fname = getExportFilename(".csv");
        downloadText(fname, lines.join("\n"), "text/csv;charset=utf-8;");
      });

      document.getElementById("exportGeojson").addEventListener("click", function () {
        var rid = currentRespondentId();
        var arr = rid ? pointsForRespondent(rid) : allPoints;
        if (!arr.length) {
          alert("Tidak ada data.");
          return;
        }

        var gj = { type: "FeatureCollection", features: [] };
        arr.forEach(function (p) {
          gj.features.push({
            type: "Feature",
            properties: {
              respondent_id: p.respondent_id,
              stakeholder_group: p.stakeholder_group,
              mapping_object: p.mapping_object,
              point_id: p.point_id,
              timestamp: p.timestamp,
              reason: p.reason,
              map_source: p.map_source,
              accuracy_m: p.accuracy_m,
            },
            geometry: { type: "Point", coordinates: [p.longitude, p.latitude] },
          });
        });

        var fname = getExportFilename(".geojson");
        downloadText(fname, JSON.stringify(gj), "application/geo+json;charset=utf-8;");
      });

      document.getElementById("clearAll").addEventListener("click", function () {
        if (confirm("Hapus semua titik?")) {
          allPoints.forEach((p) => map.removeLayer(p.marker));
          allPoints = [];
          updatePointsUI();
          updatePointIdPreview();
        }
      });

      document.getElementById("respondent_id").addEventListener("input", updatePointsUI);

      // --- Tools Listeners ---
      document.getElementById("getLocationBtn").addEventListener("click", function () {
        if (!navigator.geolocation) {
          alert("Geolocation tidak tersedia.");
          return;
        }
        var btn = this;
        btn.disabled = true;
        btn.textContent = "Locating...";
        navigator.geolocation.getCurrentPosition(
          function (pos) {
            var lat = pos.coords.latitude,
              lon = pos.coords.longitude;
            map.setView([lat, lon], 16);
            var m = L.circleMarker([lat, lon], { radius: 8, color: "#337ab7" }).addTo(map);
            m.bindPopup("<b>Your location</b>").openPopup();
            setTimeout(function () {
              if (map && m) map.removeLayer(m);
            }, 10000);
            btn.disabled = false;
            btn.textContent = "Get my location";
          },
          function (err) {
            alert("Gagal: " + err.message);
            btn.disabled = false;
            btn.textContent = "Get my location";
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });
      document.getElementById("zoomInBtn").addEventListener("click", function () {
        map.zoomIn();
      });
      document.getElementById("zoomOutBtn").addEventListener("click", function () {
        map.zoomOut();
      });
      document.getElementById("centerBtn").addEventListener("click", function () {
        map.setView([-7.8, 110.37], 12);
      });

      // --- Administrative Search Logic (ROBUST VERSION FROM UPLOADED FILE) ---
      var adminLayers = { WADMPR: null, WADMKK: null, WADMCK: null, WADMKD: null };
      var adminLayerLevels = { WADMPR: null, WADMKK: null, WADMCK: null, WADMKD: null };

      function styleFor(level) {
        switch (level) {
          case "prov":
            return { color: "#4b2e83", weight: 5, fill: false, opacity: 0.9 };
          case "kab":
            return { color: "#2b7fb8", weight: 3.5, fill: false, opacity: 0.9 };
          case "kec":
            return { color: "#2c7a3e", weight: 2.5, fill: false, opacity: 0.9 };
          case "desa":
            return { color: "#666", weight: 1.5, fill: false, opacity: 0.9 };
          default:
            return { color: "#000", weight: 1, fill: false };
        }
      }

      async function loadAdminGeojson(key, url, level) {
        // Try multiple paths (Robust)
        var candidates = [url, "data/" + url, url.toLowerCase(), url.replace(/\.geojson$/i, ".json")];

        // Debug attempts
        window.adminFetchAttempts = window.adminFetchAttempts || [];

        if (adminLayers[key]) {
          try {
            map.removeLayer(adminLayers[key]);
          } catch (e) {}
          adminLayers[key] = null;
        }

        for (var i = 0; i < candidates.length; i++) {
          try {
            var attempt = candidates[i];
            try { window.adminFetchAttempts.push(attempt); } catch(e){}
            // update debug UI if present
            try { updateFetchDebugUI(); } catch(e){}

            var resp = await fetch(attempt);
            if (!resp.ok) continue;
            var gj = await resp.json();

            // Create layer but DO NOT add to map yet (keep clean)
            var layer = L.geoJSON(gj, {
              style: styleFor(level),
              onEachFeature: function (feature, lyr) {
                var props = feature.properties || {};
                var name = props.WADMKD || props.WADMKC || props.WADMKK || props.WADMPR || props.NAMOBJ || "";
                lyr.bindTooltip(String(name), { permanent: true, direction: "center", className: "admin-label admin-label-" + level });
              },
            });

            adminLayers[key] = layer;
            adminLayerLevels[key] = level;
            return layer;
          } catch (e) {}
        }
        throw new Error("Gagal memuat layer admin: " + key);
      }

      function keyForLevel(level) {
        if (level === "prov") return "WADMPR";
        if (level === "kab") return "WADMKK";
        if (level === "kec") return "WADMKC";
        return "WADMKD";
      }
      function urlForKey(key) {
        return key + ".geojson";
      }
      function matchName(props) {
        return (props.WADMKD || props.WADMKC || props.WADMKK || props.WADMPR || props.NAMOBJ || "").toString();
      }

      // Helper for debounce
      function debounce(fn, wait) {
        var t;
        return function () {
          var args = arguments;
          clearTimeout(t);
          t = setTimeout(function () {
            fn.apply(null, args);
          }, wait);
        };
      }

      // UI Logic for Admin Search (Autocomplete + Zoom)
      (function () {
        var searchContainer = document.getElementById("admin_search_container");
        searchContainer.innerHTML =
          "<b>Search by Administrative</b><br/>" +
          '<label style="display:block;margin-top:6px; font-weight:600;">Level</label>' +
          '<select id="search_admin_level" style="width:100%; padding:6px; box-sizing:border-box">' +
          '<option value="prov">Provinsi</option>' +
          '<option value="kab">Kabupaten/Kota</option>' +
          '<option value="kec">Kecamatan</option>' +
          '<option value="desa">Desa</option>' +
          "</select>" +
          '<label style="display:block;margin-top:8px; font-weight:600;">Nama wilayah</label>' +
          '<div style="position:relative">' +
          '<input id="search_admin_query" type="text" autocomplete="off" placeholder="Ketik nama..." style="width:100%; padding:6px; box-sizing:border-box" />' +
          '<div id="admin_suggestions" style="position:absolute; left:0; right:0; top:40px; background:#fff; border:1px solid #ddd; max-height:180px; overflow:auto; display:none; z-index:2000;"></div>' +
          "</div>" +
          '<div style="display:flex; gap:8px; margin-top:8px;">' +
          '<button id="btn_admin_search" class="btn">Search</button>' +
          '<button id="btn_admin_clear" class="btn secondary">Clear</button>' +
          "</div>" +
          '<div id="admin_search_results" style="margin-top:8px; max-height:200px; overflow:auto; font-size:13px"></div>';

        var suggestionBox = document.getElementById("admin_suggestions");
        var queryInput = document.getElementById("search_admin_query");
        var highlightLayer = null;

        // 1. Get unique names from a layer
        function getNamesFromLayer(key) {
          return new Promise(function (resolve, reject) {
            var layer = adminLayers[key];
            if (!layer) return reject(new Error("Layer not loaded"));
            var set = {};
            var list = [];
            layer.eachLayer(function (l) {
              var name = matchName(l.feature.properties);
              if (!name) return;
              var n = String(name).trim();
              if (n && !set[n.toLowerCase()]) {
                set[n.toLowerCase()] = true;
                list.push(n);
              }
            });
            resolve(list.sort((a, b) => a.localeCompare(b)));
          });
        }

        // 2. Autocomplete Logic
        function showSuggestions(arr) {
          if (!arr || arr.length === 0) {
            suggestionBox.style.display = "none";
            suggestionBox.innerHTML = "";
            return;
          }
          suggestionBox.innerHTML = "";
          var max = Math.min(arr.length, 10);
          for (var i = 0; i < max; i++) {
            var item = document.createElement("div");
            item.style.padding = "6px 8px";
            item.style.borderBottom = "1px solid #f1f1f1";
            item.style.cursor = "pointer";
            item.textContent = arr[i];
            (function (val) {
              item.onclick = function () {
                queryInput.value = val;
                suggestionBox.style.display = "none";
                document.getElementById("btn_admin_search").click();
              };
            })(arr[i]);
            suggestionBox.appendChild(item);
          }
          suggestionBox.style.display = "block";
        }

        function updateSuggestionsForQuery(q) {
          var level = document.getElementById("search_admin_level").value;
          var key = keyForLevel(level);

          // Ensure layer is loaded first to get names
          var promiseLayer = adminLayers[key] ? Promise.resolve() : loadAdminGeojson(key, urlForKey(key), level);

          promiseLayer
            .then(() => getNamesFromLayer(key))
            .then(function (list) {
              if (!q) {
                suggestionBox.style.display = "none";
                return;
              }
              var mq = q.toLowerCase();
              var filtered = list.filter((s) => s.toLowerCase().indexOf(mq) !== -1);
              showSuggestions(filtered);
            })
            .catch(console.warn);
        }

        var debouncedUpdate = debounce(function () {
          updateSuggestionsForQuery(queryInput.value.trim());
        }, 300);
        queryInput.addEventListener("input", debouncedUpdate);
        queryInput.addEventListener("blur", function () {
          setTimeout(() => (suggestionBox.style.display = "none"), 200);
        });

        // 3. Search & Highlight Logic
        function searchInLayer(key, q) {
          return new Promise(function (resolve, reject) {
            var layer = adminLayers[key];
            if (!layer) return reject("Layer not loaded");
            var matches = [];
            layer.eachLayer(function (l) {
              var name = matchName(l.feature.properties);
              if (name && name.toLowerCase().indexOf(q.toLowerCase()) !== -1) {
                matches.push({ name: name, layer: l, feature: l.feature });
              }
            });
            resolve(matches);
          });
        }

        function hideAllAdminLayers() {
          Object.values(adminLayers).forEach(function (l) {
            if (l && map.hasLayer(l)) map.removeLayer(l);
          });
        }

        function showResultsList(matches) {
          var container = document.getElementById("admin_search_results");
          container.innerHTML = "";

          // Clean up
          hideAllAdminLayers();
          if (highlightLayer) map.removeLayer(highlightLayer);

          if (!matches || matches.length === 0) {
            container.innerHTML = '<div class="small">Tidak ditemukan.</div>';
            return;
          }

          // Highlight ALL matches (Outline Only)
          var fc = { type: "FeatureCollection", features: matches.map((m) => m.feature) };
          highlightLayer = L.geoJSON(fc, {
            style: { color: "#ff7800", weight: 4, fill: false, opacity: 1 },
          }).addTo(map);

          try {
            var b = highlightLayer.getBounds();
            if (b.isValid()) map.fitBounds(b, { padding: [20, 20], maxZoom: 14 });
          } catch (e) {}

          // List items
          matches.forEach(function (m, idx) {
            var row = document.createElement("div");
            row.style.padding = "6px";
            row.style.borderBottom = "1px solid #eee";
            row.style.cursor = "pointer";
            row.innerHTML = "<b>" + (idx + 1) + "</b> " + m.name;

            row.onclick = function () {
              if (highlightLayer) map.removeLayer(highlightLayer);

              // Highlight ONLY this one
              highlightLayer = L.geoJSON(m.feature, {
                style: { color: "#ff7800", weight: 4, fill: false, opacity: 1 },
              }).addTo(map);

              var b = highlightLayer.getBounds();
              map.fitBounds(b, { padding: [20, 20], maxZoom: 15 });

              // --- NEW: APPLY FILTER ---
              applyAdminFilter(m.feature);
            };
            container.appendChild(row);
          });
        }

        document.getElementById("btn_admin_search").addEventListener("click", function () {
          var level = document.getElementById("search_admin_level").value;
          var q = document.getElementById("search_admin_query").value.trim();
          if (!q) {
            alert("Masukkan nama wilayah.");
            return;
          }
          var key = keyForLevel(level);

          if (!adminLayers[key]) {
            loadAdminGeojson(key, urlForKey(key), level)
              .then(function () {
                return searchInLayer(key, q);
              })
              .then(showResultsList)
              .catch((err) => {
                console.warn('Admin layer load failed, using mock fallback', err);
                // Fallback: use mock search (prototype behavior) so analysis can run
                try {
                  var results = performMockSearch(q, level);
                  displaySearchResults(results);
                } catch (e) {
                  console.error('Mock fallback failed', e);
                  alert(err);
                }
              });
          } else {
            searchInLayer(key, q).then(showResultsList);
          }
        });

        document.getElementById("btn_admin_clear").addEventListener("click", function () {
          queryInput.value = "";
          document.getElementById("admin_search_results").innerHTML = "";
          if (highlightLayer) {
            map.removeLayer(highlightLayer);
            highlightLayer = null;
          }
          hideAllAdminLayers();
          adminLayers = { WADMPR: null, WADMKK: null, WADMCK: null, WADMKD: null };

          // --- NEW: CLEAR FILTER ---
          clearAdminFilter();
        });
      })();

        // --- Fallback Mock Search (from V7 prototype) ---
        function performMockSearch(query, level) {
          // Database Dummy Koordinat Jogja
          const locs = [
            { n: "Sleman", lat: -7.71, lon: 110.35, type: "Kabupaten" },
            { n: "Bantul", lat: -7.89, lon: 110.33, type: "Kabupaten" },
            { n: "Kulon Progo", lat: -7.82, lon: 110.16, type: "Kabupaten" },
            { n: "Gunungkidul", lat: -7.97, lon: 110.6, type: "Kabupaten" },
            { n: "Yogyakarta", lat: -7.8, lon: 110.37, type: "Kota" },
            { n: "Depok", lat: -7.76, lon: 110.4, type: "Kecamatan" },
            { n: "Malioboro", lat: -7.79, lon: 110.36, type: "Kawasan" },
            { n: "Kaliurang", lat: -7.6, lon: 110.42, type: "Kawasan" },
          ];

          return locs.filter((l) => l.n.toLowerCase().includes(String(query || "").toLowerCase()));
        }

        function displaySearchResults(results) {
          const list = document.getElementById("admin_results");
          list.style.display = "block";
          list.innerHTML = "";

          if (!results || results.length === 0) {
            list.innerHTML = '<li style="color:#e74c3c; cursor:default;">Wilayah tidak ditemukan.</li>';
            return;
          }

          results.forEach((res) => {
            const li = document.createElement("li");
            li.innerHTML = `<b>${res.n}</b> <span style="font-size:11px; color:#777">(${res.type})</span>`;
            li.onclick = () => selectAdminRegion(res);
            list.appendChild(li);
          });
        }

        function selectAdminRegion(data) {
          // Create buffered polygon using Turf.js (mock geometry)
          const center = [data.lon, data.lat];
          const point = turf.point(center);
          const radius = data.type === "Kabupaten" ? 10 : data.type === "Kecamatan" ? 3 : 1.5;
          const buffered = turf.buffer(point, radius, { units: "kilometers" });

          // Set as active filter polygon (V6.4 uses currentFilterPoly)
          try {
            currentFilterPoly = buffered;
          } catch (e) {
            APP_STATE.filterPolygon = buffered;
          }

          // Visualize on map
          try {
            adminBoundaryLayer.clearLayers();
            const polyLayer = L.geoJSON(buffered, { style: { color: "#e74c3c", fillOpacity: 0.1, weight: 2, dashArray: "5, 5" } }).addTo(adminBoundaryLayer);
            map.fitBounds(polyLayer.getBounds());
          } catch (e) {}

          // Update UI
          const fnEl = document.getElementById("filterName");
          if (fnEl) fnEl.innerText = `${data.n} (${data.type})`;
          const afi = document.getElementById("activeFilterInfo");
          if (afi) afi.style.display = "block";
          document.getElementById("admin_results").style.display = "none";

          // Refresh active layers and run analysis
          try {
            reloadAllActiveLayers();
          } catch (e) {}
          try {
            // generate chart summary if available
            if (typeof generateAdminAnalysis === 'function') generateAdminAnalysis();
          } catch (e) {}
          try {
            if (typeof calculateStatsInPolygon === 'function') calculateStatsInPolygon();
          } catch (e) {}
        }
    </script>
  </body>
</html>
